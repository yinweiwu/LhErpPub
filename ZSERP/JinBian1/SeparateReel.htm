<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>分卷</title>
    <link href="/Base/JS/easyui/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="/Base/JS/easyui/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="/Base/JS/easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/Base/JS/easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/Base/JS/easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="/Base/JS/json2.js" type="text/javascript"></script>
    <script src="/Base/JS/datagridExtend.js" type="text/javascript"></script>
    <script src="/Base/JS/DataInterface.js" type="text/javascript"></script>
    <script id="clientEventHandlersJS" language="javascript">
        //重写mscomm控件的唯一事件处理代码
        var orText = "";
        var fLastQty = 0.00;
        function MSComm1_OnComm() {
            var len = 0;
            //window.alert("happy");  
            if (MSComm1.CommEvent == 1)//如果是发送事件   
            {
                window.alert("发送成功！"); //这句正常，说明发送成功了   
            }
            else if (MSComm1.CommEvent == 2)//如果是接收事件   
            {
                if (orText.length < 20) {
                    orText += MSComm1.Input;
                }
                else {
                    var arr = orText.split("M");
                    try {
                        var sTheWeightFull = arr[1];
                        $("#Text5").numberbox("setValue", sTheWeightFull);
                        fLastQty = sTheWeightFull;
                        /*var index = sTheWeightFull.indexOf("kg");
                        if (index > -1) {
                        var sWeight = sTheWeightFull.substr(0, index);
                        if (!isNaN(parseFloat(sWeight))) {
                        var fWeight = parseFloat(sWeight);
                        if (fWeight != fLastWeight) {
                        $("#txbWeight").numberbox("setValue", fWeight);
                        //$('Textarea1').value = fWeight;
                        fLastWeight = fWeight;
                        }
                        }
                        }*/
                    }
                    catch (e) {

                    }
                    orText = "";
                }
            }
            return false;
        }   
    </script>
    <script language="javascript" for="MSComm1" event="OnComm">   
  <!--
  // MSComm1控件每遇到OnComm事件就调用MSComm1_OnComm()函数
            MSComm1_OnComm()
   //-->   
    </script>
    <script language="vbscript" type="text/vbscript" src="mscomm32/VBScript.vbs"></script>
    <script src="/Base/JS/JSCookie.js" type="text/javascript"></script>
    <script language="javascript" type="text/javascript">
        var userid = "";
        var btnFlaws = [];
        var scoreBs = 50;
        var iSelectRecNo = 0;
        $.ajax({
            url: "/ashx/LoginHandler.ashx",
            type: "post",
            async: false,
            cache: false,
            data: { otype: "getcurtuserid" },
            success: function (data) {
                userid = data;
            },
            error: function (data) {
                alert("获取当前用户失败，无法操作！");
            }
        });
        var isPortOpen = false;
        $(function () {
            if (userid != "master" && userid != "8888") {
                $("#btnSetPort").hide();
            }
            $.messager.progress({ title: "正在连接验布机，请稍候..." });
            setReadOnly();
            $("#txbNowDate").datebox("setValue", getNowDate());
            $("#tableSdOrderDD").datagrid({
                fit: true,
                //border: false,
                remoteSort: false,
                //loadFilter: pagerFilter,
                rowStyler: function (index, row) {
                    return "height:30px;";
                },
                columns: [
                    [
                    { title: "订单号", field: "sOrderNo", width: 100, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },

                    { title: "签订日期", field: "dDate1", width: 100, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "缸号", field: "sVatNo", width: 80, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                     { title: "产品", field: "sCodeFull", width: 120, align: "center", styler: function () {
                         return "font-size:16px;";
                     }
                     },
                    { title: "颜色", field: "sColorFull", width: 120, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "已验<br />卷数", field: "iCurtPartReelCount", width: 60, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "当前<br />卷号", field: "sCurtPartReelNo", width: 60, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "预计<br />卷数", field: "iPlanPartReelCount", width: 60, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "卷号<br />生成规则", field: "sReelNoBuildName", width: 80, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "卷号<br />前缀", field: "sReelNoPre", width: 60, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "卷号<br />流水规则", field: "sReelNoFlag", width: 80, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "幅宽", field: "fProductWidth", width: 60, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "克重", field: "fProductWeight", width: 60, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "米长", field: "fQty", width: 60, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { title: "客户简称", field: "sCustFull", width: 140, align: "center", styler: function () {
                        return "font-size:16px;";
                    }
                    },
                    { field: "iRecNo", hidden: true }
                    ]
                ],
                singleSelect: true,
                onDblClickRow: function () {
                    selectSDOrderDD();
                }
            }
            )
            LoadSDOrderDD();
            var sqlObjBtn = {
                TableName: "bscDataClass",
                Fields: "sClassID,sClassName",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "stype",
                        ComOprt: "=",
                        Value: "'flaw'"
                    }
                ],
                Sorts: [
                    {
                        SortName: "sClassID",
                        SortOrder: "asc"
                    }
                ]
            }
            var resultBtn = SqlGetData(sqlObjBtn);
            btnFlaws = resultBtn;
            for (var i = 0; i < resultBtn.length; i++) {
                var btn = $("<input type='button' id='btnFlaw_" + i + "' value='" + resultBtn[i].sClassName + "' class='btnBiggerFix' onclick='openFlawWindow(this)' />");
                $("#tdBtn" + i).append(btn);
            }

            var sqlObjMachine = {
                TableName: "bscDataMachine",
                Fields: "sMachineCode",
                SelectAll: "True",
                Sorts: [
                    {
                        SortName: "sMachineCode",
                        SortOrder: "asc"
                    }
                ]
            }
            var resultMachine = SqlGetData(sqlObjMachine);
            $("#txbMachine").combobox("loadData", resultMachine);

            var sqlObjCheckPerson = {
                TableName: "bscDataPerson",
                Fields: "sCode,sName",
                SelectAll: "True",
                Sorts: [
                    {
                        SortName: "sCode",
                        SortOrder: "asc"
                    }
                ]
            }
            var resultCheckPerson = SqlGetData(sqlObjCheckPerson);
            $("#txbCheckPerson").combobox("loadData", resultCheckPerson);

            $("#tabCdRec").datagrid({
                fit: true,
                remoteSort: false,
                rowStyler: function (index, row) {
                    if (row.iAbandon == "1") {
                        return "height:30px;color:red";
                    }
                    else {
                        return "height:30px;";
                    }
                },
                columns: [
                    [
                    { title: "序号", field: "iSerial", width: 40, align: "center", styler: function () {
                        return "font-size:14px;";
                    }
                    },
                    { title: "原因", field: "sReason", width: 80, align: "center", styler: function () {
                        return "font-size:14px;";
                    }
                    },
                    { title: "位置", field: "fPostion", width: 80, align: "center", styler: function () {
                        return "font-size:14px;";
                    }
                    },
                    { field: "iRecNo", hidden: true }
                    ]
                ],
                singleSelect: true,
                onDblClickRow: function () {
                    selectSDOrderDD();
                }
            }
            )
            var sqlObjCheckScroeBs = {
                TableName: "bscDataListD",
                Fields: "top 1 sName",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sClassID",
                        ComOprt: "=",
                        Value: "'scoreBS'"
                    }
                ]
            }
            var resultCheckScroeBs = SqlGetData(sqlObjCheckScroeBs);
            if (resultCheckScroeBs.length > 0) {
                scoreBs = parseFloat(resultCheckScroeBs[0].sName);
            }


            var objStr = "<object classid='clsid:648A5600-2C6E-101B-82B6-000000000014' id='MSComm1' codebase='MSCOMM32.OCX' type='application/x-oleobject' style='left: 54px; top: 14px'>";
            var portCookie = getCookie("mscomm32_port");
            if (portCookie != null) {
                objStr += "<param name='CommPort' value='" + portCookie + "'>";
            }
            else {
                objStr += "<param name='CommPort value='4'>";
            }
            objStr += "<param name='DTREnable' value='1'><param name='Handshaking' value='0'><param name='InBufferSize' value='1024'><param name='InputLen' value='0'><param name='NullDiscard' value='0'><param name='OutBufferSize' value='512'>" +
        "<param name='ParityReplace' value='?'><param name='RThreshold' value='1'><param name='RTSEnable' value='1'><param name='SThreshold' value='2'><param name='EOFEnable' value='0'><param name='InputMode' value='0'>" +
        "<param name='DataBits' value='8'><param name='StopBits' value='1'><param name='BaudRate' value='9600'><param name='Settings' value='9600,N,8,1'>";
            var object = $(objStr);
            $("body").append(object);
            setTimeout(function () {
                try {
                    OpenPort();
                    $.messager.progress("close");
                }
                catch (e) {
                    alert("验布机连接失败！");
                    $.messager.progress("close");
                }
            }, 1000);
            setTimeout(function () {
                if (isPortOpen == false) {
                    alert("验布机连接失败！");
                }
            }, 2000);
        })

        function setReadOnly() {
            //$($("#Text1").textbox("textbox")).addClass("txbreadonly");
            $($("#Text2").textbox("textbox")).addClass("txbreadonly");
            $($("#Text3").textbox("textbox")).addClass("txbreadonly");
            $($("#Text4").textbox("textbox")).addClass("txbred");
            $($("#Text5").textbox("textbox")).addClass("txbred");
            $($("#Text8").textbox("textbox")).addClass("txbreadonly");
            $($("#Text7").textbox("textbox")).addClass("txbreadonly");

            $($("#Text9").textbox("textbox")).addClass("txbreadonly");
            $($("#Text10").textbox("textbox")).addClass("txbreadonly");
            $($("#txbNowDate").datebox("textbox")).addClass("txbreadonly");
            //$($("#Text13").textbox("textbox")).addClass("txbreadonly");
            $($("#Text14").textbox("textbox")).addClass("txbreadonly");
        }

        function LoadSDOrderDD() {
            var filters = [
                {
                    Field: " ",
                    ComOprt: "not exists",
                    Value: "(select 1 from SDOrderDDVatNo as b where isnull(b.dEndTime,'2299-12-31')<>'2299-12-31' and a.iSDOrderMRecNo=b.iSDOrderMRecNo and a.iSDOrderDRecNo=b.iSDOrderDRecNo and a.sVatNo=b.sVatNo)"
                }
            ];
            var sOrderNo = $("#txbSearchOrderNo").textbox("getValue");
            var sCode = $("#txbSearchCode").textbox("getValue");
            var sVatNo = $("#txbSearchVatNo").textbox("getValue");
            if (sOrderNo != "") {
                if (filters.length > 0) {
                    filters[filters.length - 1].LinkOprt = "and";
                }
                filters.push(
                    {
                        Field: "sOrderNo",
                        ComOprt: "like",
                        Value: "'%" + sOrderNo + "%'"
                    }
                )
            }
            if (sCode != "") {
                if (filters.length > 0) {
                    filters[filters.length - 1].LinkOprt = "and";
                }
                filters.push(
                    {
                        Field: "sCodeFull",
                        ComOprt: "like",
                        Value: "'%" + sCode + "%'"
                    }
                )
            }
            if (sVatNo != "") {
                if (filters.length > 0) {
                    filters[filters.length - 1].LinkOprt = "and";
                }
                filters.push(
                    {
                        Field: "sVatNo",
                        ComOprt: "like",
                        Value: "'%" + sVatNo + "%'"
                    }
                )
            }
            var sqlObj = {
                TableName: "vwSDOrderDDMD as a",
                Fields: "*",
                SelectAll: "True",
                Filters: filters,
                Sorts: [
                        {
                            SortName: "dDate1",
                            SortOrder: "asc"
                        },
                        {
                            SortName: "sOrderNo",
                            SortOrder: "asc"
                        },
                        {
                            SortName: "iRecNo",
                            SortOrder: "asc"
                        },
                         {
                             SortName: "iSerial",
                             SortOrder: "asc"
                         }
                    ]
            }
            var result = SqlGetData(sqlObj);
            $("#tableSdOrderDD").datagrid("loadData", result);
        }

        function openOrderWindow() {
            LoadSDOrderDD();
            $("#divSdOrderDD").window("open");
            var allRows = $("#tableSdOrderDD").datagrid("getRows");
            for (var i = 0; i < allRows.length; i++) {
                if (iSelectRecNo == allRows[i].iRecNo) {
                    $("#tableSdOrderDD").datagrid("selectRow", i);
                    break;
                }
            }
        }

        function selectSDOrderDD() {
            var selectRow = $("#tableSdOrderDD").datagrid("getSelected");
            if (selectRow) {
                iSelectRecNo = selectRow.iRecNo;
                $("#form1").form("load", selectRow);
                var sReelNoFlag = selectRow.sReelNoFlag == null || selectRow.sReelNoFlag == undefined || selectRow.sReelNoFlag == "" ? "00" : selectRow.sReelNoFlag;
                var theReelNo = "";
                var sReelNoPre = selectRow.sReelNoPre == null || selectRow.sReelNoPre == undefined ? "" : selectRow.sReelNoPre;
                if (selectRow.iCurtPartReelCount == 0 || selectRow.iCurtPartReelCount == null || selectRow.iCurtPartReelCount == undefined || selectRow.iCurtPartReelCount == 0) {
                    theReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + 1).toString(), sReelNoFlag.length);
                }
                else {
                    var nextPartReelCount = parseInt(selectRow.iCurtPartReelCount) + 1;
                    theReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + nextPartReelCount).toString(), sReelNoFlag.length);
                }
                $("#Text9").textbox("setValue", theReelNo);
                $("#txaRemark").val(selectRow.sCustomerAsk);
                $("#txbOrderNo").textbox("setValue", selectRow.sOrderNo);
                //加载疵点
                //                var sqlObjFlaw = {
                //                    TableName: "SDOrderDDFlawD",
                //                    Fields: "*",
                //                    SelectAll: "True",
                //                    Filters: [
                //                        {
                //                            Field: "iMainRecNo",
                //                            ComOprt: "=",
                //                            Value: "'" + selectRow.iRecNo + "'"
                //                        }
                //                    ],
                //                    Sorts: [
                //                        {
                //                            SortName: "iSerial",
                //                            SortOrder: "asc"
                //                        }
                //                    ]
                //                }
                //                var resultFlaw = SqlGetData(sqlObjFlaw);
                //                $("#tabCdRec").datagrid("loadData", resultFlaw);

            }
            else {
                alert("请选择一个订单");
            }
            $("#divSdOrderDD").window("close");
        }

        function jsleft(lefts, leftn) {
            var sl = lefts;
            sl = sl.substring(0, leftn);
            return sl;
        }
        function jsright(rights, rightn) {
            var sr = rights;
            sr = sr.substring(sr.length - rightn, sr.length);
            return sr;
        }
        function getNowDate() {
            var nowdate = new Date();
            var year = nowdate.getFullYear();
            var month = nowdate.getMonth();
            var date = nowdate.getDate();
            var monthstr = (month + 1).toString();
            var datestr = date.toString();
            if (month < 9) {
                monthstr = '0' + (month + 1).toString();
            }
            if (date < 10) {
                datestr = '0' + date.toString();
            }
            return year.toString() + "-" + monthstr + "-" + datestr;
        }
        function openFlawWindow(obj) {
            //var selectMainRow = $("#tableSdOrderDD").datagrid("getSelected");
            if (iSelectRecNo == 0) {
                alert("请先选择订单！");
                return false;
            }
            var sCheckPersonID = $("#txbCheckPerson").combobox("getValue");
            if (sCheckPersonID == "" || sCheckPersonID == null || sCheckPersonID == undefined) {
                alert("请先选择检验员！");
                return false;
            }
            $("#form2").form("clear");
            $("#divFlaw").window("open");
            var btnID = obj.id;
            var index = btnID.indexOf("_");
            var intID = parseInt(btnID.substr(index + 1, btnID.length - index - 1));
            var theFlaw = btnFlaws[intID];
            $("#txbFlawReason").textbox("setValue", theFlaw.sClassID + '-' + theFlaw.sClassName);
            $("#txbFlawPosition").numberbox("setValue", $("#Text5").numberbox("getValue"));
            var iNextRecNo = getChildID("SDOrderDDFlawD");
            $("#txbSDOrderDDFlawDRecNo").val(iNextRecNo);
        }
        function flawConfirm() {
            if ($("#form2").form("validate")) {
                var sCheckPersonID = $("#txbCheckPerson").combobox("getValue");
                if (sCheckPersonID == "" || sCheckPersonID == null || sCheckPersonID == undefined) {
                    alert("请先选择检验员！");
                    return false;
                }
                //var selectMainRow = $("#tableSdOrderDD").datagrid("getSelected");
                if (iSelectRecNo > 0) {
                    var iRecNo = $("#txbSDOrderDDFlawDRecNo").val();
                    var iMainRecNo = iSelectRecNo;
                    var aRows = $("#tabCdRec").datagrid("getRows");
                    var iSerial = aRows.length + 1;
                    var sReason = $("#txbFlawReason").textbox("getValue");
                    var fPosition = $("#txbFlawPosition").numberbox("getValue");
                    var fScore = $("#txbFlawScroe").numberbox("getValue");
                    var fDeductQty = $("#txbFlawDeMeter").numberbox("getValue");
                    var jsonobj = {
                        StoreProName: "SpSDOrderDDVatNoDReelNoFlawDAdd",
                        StoreParms: [{
                            ParmName: "@iRecNo",
                            Value: iRecNo
                        },
                        {
                            ParmName: "@iSerial",
                            Value: iSerial
                        },
                        {
                            ParmName: "@sReason",
                            Value: sReason
                        },
                        {
                            ParmName: "@fPosition",
                            Value: fPosition
                        },
                        {
                            ParmName: "@fScore",
                            Value: fScore
                        },
                        {
                            ParmName: "@fDeductQty",
                            Value: fDeductQty
                        },
                        {
                            ParmName: "@sCheckPersonID",
                            Value: sCheckPersonID
                        }
                        ]
                    }
                    var result = SqlStoreProce(jsonobj);
                    if (result != "1") {
                        alert(result);
                    }
                    else {
                        var appRow = {
                            iRecNo: iRecNo,
                            iSerial: iSerial,
                            sReason: sReason,
                            fPostion: fPosition
                        }
                        $("#tabCdRec").datagrid("appendRow", appRow);
                        $("#divFlaw").window("close");
                    }
                }
                else {
                    alert("请先选择订单！");
                    return false;
                }
            }
        }
        function partQtyChange(newValue, oldValue) {
            var fDeductQty = $("#Text6").numberbox("getValue");
            var fRealQty = (isNaN(Number(newValue)) ? 0 : Number(newValue)) - (isNaN(Number(fDeductQty)) ? 0 : Number(fDeductQty));
            $("#Text7").numberbox("setValue", fRealQty);
        }
        function DeductQtyChange(newValue, oldValue) {
            var fPartQty = $("#Text5").numberbox("getValue");
            var fRealQty = (isNaN(Number(fPartQty)) ? 0 : Number(fPartQty)) - (isNaN(Number(newValue)) ? 0 : Number(newValue));
            $("#Text7").numberbox("setValue", fRealQty);
        }
        function flawDeMeterChange(newValue, oldValue) {
            var flawDeMeter = $("#txbFlawDeMeter").numberbox("getValue");
            var flawScroe = (isNaN(Number(flawDeMeter)) ? 0 : Number(flawDeMeter)) * scoreBs;
            $("#txbFlawScroe").numberbox("setValue", flawScroe);
        }
        function getChildID(tablename) {
            var jsonobj = {
                StoreProName: "SpGetIden",
                StoreParms: [{
                    ParmName: "@sTableName",
                    Value: tablename
                }]
            }
            var result = SqlStoreProce(jsonobj);
            if (result && result.length > 0 && result != "-1") {
                return result;
            }
            else {
                return "-1";
            }
        }
        //type=1删除,2作废,3清空
        function deleteOrAbandonOrClear(type) {
            if (type == 1 || type == 2) {
                var message = type == 1 ? "删除" : "作废";
                var selectRow = $("#tabCdRec").datagrid("getSelected");
                if (selectRow) {
                    $.messager.confirm("您确定吗？", "您确定要" + message + "所选行吗？", function (r) {
                        if (r) {
                            var jsonobj = {
                                StoreProName: "SpSDOrderDDVatNoDReelNoFlawDDeleteOrAbandon",
                                StoreParms: [{
                                    ParmName: "@iRecNo",
                                    Value: selectRow.iRecNo
                                },
                                {
                                    ParmName: "@sRecNoStr",
                                    Value: ""
                                },
                                {
                                    ParmName: "@iType",
                                    Value: type
                                }
                            ]
                            }
                            var result = SqlStoreProce(jsonobj);
                            if (result != "1") {
                                alert(result);
                            }
                            else {
                                if (type == 1) {
                                    $("#tabCdRec").datagrid("deleteRow", $("#tabCdRec").datagrid("getRowIndex", selectRow));
                                }
                                else {
                                    $("#tabCdRec").datagrid("updateRow", { index: $("#tabCdRec").datagrid("getRowIndex", selectRow), row: { iAbandon: 1} });
                                }
                            }
                        }
                    })
                }
                else {
                    alert("请选择一行");
                }
            }
            else {
                var allRows = $("#tabCdRec").datagrid("getRows");
                if (allRows.length > 0) {
                    var iMainRecNo = iSelectRecNo;
                    $.messager.confirm("您确定吗？", "您确定要清空所有疵点吗？清空后不可恢复", function (r) {
                        if (r) {
                            var iRecNoStr = "";
                            for (var i = 0; i < allRows.length; i++) {
                                iRecNoStr += allRows[i].iRecNo + ",";
                            }
                            if (iRecNoStr != "") {
                                iRecNoStr = iRecNoStr.substr(0, iRecNoStr.length - 1);
                            }
                            var jsonobj = {
                                StoreProName: "SpSDOrderDDVatNoDReelNoFlawDDeleteOrAbandon",
                                StoreParms: [{
                                    ParmName: "@iRecNo",
                                    Value: 0
                                },
                            {
                                ParmName: "@sRecNoStr",
                                Value: iRecNoStr
                            },
                            {
                                ParmName: "@iType",
                                Value: type
                            }
                            ]
                            }
                            var result = SqlStoreProce(jsonobj);
                            if (result != "1") {
                                alert(result);
                            }
                            else {
                                $("#tabCdRec").datagrid("loadData", []);
                            }
                        }
                    })
                }
            }
        }

        function saveMs() {

        }
        function saveAndPrint() {
            if ($("#form1").form("validate")) {
                //var selectRow = $("#tableSdOrderDD").datagrid("getSelected");
                //if (selectRow) {
                if (iSelectRecNo > 0) {
                    var iRecNo = iSelectRecNo;
                    var fPartQty = $("#Text5").numberbox("getValue");
                    var fDeductQty = $("#Text6").numberbox("getValue");
                    fDeductQty = fDeductQty == "" || fDeductQty == null || fDeductQty == undefined ? 0 : fDeductQty;
                    var fRealQty = $("#Text7").numberbox("getValue");
                    var sCheckPersonID = $("#txbCheckPerson").textbox("getValue");
                    var sMachineID = $("#txbMachine").textbox("getValue");
                    var fWeight = $("#Text4").numberbox("getValue");
                    var sUserID = userid;
                    var allRows1 = $("#tabCdRec").datagrid("getRows");
                    var iRecNoStr = "";
                    for (var i = 0; i < allRows1.length; i++) {
                        iRecNoStr += allRows1[i].iRecNo + ",";
                    }
                    if (iRecNoStr != "") {
                        iRecNoStr = iRecNoStr.substr(0, iRecNoStr.length - 1);
                    }
                    var jsonobj = {
                        StoreProName: "SpVatNoBulidReelNo",
                        StoreParms: [{
                            ParmName: "@iSDOrderDDRecNo",
                            Value: iRecNo
                        },
                        {
                            ParmName: "@fPartQty",
                            Value: fPartQty
                        },
                        {
                            ParmName: "@fDeductQty",
                            Value: fDeductQty
                        },
                        {
                            ParmName: "@fRealQty",
                            Value: fRealQty
                        },
                        {
                            ParmName: "@sCheckPersonID",
                            Value: sCheckPersonID
                        },
                        {
                            ParmName: "@sMachineID",
                            Value: sMachineID
                        },
                        {
                            ParmName: "@fWeight",
                            Value: fWeight
                        },
                        {
                            ParmName: "@sUserID",
                            Value: sUserID
                        },
                        {
                            ParmName: "@sRecNoStr",
                            Value: iRecNoStr
                        }
                        ]
                    }
                    var result = SqlStoreProce(jsonobj);
                    var resultArr = result.split(":");
                    var resultFirst = resultArr[0];
                    var resultMessage = resultArr[1];
                    if (resultFirst == "1") {
                        $.messager.show({
                            title: '保存成功',
                            msg: '保存成功，正在打印...',
                            showType: null,
                            style: {
                                right: '',
                                top: document.body.scrollTop + document.documentElement.scrollTop,
                                bottom: ''
                            },
                            timeout: 2000
                        });
                        $("#tabCdRec").datagrid("loadData", []);
                        var sReelNo = resultArr[2];
                        var theSelectRow;
                        var allRowsOrder = $("#tableSdOrderDD").datagrid("getRows");
                        for (var i = 0; i < allRowsOrder.length; i++) {
                            if (iSelectRecNo == allRowsOrder[i].iRecNo) {
                                theSelectRow = allRowsOrder[i];
                                break;
                            }
                        }
                        var sReelNoFlag = theSelectRow.sReelNoFlag == null || theSelectRow.sReelNoFlag == undefined || theSelectRow.sReelNoFlag == "" ? "00" : theSelectRow.sReelNoFlag;
                        var nextPartReelCount = parseInt(jsright(sReelNo, sReelNoFlag.length)) + 1;
                        var theReelNo = "";
                        var sReelNoPre = theSelectRow.sReelNoPre == null || theSelectRow.sReelNoPre == undefined ? "" : theSelectRow.sReelNoPre;
                        //var nextPartReelCount = parseInt(selectRow.iCurtPartReelCount) + 1;
                        sReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + nextPartReelCount).toString(), sReelNoFlag.length);

                        $("#Text9").textbox("setValue", sReelNo);
                        var url = "/Base/PbPage.aspx?otype=print&iformid=20023&irecno=" + selectRow.iPrintMoudleRecNo + "&key=" + resultMessage + "&r=" + Math.random();
                        $("#ifrpb").attr("src", "");
                        $("#ifrpb").attr("src", url);
                    }
                    else {
                        alert(resultMessage);
                    }
                }
                else {
                    alert("请先选择订单！");
                    return false;
                }
            }
        }
        function finishPart() {
            //var selectRow = $("#tableSdOrderDD").datagrid("getSelected");
            if (iSelectRecNo > 0) {
                $.messager.confirm("您确定结束验布吗？", "您确定结束验布吗?", function (r) {
                    if (r) {
                        var jsonobj = {
                            StoreProName: "SpVatNoPartFinish",
                            StoreParms: [{
                                ParmName: "@iSDOrderDDRecNo",
                                Value: iSelectRecNo
                            }
                        ]
                        }
                        var result = SqlStoreProce(jsonobj);
                        switch (result) {
                            case "0":
                                {
                                    alert("此缸号布已经结束");
                                } break;
                            case "1":
                                {
                                    MessageShow("操作成功", "验布结束成功");
                                    $("#form1").form("clear");
                                } break;
                            case "2":
                                {
                                    MessageShow("操作成功", "验布结束成功，<span style='color:red;'>有重复卷号，请到<重号补打>中重新打印</span>");
                                } break;
                            case "3":
                                {
                                    alert("操作失败，发生未知错误");
                                } break;
                        }
                    }
                })
            }
            else {
                alert("请先选择订单！");
                return false;
            }
        }
        function MessageShow(title, message) {
            $.messager.show({
                title: title,
                msg: message,
                showType: 'slide',
                style: {
                    right: '',
                    top: document.body.scrollTop + document.documentElement.scrollTop,
                    bottom: ''
                },
                timeout: 2000
            });
        }

        function OpenPort() {
            if (MSComm1.PortOpen == false) {
                MSComm1.PortOpen = true;
            }
            else {
                window.alert("已经开始接收数据!");
            }
            isPortOpen = true;
        }
        function CloseOrOpenPort(obj) {            
            if (MSComm1.PortOpen == true) {
                MSComm1.PortOpen = false;
                isPortOpen = false;
                $("#btnOpenOrClose").val("连接验布机");
                $("#btnSaveMs").val("开始");
            }
            else {
                MSComm1.PortOpen = true;
                isPortOpen = true;
                $("#btnOpenOrClose").val("断开验布机");
                $("#btnSaveMs").val("暂停");
            }
        }
        function openSetPort() {
            var portCookie = getCookie("mscomm32_port");
            if (portCookie != null) {
                $("#txbCommPort").numberspinner("setValue", portCookie);
            }
            $("#divCommPort").dialog("open");
        }
        function savePort() {
            var port = $("#txbCommPort").numberspinner("getValue");
            if (port == null || port == undefined || port == "") {
                alert("端口号不能为空");
                return;
            }
            if (MSComm1.PortOpen == true) {
                MSComm1.PortOpen = false;
            }
            setCookie("mscomm32_port", port, "d3650");
            window.location.reload();
            $("#divCommPort").dialog("close");
        }
        function portCancel() {
            $("#divCommPort").dialog("close");
        }
    </script>
    <style type="text/css">
        body
        {
            font-family: 微软雅黑;
            font-size: 18px;
        }
        .centerTableH
        {
            border-spacing: 2px;
        }
        .centerTableH tr td
        {
            font-size: 18px;
            font-weight: bold;
            font-family: 微软雅黑;
        }
        .centerTable
        {
            border-spacing: 5px;
        }
        .centerTable tr td
        {
            font-size: 20px;
            font-weight: bold;
            font-family: 微软雅黑;
        }
        .textbox .textbox-text
        {
            font-size: 16px;
            color: Blue;
            font-weight: bold;
        }
        .txbreadonly
        {
            background-color: #ffffaa;
            border: none;
            border-bottom: solid 1px #95b8e7; /*height: 40px; border-radius: 5px;*/
        }
        .txbred
        {
            color: Red;
            border: none;
            border-bottom: solid 1px #95b8e7; /*height: 40px; border-radius: 5px;*/
        }
        /*input[type="button"]
        {
            height: 49px;
            font-size: 18px;
            font-family: 微软雅黑;
            font-weight: bold;
            width: 100px;
        }*/
        .btnBigger
        {
            height: 35px;
            font-size: 14px;
            font-family: 微软雅黑;
            font-weight: bold;
        }
        .btnBiggerFix
        {
            height: 35px;
            font-size: 14px;
            font-family: 微软雅黑;
            font-weight: bold;
            width: 75px;
        }
    </style>
</head>
<body class="easyui-layout" data-options="border:false">
    <div data-options="region:'north',border:false" style="height: 60px; padding-left: 20px;">
        <table>
            <tr>
                <td style="font-size: 20px;">
                    订单号
                </td>
                <td>
                    <input id="txbOrderNo" class="easyui-textbox" style="width: 130px; height: 35px;"
                        type="text" />
                </td>
                <td>
                    <input id="Button1" type="button" value="订单选择" style="height: 35px; width: 100px;
                        font-size: 18px; font-weight: bold;" onclick="openOrderWindow()" />
                </td>
                <td style="width: 30px;">
                </td>
                <td>
                    <h1 style="font-family: 微软雅黑; background-color: #eee; ">
                        验布打卷</h1>
                </td>
                <td style="width:100px;">
                    
                </td>
                <td>
                    <input id="btnOpenOrClose" type="button" style="width: 120px; height: 30px; font-size: 20px;"
                        value="断开验布机" onclick="CloseOrOpenPort()" />
                    <input id="btnSetPort" type="button" style="width: 120px; height: 30px; font-size: 20px;"
                        value="设置端口号" onclick="openSetPort();" />
                </td>
            </tr>
        </table>
    </div>
    <div data-options="region:'west',title:'标签信息',split:true,collapsible:false" style="width: 470px;">
        <form id="form1">
        <table class="centerTable">
            <!--<tr>
                <td>
                    关联条码
                </td>
                <td colspan="5">
                    <input id="Text1" type="text" class="easyui-textbox" data-options="readonly:true"
                        style="width: 325px; height: 40px;" />
                </td>
            </tr>-->
            <tr>
                <td>
                    产品
                </td>
                <td colspan="5">
                    <input id="Text2" type="text" name="sCodeFull" class="easyui-textbox" data-options="readonly:true"
                        style="width: 380px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td>
                    客户
                </td>
                <td colspan="3">
                    <input id="Text3" type="text" name="sCustFull" class="easyui-textbox" data-options="readonly:true"
                        style="width: 211px; height: 30px;" />
                </td>
                <td>
                    重量
                </td>
                <td>
                    <input id="Text4" type="text" name="fWeight" class="easyui-numberbox" data-options="precision:2,required:true"
                        style="width: 71px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td>
                    米数
                </td>
                <td>
                    <input id="Text5" type="text" name="fPartQty" class="easyui-numberbox" data-options="precision:2,required:true,onChange:partQtyChange"
                        style="width: 97px; height: 30px;" />
                </td>
                <td>
                    扣
                </td>
                <td>
                    <input id="Text6" type="text" name="fDeductQty" class="easyui-numberbox" data-options="precision:2,onChange:DeductQtyChange"
                        style="width: 60px; height: 30px;" />
                </td>
                <td>
                    实际
                </td>
                <td>
                    <input id="Text7" type="text" name="fRealQty" class="easyui-numberbox" data-options="precision:2,readonly:true,required:true"
                        style="width: 72px; height: 30px; color: Red;" />
                </td>
            </tr>
            <tr>
                <td>
                    颜色
                </td>
                <td colspan="2">
                    <input id="Text8" type="text" name="sColorFull" class="easyui-textbox" data-options="readonly:true"
                        style="width: 150px; height: 30px;" />
                </td>
                <td>
                    卷号
                </td>
                <td colspan="2">
                    <input id="Text9" type="text" name="sCurtPartReelNo" class="easyui-textbox" data-options="readonly:true"
                        style="width: 120px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td>
                    缸号
                </td>
                <td colspan="2">
                    <input id="Text10" type="text" name="sVatNo" class="easyui-textbox" data-options="readonly:true"
                        style="width: 120px; height: 30px;" />
                </td>
                <td>
                    日期
                </td>
                <td colspan="2">
                    <input id="txbNowDate" type="text" name="dNowDate" class="easyui-datebox" data-options="readonly:true"
                        style="width: 120px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td>
                    检验
                </td>
                <td colspan="2">
                    <input id="txbCheckPerson" type="text" name="sCheckPersonID" class="easyui-combobox"
                        data-options="valueField:'sCode',textField:'sName',required:true" style="width: 120px;
                        height: 30px;" />
                </td>
                <td>
                    订单号
                </td>
                <td colspan="2">
                    <input id="Text14" type="text" name="sOrderNo" class="easyui-textbox" data-options="readonly:true"
                        style="width: 120px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td>
                    机台
                </td>
                <td colspan="2">
                    <input id="txbMachine" type="text" name="sMachineID" class="easyui-combobox" data-options="valueField:'sMachineCode',textField:'sMachineCode',required:true"
                        style="width: 120px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td style="display: none;">
                    打印数量
                </td>
                <td style="display: none;">
                    <input id="Text16" type="text" name="printCount" class="easyui-numberbox" style="width: 120px;
                        height: 40px;" />
                    <iframe id="ifrpb" name="ifrpb" width="0" height="0"></iframe>
                </td>
                <td colspan="6" style="text-align: center;">
                    <input id="btnFinish" type="button" value="缸号验布完成" class="btnBigger" onclick="finishPart()" />&nbsp;&nbsp;
                    <input id="btnSaveMs" type="button" value="暂停" class="btnBigger" onclick="CloseOrOpenPort(this)" />&nbsp;&nbsp;
                    <input id="btnSavePrint" type="button" value="保存打印" class="btnBigger" onclick="saveAndPrint()" />
                </td>
            </tr>
        </table>
        </form>
    </div>
    <div data-options="region:'center',border:false">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div data-options="region:'west'" style="width: 200px;">
                <div class="easyui-layout" data-options="fit:true,border:false">
                    <div data-options="region:'center',border:false,split:true">
                        <div class="easyui-tabs" data-options="fit:true,border:false">
                            <div title="疵点记录" data-options="border:false">
                                <table id="tabCdRec">
                                </table>
                            </div>
                        </div>
                    </div>
                    <div data-options="region:'south',border:false" style="height: 40px;">
                        <table>
                            <tr>
                                <td>
                                    <input id="btnRClear" type="button" class="btnBigger" onclick="deleteOrAbandonOrClear(3)"
                                        value="清空" />
                                </td>
                                <td>
                                    <input id="btnRDelete" type="button" class="btnBigger" onclick="deleteOrAbandonOrClear(1)"
                                        value="删除" />
                                </td>
                                <td>
                                    <input id="btnRAband" type="button" class="btnBigger" onclick="deleteOrAbandonOrClear(2)"
                                        value="作废" />
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div data-options="region:'center',title:'添加疵点',collapsible:false,split:true">
                <table class="centerTable">
                    <tr>
                        <td id="tdBtn1">
                        </td>
                        <td id="tdBtn2">
                        </td>
                    </tr>
                    <tr>
                        <td id="tdBtn3">
                        </td>
                        <td id="tdBtn4">
                        </td>
                    </tr>
                    <tr>
                        <td id="tdBtn5">
                        </td>
                        <td id="tdBtn6">
                        </td>
                    </tr>
                    <tr>
                        <td id="tdBtn7">
                        </td>
                        <td id="tdBtn8">
                        </td>
                    </tr>
                    <tr>
                        <td id="tdBtn9">
                        </td>
                        <td id="tdBtn10">
                        </td>
                    </tr>
                    <tr>
                        <td id="tdBtn11">
                        </td>
                        <td id="tdBtn12">
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div data-options="region:'south',title:'订单备注信息',split:true,collapsible:false" style="height: 130px;">
        <textarea id="txaRemark" name="sCustomerAsk" style="width: 98%; height: 95%; background-color: #eee;"
            disabled="disabled">
            
        </textarea>
    </div>
    <div id="divSdOrderDD" class="easyui-window" title="选择订单" style="width: 800px; height: 500px;"
        data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div data-options="region:'north',border:false" style="height: 50px">
                <table class="centerTable">
                    <tr>
                        <td>
                            订单号
                        </td>
                        <td>
                            <input id="txbSearchOrderNo" type="text" class="easyui-textbox" style="width: 120px;
                                height: 35px;" />
                        </td>
                        <td>
                            产品
                        </td>
                        <td>
                            <input id="txbSearchCode" type="text" class="easyui-textbox" style="width: 120px;
                                height: 35px;" />
                        </td>
                        <td>
                            缸号
                        </td>
                        <td>
                            <input id="txbSearchVatNo" type="text" class="easyui-textbox" style="width: 120px;
                                height: 35px;" />
                        </td>
                        <td>
                            <input id="Button17" type="button" value="查询" onclick="LoadSDOrderDD()" style="width: 80px;
                                height: 35px;" />
                        </td>
                        <td>
                            <input id="Button18" type="button" value="确定选择" onclick="selectSDOrderDD()" style="width: 100px;
                                height: 35px;" />
                        </td>
                    </tr>
                </table>
            </div>
            <div data-options="region:'center',border:false">
                <table id="tableSdOrderDD">
                </table>
            </div>
        </div>
    </div>
    <div id="divFlaw" class="easyui-window" title="疵点登记" style="width: 300px; height: 250px;
        text-align: center;" data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true">
        <form id="form2" method="get">
        <table class="centerTable" style="text-align: center; margin: auto;">
            <tr>
                <td>
                    原因
                </td>
                <td>
                    <input id="txbFlawReason" class="easyui-textbox" data-options="readonly:true" type="text"
                        style="width: 150px; height: 30px;" />
                    <input id="txbSDOrderDDFlawDRecNo" name="iSDOrderDDFlawDRecNo" type="hidden" />
                </td>
            </tr>
            <tr>
                <td>
                    位置
                </td>
                <td>
                    <input id="txbFlawPosition" class="easyui-numberbox" data-options="readonly:true,precision:2"
                        type="text" style="width: 150px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td>
                    扣分
                </td>
                <td>
                    <input id="txbFlawScroe" class="easyui-numberbox" data-options="readonly:true,precision:2"
                        type="text" style="width: 150px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td>
                    扣米数
                </td>
                <td>
                    <input id="txbFlawDeMeter" class="easyui-numberbox" data-options="required:true,precision:2,onChange:flawDeMeterChange"
                        type="text" style="width: 150px; height: 30px;" />
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <input id="btnFlawClose" type="button" value="取消" class="btnBigger" onclick="$('#divFlaw').window('close');" />&nbsp;&nbsp;
                    <input id="btnFlawConfirm" type="button" value="确定" class="btnBigger" onclick="flawConfirm()" />
                </td>
            </tr>
        </table>
        </form>
    </div>
    <div id="divCommPort" class="easyui-dialog" style="text-align: center; padding-top: 10px;"
        data-options="top:50,closed:true,closable:true,title:'设置端口号',collapsible:false,minimizable:false,maximizable:false,modal:true,width:250,height:120,buttons:[{iconCls:'icon-save',text:'保存',handler:savePort},{iconCls:'icon-cancel',text:'取消',handler:portCancel}]">
        <table style="margin: auto;">
            <tr>
                <td>
                    端口号
                </td>
                <td>
                    <input id="txbCommPort" class="easyui-numberspinner" data-options="precision:0,required:true"
                        style="width: 100px;" type="text" />
                </td>
            </tr>
        </table>
    </div>
</body>
</html>
