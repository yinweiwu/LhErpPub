<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>分卷</title>
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link href="/Base/JS/easyui/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="/Base/JS/easyui/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="/Base/JS/easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/Base/JS/easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/Base/JS/easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="/Base/JS/json2.js" type="text/javascript"></script>
    <script src="/Base/JS/datagridExtend.js" type="text/javascript"></script>
    <script src="/Base/JS/DataInterface.js" type="text/javascript"></script>
    <script language="vbscript" type="text/vbscript" src="mscomm32/VBScript.vbs"></script>
    <script src="/Base/JS/JSCookie.js" type="text/javascript"></script>
    <script language="javascript" type="text/javascript">
        // 这是一只蛐蛐
        var userid = "";
        var btnFlaws = [];
        var scoreBs = 50;
        var isOutProduce = 0;
        var iSelectRecNo = 0;
        var theLastPartQty = 0.00;
        var iPrintMoudleRecNo = 100;
        var iPrintMoudleRecNo2 = 0;
        var iPrintMoudleRecNo3 = 0;
        var iPrintMoudleRecNo4 = 0;
        var iPrintMoudleRecNo5 = 0;
        var iSamplePrintMoudleRecNo = 0;
        var iPackPrintMoudleRecNo = 0;
        var iPrintCount = 1;
        var iPrintCount3 = 1;
        var iPrintCount4 = 1;
        var iPrintCount5 = 1;
        var iSamplePrintCount = 1;
        var iPackPrintCount = 1;
        var iLastSDOrderDDVatNoDReelNoRecNo = 0;
        var iLastBscDataMatRecNo = 0;
        var sUnitID = "M";
        var theLastNumTextboxID = null;
        var lastMatCode = undefined;
        var ReelNoRange = 5;
        var isSampleSave = false;
        var isBtnCleared = false;
        var sReCheckBarCode = "";
        var iNewBscDataMatRecNo = 0;
        var iNewProductWidth = 0;
        var iNewProductWeight = 0;

        function GetUrlParam(paraName) {
            var url = document.location.toString();
            var arrObj = url.split("?");

            if (arrObj.length > 1) {
                var arrPara = arrObj[1].split("&");
                var arr;

                for (var i = 0; i < arrPara.length; i++) {
                    arr = arrPara[i].split("=");

                    if (arr != null && arr[0] == paraName) {
                        return arr[1];
                    }
                }
                return "";
            }
            else {
                return "";
            }
        }

        $.ajax({
            url: "/ashx/LoginHandler.ashx",
            type: "post",
            async: false,
            cache: false,
            data: { otype: "getcurtuserid" },
            success: function (data) {
                userid = data;
            },
            error: function (data) {
                alert("获取当前用户失败，无法操作！");
            }
        });
        var isPortOpen = false;
        var isPortOpen2 = false;
        var machine = 1;
        //获取url中传值
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        }

        function showProductRemarkWindow() {
            $(".sProductRemarkSelect").prop("checked", false);
            var sProductRemarkID = $("#Text213").val();
            if (sProductRemarkID != "" && sProductRemarkID != null) {
                var sProductRemarkIDs = sProductRemarkID.split(",");
                for (var i = 0; i < sProductRemarkIDs.length; i++) { 
                    $("#divShowProductRemarkSelect input:checkbox[value='" + sProductRemarkIDs[i] + "']").prop('checked', 'true');
                }
            }
            $("#divShowProductRemark").window("open");
        }

        $(function () { 
            $("#ttAskDetail ul li:eq(0) a").css("line-height",'34px');
            $("#cutRemark").html("");
            $("#btnSamplePrint").prop("disabled", true);
            $("#btnWholeDefective").prop("disabled", true);
            machine = getQueryString("machine");
            // 选择班次
            var sqlObjWorkClass = {
                TableName: "BscDataListD",
                Fields: "sName",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sClassID",
                        ComOprt: "=",
                        Value: "'sWorkClass'"
                    }
                ]
            };
            var resultWorkClass = SqlGetData(sqlObjWorkClass);
            if (resultWorkClass.length > 0) {
                for (var i = 0; i < resultWorkClass.length; i++) {
                    $("#sWorkClassSelect").append("<label><input type='radio' name='sWorkClass' value='" + resultWorkClass[i].sName + "' />" + resultWorkClass[i].sName + "</label>");
                    $("#divWorkClassSelect").append("<button class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:140px; height:80px' onclick='setWorkClass(\"" + resultWorkClass[i].sName + "\")'>" + resultWorkClass[i].sName + "</button>");
                }
            }
            $("#divWorkClass").window("open");

            var sqlObjReelNoRange = {
                TableName: "BscDataListD",
                Fields: "sName",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sClassID",
                        ComOprt: "=",
                        Value: "'ReelNoRange'"
                    }
                ]
            }
            var resultReelNoRange = SqlGetData(sqlObjReelNoRange);
            if (resultReelNoRange.length > 0) {
                ReelNoRange = isNaN(Number(resultReelNoRange[0].sName)) ? 5 : Number(resultReelNoRange[0].sName);
            }
            var sqlObjPackPerson = {
                TableName: "BscDataPerson",
                Fields: "sCode,sName",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sJobRole",
                        ComOprt: "like",
                        Value: "'%包装工%'"
                    }
                ],
                Sorts: [
                    {
                        SortName: "sName",
                        SortOrder: "asc"
                    }
                ]
            };
            var resultPackPerson = SqlGetData(sqlObjPackPerson);
            if (resultPackPerson.length > 0) {
                var appendHTML = "";
                appendHTML += "<table><tbody><tr style='margin-top:20px;display:block;'>";
                for (var i = 0; i < resultPackPerson.length; i++) {
                    if (i % 3 == 0 && i != 0) {
                        appendHTML += "</tr><tr style='margin-top:20px;display:block;'>";
                    }
                    appendHTML += "<td><label style='margin-top:20px;margin-right:70px;margin-left:10px;'><input type='checkbox' class='sPackPersonsSelect' name='sPackPersonsSelect' value='" + resultPackPerson[i].sCode + "' />" + resultPackPerson[i].sName + "</label></td>";
                }
                appendHTML += "</tr></tbody></table>";

                $("#divShowPackPersonsSelect").append(appendHTML);
            }

            var sqlObjProductRemark = {
                TableName: "BscDataReelNoRemark",
                Fields: "*",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sClassID",
                        ComOprt: "=",
                        Value: "'0'"
                    }
                ]
            };
            var resultProductRemark = SqlGetData(sqlObjProductRemark);
            if (resultProductRemark.length > 0) {
                var appendHTML = "";
                appendHTML += "<table><tbody>";
                for (var i = 0; i < resultProductRemark.length; i++) {
                    appendHTML += "<tr style='margin-top:20px;display:block;'><td><label style='margin-top:20px;margin-right:70px;margin-left:10px;'><input type='checkbox' class='sProductRemarkSelect' name='sProductRemarkSelect' value='" + resultProductRemark[i].iRecNo + "' />" + resultProductRemark[i].sContent + "</label></td></tr>";
                
                }
                appendHTML += "</tbody></table>";

                $("#divShowProductRemarkSelect").append(appendHTML);
            }

            var sqlObjProductRemarkDefective = {
                TableName: "BscDataReelNoRemark",
                Fields: "*",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sClassID",
                        ComOprt: "=",
                        Value: "'1'"
                    }
                ]
            };
            var resultProductRemarkDefective = SqlGetData(sqlObjProductRemarkDefective);
            if (resultProductRemarkDefective.length > 0) {
                var appendHTML = "";
                appendHTML += "<table><tbody>";
                for (var i = 0; i < resultProductRemarkDefective.length; i++) {
                     
                    appendHTML += "<tr style='margin-top:20px;display:block;'><td><label style='margin-top:20px;margin-right:70px;margin-left:10px;'><input type='checkbox' class='sProductRemarkSelectDefective' name='sProductRemarkSelectDefective' value='" + resultProductRemarkDefective[i].iRecNo + "' />" + resultProductRemarkDefective[i].sContent + "</label></td></tr>";
                }
                appendHTML += "</tbody></table>";

                $("#divShowProductRemarkSelectDefective").append(appendHTML);
            }

            if (userid != "master" && userid != "8888") {
                var sqlObjUserRight = {
                    TableName: "BscDataPerson",
                    Fields: "1",
                    SelectAll: "True",
                    Filters: [
                        {
                            Field: "sJobRole",
                            ComOprt: "like",
                            Value: "'%打卷机长%'",
                            LinkOprt: "or"
                        },
                        {
                            Field: "sCode",
                            ComOprt: "=",
                            Value: "'" + userid + "'"
                        }
                    ]
                }
                var resultUserRight = SqlGetData(sqlObjUserRight);
                if (resultUserRight.length == 0) {
                    $("#btnSetPort").hide();
                }
            }
            $("#txbNowDate").datebox({ value: getNowDate() });
            $($("#Text5").textbox("textbox")).bind("focus", function () {
                theLastPartQty = isNaN(Number(this.value)) ? 0 : Number(this.value);
                ClosePort();
            })
            $($("#Text5").textbox("textbox")).bind("blur", function () {
                var thePartQty = isNaN(Number(this.value)) ? 0 : Number(this.value);
                if (thePartQty != theLastPartQty) {
                    $("#hidQtyO").val(thePartQty);
                }
                else {
                    OpenPort();
                }
            })
            $($("#txbOrderNo").textbox("textbox")).click(function () { $(this).select(); });
            $($("#txbOrderNo").textbox("textbox")).bind("keydown", BarcodeScan);
            $($("#txbOrderNo").textbox("textbox")).focus();
            $.messager.progress({ title: "正在连接验布机，请稍候..." });
            setReadOnly();
            $("#txbNowDate").datebox("setValue", getNowDate());
            $("#tableSdOrderDD").datagrid({
                fit: true,
                //border: false,
                remoteSort: false,
                loadFilter: pagerFilter,
                rowStyler: function (index, row) {
                    return "height:30px;";
                },
                columns: [
                    [
                        {
                            title: "订单号", field: "sOrderNo", width: 100, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "客户订单号", field: "sContractNo", width: 100, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "本厂缸号", field: "sVatNo", width: 80, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "染厂缸号", field: "sVatNoD", width: 80, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "颜色", field: "sColorFull", width: 40, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "序列号", field: "sSerial", width: 40, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "花型", field: "sFlowerType", width: 40, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "已验<br />卷数", field: "iCurtPartReelCount", width: 60, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "当前<br />卷号", field: "sCurtPartReelNo", width: 60, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "卷数", field: "iReelCount", width: 60, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "预计<br />卷数", field: "iPlanPartReelCount", width: 60, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "产品", field: "sCodeFull", width: 100, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "卷号<br />生成规则", field: "sReelNoBuildName", width: 80, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "卷号<br />前缀", field: "sReelNoPre", width: 60, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "卷号<br />流水规则", field: "sReelNoFlag", width: 80, align: "center", hidden: true, styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "卷号<br />流水规则", field: "sReelNoFlagName", width: 80, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "幅宽", field: "fProductWidth", width: 60, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "克重", field: "fProductWeight", width: 60, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "米数", field: "fQty", width: 60, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "客户简称", field: "sCustID", width: 140, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        {
                            title: "签订日期", field: "dDate1", width: 80, align: "center", styler: function () {
                                return "font-size:16px;";
                            }
                        },
                        { field: "iRecNo", hidden: true },
                        { field: "isOutProduce", hidden: true },
                        { field: "iPrintCount", hidden: true },
                        { field: "iPrintCount3", hidden: true },
                        { field: "iPrintCount4", hidden: true },
                        { field: "iPrintCount5", hidden: true },
                        { field: "iPackPrintMoudleRecNo", hidden: true },
                        { field: "iPackPrintCount", hidden: true },
                        { field: "iPrintMoudleRecNo2", hidden: true },
                        { field: "iPrintMoudleRecNo3", hidden: true },
                        { field: "iPrintMoudleRecNo4", hidden: true },
                        { field: "iPrintMoudleRecNo5", hidden: true },
                        { field: "iSamplePrintMoudleRecNo", hidden: true },
                        { field: "sUserName", hidden: true },
                        { field: "dSDContractDate", hidden: true },
                        { field: "iPrintMoudleRecNo", hidden: true },
                        { field: "iCurtPlanPartReelCount", hidden: true },
                        { field: "fReadyPartQtyQty", hidden: true },
                        { field: "sProduceAsk", hidden: true },
                        { field: "sSpecAsk", hidden: true },
                        { field: "sCoilingAsk", hidden: true },
                        { field: "sCheckStand", hidden: true },
                        { field: "sSampleCloth", hidden: true },
                        { field: "sStackAsk", hidden: true },
                        { field: "iBscDataMatRecNo", hidden: true },
                        { field: "sShippingMark", hidden: true },
                        { field: "iSamplePrintCount", hidden: true },
                        { field: "sSerialColorIDName", hidden: true },
                        { field: "iSdContractMRecNo", hidden: true },
                        { field: "iSdContractDRecNo", hidden: true },
                        { field: "iSDContractDMatAskRecNo", hidden: true }   
                        
                    ]
                ],
                singleSelect: true,
                onDblClickRow: function () {
                    selectSDOrderDD();
                },
                pageSize: 30,
                pageList: [30, 60, 150, 300],
                pagination: true
            }
            )
            //LoadSDOrderDD();
            var sqlObjBtn = {
                TableName: "bscDataClass",
                Fields: "sClassID,sClassName",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "stype",
                        ComOprt: "=",
                        Value: "'flaw'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "sClassID",
                        ComOprt: " not like ",
                        Value: "'17%'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "sClassID",
                        ComOprt: " not like ",
                        Value: "'18%'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "sClassID",
                        ComOprt: " not like ",
                        Value: "'19%'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "sClassID",
                        ComOprt: " not like ",
                        Value: "'20%'" 
                    }
                ],
                Sorts: [
                    {
                        SortName: "sClassID",
                        SortOrder: "asc"
                    }
                ]
            }
            var resultBtn = SqlGetData(sqlObjBtn);
            btnFlaws = resultBtn;
            for (var i = 0; i < resultBtn.length; i++) {
                var btn = $("<input type='button' id='btnFlaw_" + i + "' value='" + resultBtn[i].sClassName + "' class='btnBiggerFix' onclick='openFlawWindow(this)' />");
                $("#tdBtn" + (i + 1).toString()).append(btn);
            }
            //机台
            $("#txbMachineID").combobox({
                valueField: "iRecNo", textField: "sMachineCode"
            });
            var sqlObjMachine = {
                TableName: "bscDataMachine",
                Fields: "iRecNo,sMachineCode,sBscDataProcessMRecNo",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sClassID",
                        ComOprt: "like",
                        Value: "'03%'"
                    }
                ], Sorts: [
                    { SortName: "sMachineCode", SortOrder: "asc" }
                ]
            };
            machineData = SqlGetData(sqlObjMachine);
            $("#txbMachineID").combobox("loadData", machineData);

            $("#txbSerial").combobox({
                valueField: "iRecNo", textField: "sProcessesName",
                onChange: function (newValue, oldValue) {
                    var theMachineData = machineData.filter(function (p) {
                        return ("," + p.sBscDataProcessMRecNo + ",").indexOf("," + newValue + ",") > -1;
                    });
                    $("#txbMachineID").combobox("loadData", theMachineData);
                }
            });
            var serial = getCookie("serial" + machine);
            $("#txbSerial").combobox("setValue", serial);
            var sMachineID = getCookie("machineID" + machine);
            //$("#txbMachine").combobox("setValue", sMachineID);


            var sqlObjProcessM = {
                TableName: "BscDataProcessesM",
                Fields: "iRecNo,sProcessesName",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "iFeedType",
                        ComOprt: "=",
                        Value: "'2'"
                    }
                ], Sorts: [
                    { SortName: "sProcessesCode", SortOrder: "asc" }
                ]
            };
            var processMData = SqlGetData(sqlObjProcessM);
            $("#txbSerial").combobox("loadData", processMData);


            var sqlObjCheckPerson = {
                TableName: "bscDataPerson",
                Fields: "sCode,sName",
                SelectAll: "True",
                Sorts: [
                    {
                        SortName: "sCode",
                        SortOrder: "asc"
                    }
                ]
            }
            var resultCheckPerson = SqlGetData(sqlObjCheckPerson);
            $("#txbCheckPerson").combobox("loadData", resultCheckPerson);
            $("#txbCheckPerson").combobox("setValue", userid);
            $("#tabCdRec").datagrid({
                fit: true,
                remoteSort: false,
                showFooter: true,
                rowStyler: function (index, row) {
                    if (row.iAbandon == "1") {
                        return "height:30px;color:red";
                    }
                    else {
                        return "height:30px;";
                    }
                },
                columns: [
                    [
                        {
                            title: "序号", field: "iSerial", width: 30, align: "center", styler: function () {
                                return "font-size:14px;";
                            }
                        },
                        {
                            title: "原因", field: "sReason", width: 60, align: "center", styler: function () {
                                return "font-size:14px;";
                            }
                        },
                        {
                            title: "位置", field: "fPostion", width: 60, align: "center", styler: function () {
                                return "font-size:14px;";
                            }
                        },
                        {
                            title: "扣米数", field: "fDeductQty", width: 60, align: "center", styler: function () {
                                return "font-size:14px;";
                            }
                        },
                        { field: "iRecNo", hidden: true }
                    ]
                ],
                singleSelect: true,
                onDblClickRow: function () {
                    //selectSDOrderDD();
                },
                onLoadSuccess: function (data) {
                    var allRows = data.rows;
                    var sumDeQty = 0;
                    for (var i = 0; i < allRows.length; i++) {
                        var sReason = allRows[i].sReason;
                        if (sReason.split("-")[0] != "11") {
                            sumDeQty += (isNaN(Number(allRows[i].fDeductQty)) ? 0 : Number(allRows[i].fDeductQty));
                        }
                    }
                    //$("#Text6").numberbox("setValue", sumDeQty);
                    $("#tabCdRec").datagrid("reloadFooter", [{ fDeductQty: sumDeQty }]);
                }
            }
            )
            var sqlObjCheckScroeBs = {
                TableName: "bscDataListD",
                Fields: "top 1 sName",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sClassID",
                        ComOprt: "=",
                        Value: "'scoreBS'"
                    }
                ]
            }
            var resultCheckScroeBs = SqlGetData(sqlObjCheckScroeBs);
            if (resultCheckScroeBs.length > 0) {
                scoreBs = parseFloat(resultCheckScroeBs[0].sName);
            }


            var objStr = "<object classid='clsid:648A5600-2C6E-101B-82B6-000000000014' id='MSComm1' codebase='MSCOMM32.OCX' type='application/x-oleobject' style='left: 54px; top: 14px'>";
            var portCookie = getCookie("mscomm32_port" + machine);

            if (portCookie != null) {
                objStr += "<param name='CommPort' value='" + portCookie + "'>";
            }
            else {
                objStr += "<param name='CommPort value='4'>";
            }
            objStr += "<param name='DTREnable' value='1'><param name='Handshaking' value='0'><param name='InBufferSize' value='1024'><param name='InputLen' value='0'><param name='NullDiscard' value='0'><param name='OutBufferSize' value='512'>" +
                "<param name='ParityReplace' value='?'><param name='RThreshold' value='1'><param name='RTSEnable' value='1'><param name='SThreshold' value='2'><param name='EOFEnable' value='0'><param name='InputMode' value='0'>" +
                "<param name='DataBits' value='8'><param name='StopBits' value='1'><param name='BaudRate' value='9600'><param name='Settings' value='9600,N,8,1'>";
            var object = $(objStr);
            $("body").append(object);
            setTimeout(function () {
                try {
                    OpenPort();
                    $.messager.progress("close");
                }
                catch (e) {
                    alert("验布机连接失败！");
                    $.messager.progress("close");
                }
            }, 1000);
            setTimeout(function () {
                if (isPortOpen == false) {
                    alert("验布机连接失败！");
                }
            }, 2000);

            var objStr2 = "<object classid='clsid:648A5600-2C6E-101B-82B6-000000000014' id='MSComm2' codebase='MSCOMM32.OCX' type='application/x-oleobject' style='left: 54px; top: 14px'>";
            var portCookie2 = getCookie("mscomm32_port2" + machine);

            if (portCookie2 != null) {
                objStr2 += "<param name='CommPort' value='" + portCookie2 + "'>";
            }
            else {
                objStr2 += "<param name='CommPort value='4'>";
            }
            objStr2 += "<param name='DTREnable' value='1'><param name='Handshaking' value='0'><param name='InBufferSize' value='1024'><param name='InputLen' value='0'><param name='NullDiscard' value='0'><param name='OutBufferSize' value='512'>" +
                "<param name='ParityReplace' value='?'><param name='RThreshold' value='1'><param name='RTSEnable' value='1'><param name='SThreshold' value='2'><param name='EOFEnable' value='0'><param name='InputMode' value='0'>" +
                "<param name='DataBits' value='8'><param name='StopBits' value='1'><param name='BaudRate' value='9600'><param name='Settings' value='9600,N,8,1'>";
            var object2 = $(objStr2);
            $("body").append(object2);
            setTimeout(function () {
                try {
                    OpenPort2();
                    //$.messager.progress("close");
                }
                catch (e) {
                    alert("称重机连接失败！");
                    //$.messager.progress("close");
                }
            }, 1000);
            setTimeout(function () {
                if (isPortOpen2 == false) {
                    alert("称重机连接失败！");
                }
            }, 2000);


            $(".btnMeterAdjust").bind("click", function () {
                ClosePort();
                var value = this.value;
                if (value == "+") {
                    var meter = isNaN(Number($("#Text5").numberbox("getValue"))) ? 0 : Number($("#Text5").numberbox("getValue"));
                    meter = meter + 0.1;
                    $("#Text5").numberbox("setValue", meter);
                }
                else {
                    var meter = isNaN(Number($("#Text5").numberbox("getValue"))) ? 0 : Number($("#Text5").numberbox("getValue"));
                    if (meter > 0) {
                        meter = meter - 0.1;
                        $("#Text5").numberbox("setValue", meter);
                    }
                }
            })

            /*$(".btnVatNoDAdjust").bind("click", function () {
                var value = this.value;
                if (value == "+") {
                    var VatNoD = isNaN(Number($("#Text20").numberbox("getValue"))) ? 0 : Number($("#Text20").numberbox("getValue"));
                    VatNoD = VatNoD + 1;
                    $("#Text20").numberbox("setValue", VatNoD);
                }
                else {
                    var VatNoD = isNaN(Number($("#Text20").numberbox("getValue"))) ? 0 : Number($("#Text20").numberbox("getValue"));
                    VatNoD = VatNoD - 1;
                    $("#Text20").numberbox("setValue", VatNoD);
                }
            })*/

            $(".btnShowPackPersons").bind("click", function () {
                var sPackPersonID = $("#Text212").val();
                if (sPackPersonID != "" && sPackPersonID != null) {
                    var sPackPersonIDs = sPackPersonID.split(",");
                    for (var i = 0; i < sPackPersonIDs.length; i++) {
                        $("#divShowPackPersonsSelect input:checked[value='" + sPackPersonIDs[i] + "']").attr('checked', 'true');
                    }
                }
                $("#divShowPackPersons").window("open");
            })

            $(".btnPositionAdjust").bind("click", function () {
                //ClosePort();
                var value = this.value;
                if (value == "+") {
                    var meter = isNaN(Number($("#txbFlawPosition").numberbox("getValue"))) ? 0 : Number($("#txbFlawPosition").numberbox("getValue"));
                    meter = meter + 0.1;
                    $("#txbFlawPosition").numberbox("setValue", meter);
                }
                else {
                    var meter = isNaN(Number($("#txbFlawPosition").numberbox("getValue"))) ? 0 : Number($("#txbFlawPosition").numberbox("getValue"));
                    if (meter > 0) {
                        meter = meter - 0.1;
                        $("#txbFlawPosition").numberbox("setValue", meter);
                    }
                }
            })
            $(".btnDeAdjust").bind("click", function () {
                //ClosePort();
                var value = this.value;
                if (value == "+") {
                    if (isPingOpen == true) {
                        ClosePort();
                    }
                    var meter = isNaN(Number($("#txbFlawDeMeter").numberbox("getValue"))) ? 0 : Number($("#txbFlawDeMeter").numberbox("getValue"));
                    meter = meter + 0.1;
                    $("#txbFlawDeMeter").numberbox("setValue", meter);

                }
                else {
                    var meter = isNaN(Number($("#txbFlawDeMeter").numberbox("getValue"))) ? 0 : Number($("#txbFlawDeMeter").numberbox("getValue"));
                    if (meter > 0) {
                        if (isPingOpen == true) {
                            ClosePort();
                        }
                        meter = meter - 0.1;
                        $("#txbFlawDeMeter").numberbox("setValue", meter);
                    }
                }
            })
            var sqlObjYield = {
                TableName: "SDOrderDDVatNoDReelNo",
                Fields: "SUM(fRealQty) AS fQty",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "convert(varchar(10),dInputDate,23)",
                        ComOprt: "=",
                        Value: "'" + getNowDate() + "'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "sMachineID",
                        ComOprt: "=",
                        Value: "'" + sMachineID + "'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "sCheckPersonID",
                        ComOprt: "=",
                        Value: "'" + userid + "'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "isnull(iCutSample,0)",
                        ComOprt: "=",
                        Value: "0"
                    }
                ]
            }
            var resultYield = SqlGetData(sqlObjYield);
            if (resultYield.length > 0) {
                $("#txbTodayTotal").numberbox("setValue", resultYield[0].fQty);
                totalQty = isNaN(Number(resultYield[0].fQty)) ? 0 : Number(resultYield[0].fQty);
            }
            $($("#txbSearchOrderNo").textbox("textbox")).bind("focus", function () {
                this.value = "";
            });
            $($("#txbSearchVatNo").textbox("textbox")).bind("focus", function () {
                this.value = "";
            });
            $($("#txbSearchVatNoDye").textbox("textbox")).bind("focus", function () {
                this.value = "";
            });
            /*$($("#txbSearchCode").textbox("textbox")).bind("focus", function () {
                this.value = "";
            });*/
            $($("#txbSearchColorID").textbox("textbox")).bind("focus", function () {
                this.value = "";
            });


            var portCookie = getCookie("mscomm32_port" + machine);
            var machineID = getCookie("machineID" + machine);
            var portCookie2 = getCookie("mscomm32_port2" + machine);
            var iProcessMRecNo = getCookie("serial" + machine);
            //var machineID2 = getCookie("machineID2" + machine);
            if (portCookie != null) {
                $("#txbCommPort").numberspinner("setValue", portCookie);
            }
            if (machineID != null) {
                $("#txbMachineID").combobox("setValue", machineID);
            }
            if (portCookie2 != null) {
                $("#txbCommPort2").numberspinner("setValue", portCookie2);
            }
            if (iProcessMRecNo != null) {
                $("#txbSerial").combobox("setValue", iProcessMRecNo);
            }
        })

        function selectPackPersons() {
            var sSeletedPackPersonsID = $(".sPackPersonsSelect:checked");
            var sSeletedPackPersonsName = $(".sPackPersonsSelect:checked");
            if (sSeletedPackPersonsID.length > 0) {
                var sPackPersonID = $(sSeletedPackPersonsID[0]).val();
                var sPackPersonName = $(sSeletedPackPersonsName[0]).parent().text();
                for (var i = 1; i < sSeletedPackPersonsID.length; i++) {
                    sPackPersonID += "," + $(sSeletedPackPersonsName[i]).val();
                    sPackPersonName += "," + $(sSeletedPackPersonsName[i]).parent().text();
                }
                $("#Text21").textbox("setValue", sPackPersonName);
                $("#Text212").val(sPackPersonID);
            }
            $("#divShowPackPersons").window("close");
        }

        function selectProductRemark() {
            var sSeletedProductRemarkID = $(".sProductRemarkSelect:checked");
            var sSeletedProductRemark = $(".sProductRemarkSelect:checked");
            var sProductRemarkID = "";
            var sProductRemarks = "";
            if (sSeletedProductRemark.length > 0) {
                sProductRemarkID = $(sSeletedProductRemark[0]).val();
                sProductRemarks = $(sSeletedProductRemark[0]).parent().text();
                for (var i = 1; i < sSeletedProductRemark.length; i++) { 
                    sProductRemarkID += "," + $(sSeletedProductRemark[i]).val();
                    sProductRemarks += "," + $(sSeletedProductRemark[i]).parent().text();
                }
                $("#Text213").val(sProductRemarkID);
                $("#textProductRemark").text(sProductRemarks); 
            }
            $("#divShowProductRemark").window("close");
        }

        
        function setWorkClass(sName) {
            // $("#Text21").combobox("setValue", sName);
            $("input:radio[value='" + sName + "']").attr('checked', 'true');
            $("#divWorkClass").window("close");
        }

        function setReadOnly() {
            $($("#Text2").textbox("textbox")).addClass("txbreadonly");
            $($("#Text3").textbox("textbox")).addClass("txbreadonly");
            $($("#Text4").textbox("textbox")).addClass("txbred");
            $($("#Text5").textbox("textbox")).addClass("txbred");
            $($("#Text8").textbox("textbox")).addClass("txbreadonly");
            $($("#Text7").textbox("textbox")).addClass("txbreadonly");

            $($("#Text20").textbox("textbox")).addClass("txbreadonly");
            $($("#Text9").textbox("textbox")).addClass("txbreadonly");
            $($("#Text10").textbox("textbox")).addClass("txbreadonly");
            $($("#txbNowDate").datebox("textbox")).addClass("txbreadonly");
            $($("#Text14").textbox("textbox")).addClass("txbreadonly");
            $($("#Text15").textbox("textbox")).addClass("txbreadonly");
            $($("#Text11").textbox("textbox")).addClass("txbreadonly");
            $($("#Text12").textbox("textbox")).addClass("txbreadonly");
            $($("#Text17").numberbox("textbox")).addClass("txbreadonly");
        }

        function LoadSDOrderDD() {
            var filters = [
                {
                    Field: " ",
                    ComOprt: "not exists",
                    Value: "(select 1 from SDOrderDDVatNo as b where isnull(b.dEndTime,'2299-12-31')<>'2299-12-31' and a.iRecNo=b.iSDOrderDDRecNo)",
                    LinkOprt: "and"
                },
                {
                    Field: "isnull(iSplitFinish,0)",
                    ComOprt: "=",
                    Value: "0"
                }
            ];

            var sOrderNo = $("#txbSearchOrderNo").textbox("getValue");
            var sVatNo = $("#txbSearchVatNo").textbox("getValue");
            var sVatNoDye = $("#txbSearchVatNoDye").textbox("getValue");
            //var sCode = $("#txbSearchCode").textbox("getValue");
            var sColorID = $("#txbSearchColorID").textbox("getValue");
            if (sOrderNo != "") {
                if (filters.length > 0) {
                    filters[filters.length - 1].LinkOprt = "and";
                }
                filters.push(
                    {
                        LeftParenthese: "(",
                        Field: "sOrderNo",
                        ComOprt: "like",
                        Value: "'%" + sOrderNo + "%'",
                        LinkOprt: "or"
                    }
                );
                filters.push(
                    {
                        RightParenthese: ")",
                        Field: "dbo.f_GetPy(sOrderNo)",
                        ComOprt: "like",
                        Value: "'%" + sOrderNo + "%'"
                    }
                )
            }
            if (sVatNo != "") {
                if (filters.length > 0) {
                    filters[filters.length - 1].LinkOprt = "and";
                }
                filters.push(
                    {
                        Field: "sVatNo",
                        ComOprt: "like",
                        Value: "'%" + sVatNo + "%'"
                    }
                )
            }
            if (sVatNoDye != "") {
                if (filters.length > 0) {
                    filters[filters.length - 1].LinkOprt = "and";
                }
                filters.push(
                    {
                        Field: "sVatNoDye",
                        ComOprt: "like",
                        Value: "'%" + sVatNoDye + "%'"
                    }
                )
            }
            /* if (sCode != "") {
                 if (filters.length > 0) {
                     filters[filters.length - 1].LinkOprt = "and";
                 }
                 filters.push(
                     {
                         Field: "sCodeFull",
                         ComOprt: "like",
                         Value: "'%" + sCode + "%'"
                     }
                 )
             }*/
            if (sColorID != "") {
                if (filters.length > 0) {
                    filters[filters.length - 1].LinkOprt = "and";
                }
                filters.push(
                    {
                        Field: "sSerial",
                        ComOprt: "like",
                        Value: "'%" + sColorID + "%'"
                    }
                )
            }
            /* if (filters.length > 0) {
                 filters[filters.length - 1].LinkOprt = "and";
             }
             filters.push(
                 {
                 Field: "isnull(isOutProduce,0)",
                 ComOprt: "<>",
                 Value: "1"
             }
             )*/
            var sqlObj = {
                TableName: "vwSDOrderDDMD as a",
                Fields: "*,sVatNoD = isnull(sVatNoDye,'')",
                SelectAll: "True",
                Filters: filters,
                Sorts: [
                    {
                        SortName: "dDate1",
                        SortOrder: "asc"
                    },
                    {
                        SortName: "sOrderNo",
                        SortOrder: "asc"
                    },
                    {
                        SortName: "iRecNo",
                        SortOrder: "asc"
                    },
                    {
                        SortName: "iSerial",
                        SortOrder: "asc"
                    }
                ]
            }
            var result = SqlGetData(sqlObj);
            $("#tableSdOrderDD").datagrid("loadData", { total: 0, rows: [] });
            $("#tableSdOrderDD").datagrid("loadData", { total: result.length, rows: result });
        }

        function openOrderWindow() {
            //LoadSDOrderDD();
            $("#divSdOrderDD").window("open");
            var allRows = $("#tableSdOrderDD").datagrid("getRows");
            for (var i = 0; i < allRows.length; i++) {
                if (iSelectRecNo == allRows[i].iRecNo) {
                    $("#tableSdOrderDD").datagrid("selectRow", i);
                    break;
                }
            }
        }

        function selectSDOrderDD() {
            var selectRow = $("#tableSdOrderDD").datagrid("getSelected");
            if (selectRow) {
                $("#btnSamplePrint").prop("disabled", true);
                $("#btnWholeDefective").prop("disabled", true);
                iNewBscDataMatRecNo = selectRow.iBscDataMatRecNo;
                iNewProductWidth = selectRow.fProductWidth;
                iNewProductWeight = selectRow.fProductWeight;
                
                var sNewCodeFull = selectRow.sCodeFull;
                var sMachineIDTmp = $("#txbMachineID").combobox("getValue");

                if (GetUrlParam("iSendCut") == "1") {
                    var sqlObjCut = {
                        TableName: "SDSendD a inner join pbReportData aa on a.iSamplePrintModuleRecNo=aa.iRecNo inner join SDSendM b on a.iMainRecNo=b.iRecNo and b.iStatus>3 and b.iBillType=0 inner join SDOrderD d on a.iSDOrderDRecNo=d.iRecNo inner join SDOrderDD e on e.iMainRecNo=d.iRecNo left join SDOrderDDCutD as f on a.iRecNo=f.iSDSendDRecNo and e.iRecNo=f.iMainRecNo ",
                        Fields: "a.iRecNo,sSumQty=convert(varchar(10),isnull(a.fSumQty,0)),isnull(iSamplePrintModuleRecNo,0) iSamplePrintModuleRecNo,isnull(iSamplePrintCount,0) iSamplePrintCount,b.iCutType,a.iSDOrderDDRecNo,a.iCutSample,e.iSamplePrinted,f.iCut",
                        SelectAll: "True",
                        Filters: [
                            {
                                Field: "b.iStatus",
                                ComOprt: "=",
                                Value: "4",
                                LinkOprt: "and"
                            },
                            //{
                            //    Field: "b.sOutType",
                            //    ComOprt: "=",
                            //    Value: "'车间'",
                            //    LinkOprt: "and"
                            //},
                            {
                                Field: "e.iRecNo",
                                ComOprt: "=",
                                Value: selectRow.iRecNo
                            }]
                    }
                    var resultCut = SqlGetData(sqlObjCut);
                    if (resultCut.length > 0) {
                        var iNeedCount = 0;
                        for (var i = 0; i < resultCut.length; i++) {
                            var iCutType = resultCut[i].iCutType;
                            if (iCutType == "0") {
                                if (resultCut[i].iSDOrderDDRecNo == selectRow.iRecNo) {
                                    if (resultCut[i].iCutSample == "1")
                                        continue;
                                    var disabled = resultCut[i].iCutSample == "1" ? "disabled:'disabled'" : "";
                                    $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                                    iNeedCount++;
                                }
                            } else if (iCutType == "1") {
                                if (resultCut[i].iCutSample == "1")
                                    continue;
                                $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                                iNeedCount++;
                            } else if (iCutType == "2") {
                                if (resultCut[i].iCut == "1")
                                    continue;
                                $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                                iNeedCount++;
                            }
                        }
                        if (iNeedCount > 0) {
                            $("#cutRemark").html("需剪样");
                            $("#btnSamplePrint").css("background-color", "red");
                            $("#btnSamplePrint").val("剪样" + iNeedCount);

                            $("#btnSamplePrint").prop("disabled", false);
                        }
                        else {
                            $("#cutRemark").html("");
                            $("#btnSamplePrint").val("剪样");
                            $("#btnSamplePrint").css("background-color", "transparent");
                            $("#btnSamplePrint").prop("disabled", true);
                        }
                    } else {
                        $("#cutRemark").html("");
                        $("#btnSamplePrint").val("剪样");
                        $("#btnSamplePrint").css("background-color", "transparent");
                        $("#btnSamplePrint").prop("disabled", true);
                    }
                } else {
                    $("#btnSamplePrint").prop("disabled", false);
                }


                if (iNewBscDataMatRecNo != iLastBscDataMatRecNo) {
                    var sqlObj = {
                        TableName: "bscDataMatDMachineParam",
                        Fields: "isnull(sCodeTable,'') sCodeTable,convert(varchar(20),isnull(fPerimeter,0)) fPerimeter,isnull(sRemark,'') sRemark",
                        SelectAll: "True",
                        Filters: [
                            {
                                Field: "sMachineID",
                                ComOprt: "=",
                                Value: "'" + sMachineIDTmp + "'",
                                LinkOprt: "and"
                            },
                            {
                                Field: "iProductWidth",
                                ComOprt: "=",
                                Value: iNewProductWidth,
                                LinkOprt: "and"
                            },
                            {
                                Field: "iProductWeight",
                                ComOprt: "=",
                                Value: iNewProductWeight,
                                LinkOprt: "and"
                            }, 
                            {
                                Field: "iMainRecNo",
                                ComOprt: "=",
                                Value: iNewBscDataMatRecNo
                            }]
                    }
                    var result = SqlGetData(sqlObj);
                    if (result.length > 0) {
                        $("#btnPerimeter").val("周长: " + result[0].fPerimeter);
                        $.messager.alert("码表更新提示", "<p style='font-size:24px; font-weight:bold;'>产品名称: " + sNewCodeFull + "</p><p style='font-size:24px;font-weight:bold;'>机台号: " + sMachineIDTmp + "</p><p style='font-size:24px;font-weight:bold;'>周长: " + result[0].fPerimeter + "</p><p style='font-size:24px;font-weight:bold;'>备注: " + result[0].sRemark + "</p>");
                    } else {
                        $("#btnPerimeter").val("周长");
                    }
                }
                sReCheckBarCode = "";
                isOutProduce = selectRow.isOutProduce;
                iSelectRecNo = selectRow.iRecNo;
                iLastBscDataMatRecNo = selectRow.iBscDataMatRecNo;
                iPrintMoudleRecNo = selectRow.iPrintMoudleRecNo;
                iPrintMoudleRecNo2 = selectRow.iPrintMoudleRecNo2;
                iPrintMoudleRecNo3 = selectRow.iPrintMoudleRecNo3;
                iPrintMoudleRecNo4 = selectRow.iPrintMoudleRecNo4;
                iPrintMoudleRecNo5 = selectRow.iPrintMoudleRecNo5;
                iSamplePrintCount = selectRow.iSamplePrintCount;
                iSamplePrintMoudleRecNo = selectRow.iSamplePrintMoudleRecNo;
                iPackPrintMoudleRecNo = selectRow.iPackPrintMoudleRecNo;
                iPackPrintCount = isNaN(Number(selectRow.iPackPrintCount)) ? 1 : Number(selectRow.iPackPrintCount);
                var sUserName = selectRow.sUserName;
                var dSDContractDate = selectRow.dSDContractDate;
                $('#sUserName').html("业务员：" + sUserName);
                $('#dSDContractDate').html(dSDContractDate);
                iPrintCount = isNaN(Number(selectRow.iPrintCount)) ? 1 : Number(selectRow.iPrintCount);
                iPrintCount3 = isNaN(Number(selectRow.iPrintCount3)) ? 1 : Number(selectRow.iPrintCount3);
                iPrintCount4 = isNaN(Number(selectRow.iPrintCount4)) ? 1 : Number(selectRow.iPrintCount4);
                iPrintCount5 = isNaN(Number(selectRow.iPrintCount5)) ? 1 : Number(selectRow.iPrintCount5);
                iSamplePrintMoudleRecNo = isNaN(Number(selectRow.iSamplePrintMoudleRecNo)) ? 1 : Number(selectRow.iSamplePrintMoudleRecNo);
                sUnitID = selectRow.sUnitID;
                //根据订单设置码表单位
                /* if (sUnitID == "M") {
                     //                    SendPortMessage("0x00,0x00,0x00,0x00,0x00,0x00,0x4D");
                     SendPortMessage("0x4D");
                 }
                 else if (sUnitID == "Y") {
                     //                    SendPortMessage("0x00,0x00,0x00,0x00,0x00,0x00,0x59");
                     SendPortMessage("0x59");
                 }*/
                $("#form1").form("load", selectRow);
                if (selectRow.iAllowVatNoReelNoDiscontinuities == "1") {
                    $("#trDis").show();
                }
                else {
                    $("#trDis").hide();
                }

                $("img").attr("src", selectRow.sImageUrl);
                var codeFull = selectRow.sCodeFull;
                if (codeFull != lastMatCode) {
                    var sMachineID = getCookie("machineID");
                    var sCode = selectRow.sCode;
                    var sqlObjMat = {
                        TableName: "bscDataMatDMachineParam",
                        Fields: "sParams",
                        SelectAll: "True",
                        Filters: [
                            {
                                Field: "iMainRecNo",
                                ComOprt: "=",
                                Value: "(select top 1 iRecNo from bscDataMat where sCode='" + sCode + "')",
                                LinkOprt: "and"
                            },
                            {
                                Field: "sMachineID",
                                ComOprt: "=",
                                Value: "'" + sMachineID + "'"
                            }
                        ]
                    }
                    var resultMatParam = SqlGetData(sqlObjMat);
                    if (resultMatParam.length > 0) {
                        $.messager.alert("请设置机台参数", "<span style='font-size:20px;font-weight:bold;color:blue;'>请设置机台参数：</span><span style='font-size:20px;font-weight:bold;color:red;'>" + resultMatParam[0].sParams + "</span>");
                    }
                    lastMatCode = codeFull;
                }

                var sReelNoFlag = selectRow.sReelNoFlag;
                var theReelNo = "";
                var sReelNoPre = selectRow.sReelNoPre == null || selectRow.sReelNoPre == undefined ? "" : selectRow.sReelNoPre;
                if (selectRow.iCurtPartReelCount == 0 || selectRow.iCurtPartReelCount == null || selectRow.iCurtPartReelCount == undefined) {
                    if (sReelNoFlag != "0" && sReelNoFlag != null) {
                        theReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + 1).toString(), sReelNoFlag.length);
                    }
                    else {
                        theReelNo = sReelNoPre + "1";
                    }
                }
                else {
                    var nextPartReelCount = parseInt(selectRow.iCurtPartReelCount) + 1;
                    if (sReelNoFlag != "0") {
                        theReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + nextPartReelCount).toString(), sReelNoFlag.length);
                    }
                    else {
                        theReelNo = sReelNoPre + nextPartReelCount.toString();
                    }
                }
                $("#Text9").textbox("setValue", theReelNo);
                $("#txaCoilingAsk").val(selectRow.sCoilingAsk);
                $("#txaCheckStand").val(selectRow.sCheckStand);
                $("#txaShippingMark").val(selectRow.sShippingMark);
                // $("#txaDetailProduceAsk").val(selectRow.sProduceAsk);
                $("#txaDetailSpecAsk").val(selectRow.sSpecAsk);
                $("#txaDetailCoilingAsk").val(selectRow.sCoilingAsk);
                $("#txaDetailCheckStand").val(selectRow.sCheckStand);
                $("#txaDetailSampleCloth").val(selectRow.sSampleCloth);
                $("#txaDetailStackAsk").val(selectRow.sStackAsk);
                $("#txaDetailShippingMark").val(selectRow.sShippingMark);
                $("#tablePackDetail").empty();
                var sqlGetSDContractDPackD = {
                    TableName: "SDContractDPackD",
                    Fields: "*,sSpec1=isnull(sSpec,'')",
                    SelectAll: "True",
                    Filters: [ 
                        {
                            Field: "iMainRecNo",
                            ComOprt: "=",
                            Value: selectRow.iSDContractDMatAskRecNo
                        }
                    ]
                }
                var resultSDContractDPackD = SqlGetData(sqlGetSDContractDPackD);
                if (resultSDContractDPackD.length > 0) {
                    for (var i = 0; i < resultSDContractDPackD.length; i++) {
                        var c = "";
                        c = "<tr><td style='height:60px'>" + resultSDContractDPackD[i].iSerial.toString() + ". " + (resultSDContractDPackD[i].sClassName ? resultSDContractDPackD[i].sClassName : "") + ": " + (resultSDContractDPackD[i].sMatName ? resultSDContractDPackD[i].sMatName : "") + "</td>"; 
                        c += "<td>数量: " + (resultSDContractDPackD[i].fQty ? resultSDContractDPackD[i].fQty : "").toString() + "</td>";
                        c += "<td>规格: " + resultSDContractDPackD[i].sSpec1 + "</td></tr>";
                        $("#tablePackDetail").append(c);
                    }
                }

                var sqlGetIMG = {
                    TableName: "FileUplad",
                    Fields: "iFormID,sTableName,iTableRecNo,sImageID,sYearMonth,sFileName",
                    SelectAll: "True",
                    Filters: [
                        {
                            Field: "sTableName",
                            ComOprt: "=",
                            Value: "'SDContractM'",
                            LinkOprt: "and"
                        },
                        {
                            Field: "iTableRecNo",
                            ComOprt: "=",
                            Value: selectRow.iSdContractMRecNo
                        }
                    ]
                }
                var result = SqlGetData(sqlGetIMG);
                if (result.length > 0) {
                    $("#imgMainImage").attr("src", "../../Base/imageUpload/images/" + result[0].sYearMonth + "/" + result[0].iFormID + "_" + result[0].sTableName + "_" + result[0].iTableRecNo + "_" + result[0].sImageID + "_" + result[0].sFileName);
                } else {
                    $("#imgMainImage").attr("src", "");
                }
                 
                $("#txbOrderNo").textbox("setValue", selectRow.sOrderNo);
            }
            else {
                alert("请选择一个订单");
            }
            $("#divSdOrderDD").window("close");
            var sqlObjMaxReelNo = {
                TableName: "SDOrderDDVatNoDReelNo",
                Fields: "isnull(max(iRecNo),0) as iRecNo",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "iSDOrderMRecNo",
                        ComOprt: "=",
                        Value: "'" + selectRow.iSDOrderMRecNo + "'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "iSDOrderDRecNo",
                        ComOprt: "=",
                        Value: "'" + selectRow.iSDOrderDRecNo + "'"
                    }
                ]
            }
            var resultMaxRecNo = SqlGetData(sqlObjMaxReelNo);
            if (resultMaxRecNo.length > 0) {
                iLastSDOrderDDVatNoDReelNoRecNo = resultMaxRecNo[0].iRecNo;
            }
        }

        function jsleft(lefts, leftn) {
            var sl = lefts;
            sl = sl.substring(0, leftn);
            return sl;
        }
        function jsright(rights, rightn) {
            var sr = rights;
            sr = sr.substring(sr.length - rightn, sr.length);
            return sr;
        }
        function getNowDate() {
            var nowdate = new Date();
            var year = nowdate.getFullYear();
            var month = nowdate.getMonth();
            var date = nowdate.getDate();
            var monthstr = (month + 1).toString();
            var datestr = date.toString();
            if (month < 9) {
                monthstr = '0' + (month + 1).toString();
            }
            if (date < 10) {
                datestr = '0' + date.toString();
            }
            return year.toString() + "-" + monthstr + "-" + datestr;
        }
        var isPingOpen = false;
        function openFlawWindow(obj) {
            var btnID = obj.id;
            var index = btnID.indexOf("_");
            var intID = parseInt(btnID.substr(index + 1, btnID.length - index - 1));
            var theFlaw = btnFlaws[intID];
            $("#txbLinkMeter").val("");
            $("#trLink").hide();
            if (theFlaw.sClassID == "11") {
                targetTxt = "txbFlawDeMeter";
                $("#tdDe").html("剪米数");
                isPingOpen = true;
                $("#trLink").show();
            }
            else {
                $("#tdDe").html("扣米数");
            }


            //var selectMainRow = $("#tableSdOrderDD").datagrid("getSelected");
            if (iSelectRecNo == 0) {
                alert("请先选择订单！");
                return false;
            }
            var sCheckPersonID = $("#txbCheckPerson").combobox("getValue");
            if (sCheckPersonID == "" || sCheckPersonID == null || sCheckPersonID == undefined) {
                alert("请先选择检验员！");
                return false;
            }
            $("#form2").form("reset");
            $("#txbFlawDeMeter").numberbox("setValue", "0.1");
            $("#txbFlawDeMeter").numberbox("setValue", "0.2");
            //            var sqlObjLastFlaw = {
            //                TableName: "SDOrderDDVatNoDReelNoFlawD as a",
            //                Fields: "TOP 1 fDeductQty",
            //                SelectAll: "True",
            //                Filters: [
            //                    {
            //                        Field: "iMainRecNo",
            //                        ComOprt: "in",
            //                        Value: "(select b.iRecNo from sdorderdd as b,SDOrderDDVatNoDReelNo as c where b.iRecNo='" + iSelectRecNo + "' and b.iRecNo=c.iSDOrderDDRecNo and b.sVatNo=c.sVatNo)",
            //                        LinkOprt: "and"
            //                    },
            //                    {
            //                        Field: "isnull(iTmp,0)",
            //                        ComOprt: "<>",
            //                        Value: "1",
            //                        LinkOprt: "and"
            //                    },
            //                    {
            //                        Field: "isnull(iAbandon,0)",
            //                        ComOprt: "<>",
            //                        Value: "1"
            //                    }
            //                ],
            //                Sorts: [
            //                    {
            //                        SortName: "iRecNo",
            //                        SortOrder: "desc"
            //                    }
            //                ]
            //            }
            //            var resultFlaw = SqlGetData(sqlObjLastFlaw);
            //            if (resultFlaw.length > 0) {
            //                $("#txbFlawDeMeter").numberbox("setValue", resultFlaw[0].fDeductQty);
            //            }
            var sqlObjClass = {
                TableName: "bscDataClass",
                Fields: "sFlawDefaultQty",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sClassID",
                        ComOprt: "=",
                        Value: "'" + theFlaw.sClassID + "'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "sType",
                        ComOprt: "=",
                        Value: "'flaw'"
                    }
                ]
            }
            var resultClass = SqlGetData(sqlObjClass);
            if (resultClass.length > 0) {
                $("#txbFlawDeMeter").numberbox("setValue", "0.1");
                $("#txbFlawDeMeter").numberbox("setValue", resultClass[0].sFlawDefaultQty);
            }
            if (theFlaw.sClassID == "11") {
                $("#txbFlawDeMeter").numberbox("setValue", 0);
            }

            $("#divFlaw").window("open");

            $("#txbFlawReason").textbox("setValue", theFlaw.sClassID + '-' + theFlaw.sClassName);
            $("#txbFlawPosition").numberbox("setValue", $("#Text5").numberbox("getValue"));
            var iNextRecNo = getChildID("SDOrderDDFlawD");
            $("#txbSDOrderDDFlawDRecNo").val(iNextRecNo);
            if (obj.value == "全疵") {
                //console.log($("#Text5").numberbox("getValue"));
                $("#txbFlawDeMeter").numberbox("setValue", $("#Text5").numberbox("getValue"));
                //console.log($("#txbFlawDeMeter").numberbox("getValue"));
            }
        }
        function flawConfirm() {
            if ($("#form2").form("validate")) {
                var sCheckPersonID = $("#txbCheckPerson").combobox("getValue");
                if (sCheckPersonID == "" || sCheckPersonID == null || sCheckPersonID == undefined) {
                    alert("请先选择检验员！");
                    return false;
                }
                //var selectMainRow = $("#tableSdOrderDD").datagrid("getSelected");
                if (iSelectRecNo > 0) {
                    var iRecNo = $("#txbSDOrderDDFlawDRecNo").val();
                    var iMainRecNo = iSelectRecNo;
                    var aRows = $("#tabCdRec").datagrid("getRows");
                    var iSerial = aRows.length + 1;
                    var sReason = $("#txbFlawReason").textbox("getValue");
                    var fPosition = $("#txbFlawPosition").numberbox("getValue");
                    var fScore = isNaN(Number($("#txbFlawScroe").numberbox("getValue"))) ? 0 : Number($("#txbFlawScroe").numberbox("getValue"));
                    var fDeductQty = isNaN(Number($("#txbFlawDeMeter").numberbox("getValue"))) ? 0 : Number($("#txbFlawDeMeter").numberbox("getValue"));
                    var jsonobj = {
                        StoreProName: "SpSDOrderDDVatNoDReelNoFlawDAdd",
                        StoreParms: [{
                            ParmName: "@iRecNo",
                            Value: iRecNo
                        },
                        {
                            ParmName: "@iSerial",
                            Value: iSerial
                        },
                        {
                            ParmName: "@sReason",
                            Value: sReason
                        },
                        {
                            ParmName: "@fPosition",
                            Value: fPosition
                        },
                        {
                            ParmName: "@fScore",
                            Value: fScore
                        },
                        {
                            ParmName: "@fDeductQty",
                            Value: fDeductQty
                        },
                        {
                            ParmName: "@sCheckPersonID",
                            Value: sCheckPersonID
                        }
                        ]
                    }
                    var result = SqlStoreProce(jsonobj);
                    if (result != "1") {
                        alert(result);
                    }
                    else {
                        var appRow = {
                            iRecNo: iRecNo,
                            iSerial: iSerial,
                            sReason: sReason,
                            fPostion: fPosition,
                            fDeductQty: fDeductQty
                        }
                        $("#tabCdRec").datagrid("appendRow", appRow);
                        $("#divFlaw").window("close");
                        var allRows = $("#tabCdRec").datagrid("getRows");
                        var sumDeQty = 0;
                        for (var i = 0; i < allRows.length; i++) {
                            var sReason = allRows[i].sReason;
                            if (sReason.split("-")[0] != "11") {
                                sumDeQty += (isNaN(Number(allRows[i].fDeductQty)) ? 0 : Number(allRows[i].fDeductQty));
                            }
                        }
                        $("#Text6").numberbox("setValue", sumDeQty);
                        $("#tabCdRec").datagrid("reloadFooter", [{ fDeductQty: sumDeQty }]);
                        if (sReason.substr(0, 2) == "11") {
                            fLastCutQty = fDeductQty;
                            targetTxt = "Text5";
                        }
                    }
                }
                else {
                    alert("请先选择订单！");
                    return false;
                }
            }
        }
        var fLastPartQty1 = 0;
        function LinkMeterChange(newValue, oldValue) { 
            var newValue1 = isNaN(Number(newValue)) ? 0 : Number(newValue);
            var fTmpQty = isNaN(Number($("#Text5").numberbox("getValue"))) ? 0 : Number($("#Text5").numberbox("getValue"));
            $("#txbFlawPosition").numberbox("setValue", Number(newValue1 + fTmpQty));
        }
        function partQtyChange(newValue, oldValue) {
            var newV = isNaN(Number(newValue)) ? 0 : Number(newValue);
            var oldV = isNaN(Number(oldValue)) ? 0 : Number(oldValue);
            if (newV == 0 && oldV != 0) {
                fLastPartQty1 = oldV;
            }
            else {
                fLastPartQty1 = newV;
            }
            var fDeductQty = $("#Text6").numberbox("getValue");
            var fRealQty = (isNaN(Number(newValue)) ? 0 : Number(newValue)) - (isNaN(Number(fDeductQty)) ? 0 : Number(fDeductQty));
            $("#Text7").numberbox("setValue", fRealQty);
        }
        function DeductQtyChange(newValue, oldValue) {
            var fPartQty = $("#Text5").numberbox("getValue");
            var fRealQty = (isNaN(Number(fPartQty)) ? 0 : Number(fPartQty)) - (isNaN(Number(newValue)) ? 0 : Number(newValue));
            $("#Text7").numberbox("setValue", fRealQty);
        }
        function flawDeMeterChange(newValue, oldValue) {
            var aaa = $("#tdDe").html();
            if (aaa != "剪米数") {
                var flawDeMeter = $("#txbFlawDeMeter").numberbox("getValue");
                var flawScroe = (isNaN(Number(flawDeMeter)) ? 0 : Number(flawDeMeter)) * scoreBs;
                $("#txbFlawScroe").numberbox("setValue", flawScroe);
            }
        }
        function getChildID(tablename) {
            var jsonobj = {
                StoreProName: "SpGetIden",
                StoreParms: [{
                    ParmName: "@sTableName",
                    Value: tablename
                }]
            }
            var result = SqlStoreProce(jsonobj);
            if (result && result.length > 0 && result != "-1") {
                return result;
            }
            else {
                return "-1";
            }
        }
        //type=1删除,2作废,3清空
        function deleteOrAbandonOrClear(type) {
            if (type == 1 || type == 2) {
                var message = type == 1 ? "删除" : "作废";
                var selectRow = $("#tabCdRec").datagrid("getSelected");
                if (selectRow) {
                    $.messager.confirm("您确定吗？", "您确定要" + message + "所选行吗？", function (r) {
                        if (r) {
                            var jsonobj = {
                                StoreProName: "SpSDOrderDDVatNoDReelNoFlawDDeleteOrAbandon",
                                StoreParms: [{
                                    ParmName: "@iRecNo",
                                    Value: selectRow.iRecNo
                                },
                                {
                                    ParmName: "@sRecNoStr",
                                    Value: ""
                                },
                                {
                                    ParmName: "@iType",
                                    Value: type
                                }
                                ]
                            }
                            var result = SqlStoreProce(jsonobj);
                            if (result != "1") {
                                alert(result);
                            }
                            else {
                                if (type == 1) {
                                    $("#tabCdRec").datagrid("deleteRow", $("#tabCdRec").datagrid("getRowIndex", selectRow));
                                }
                                else {
                                    $("#tabCdRec").datagrid("updateRow", { index: $("#tabCdRec").datagrid("getRowIndex", selectRow), row: { iAbandon: 1 } });
                                }
                                if (selectRow.sReason.substr(0, 2) != "11") {
                                    var fDeductQty = isNaN(Number(selectRow.fDeductQty)) ? 0 : Number(selectRow.fDeductQty);
                                    var fDeductQtySum = isNaN(Number($("#Text6").numberbox("getValue"))) ? 0 : Number($("#Text6").numberbox("getValue"));
                                    $("#Text6").numberbox("setValue", fDeductQtySum - fDeductQty);
                                }
                            }
                        }
                    })
                }
                else {
                    alert("请选择一行");
                }
            }
            else {
                var allRows = $("#tabCdRec").datagrid("getRows");
                if (allRows.length > 0) {
                    var iMainRecNo = iSelectRecNo;
                    $.messager.confirm("您确定吗？", "您确定要清空所有疵点吗？清空后不可恢复", function (r) {
                        if (r) {
                            var iRecNoStr = "";
                            for (var i = 0; i < allRows.length; i++) {
                                iRecNoStr += allRows[i].iRecNo + ",";
                            }
                            if (iRecNoStr != "") {
                                iRecNoStr = iRecNoStr.substr(0, iRecNoStr.length - 1);
                            }
                            var jsonobj = {
                                StoreProName: "SpSDOrderDDVatNoDReelNoFlawDDeleteOrAbandon",
                                StoreParms: [{
                                    ParmName: "@iRecNo",
                                    Value: 0
                                },
                                {
                                    ParmName: "@sRecNoStr",
                                    Value: iRecNoStr
                                },
                                {
                                    ParmName: "@iType",
                                    Value: type
                                }
                                ]
                            }
                            var result = SqlStoreProce(jsonobj);
                            if (result != "1") {
                                alert(result);
                            }
                            else {
                                $("#tabCdRec").datagrid("loadData", []);
                                $("#Text6").numberbox("setValue", 0);
                            }
                        }
                    })
                }
            }
        }

        function endOnDefective(type) {
            var showMessage = "";
            if (type == 1)
                showMessage = "次品";
            if (type == 4)
                showMessage = "回修";
            if (type == 2)
                showMessage = "留样";
            if (type == 3) {
                var sqlObjClass = {
                    TableName: "SDOrderDDVatNoDReelNo",
                    Fields: "1",
                    SelectAll: "True",
                    Filters: [
                        {
                            Field: "sBarcodeOld",
                            ComOprt: "=",
                            Value: "'" + sReCheckBarCode + "'",
                            LinkOprt: "and"
                        },
                        {
                            Field: "iCutSample",
                            ComOprt: "=",
                            Value: 0
                        }
                    ]
                }
                var resultClass = SqlGetData(sqlObjClass);
                if (resultClass.length > 0) {
                    alert("该条码已经存在正常卷，无法整卷次品");
                    return false;
                }
                showMessage = "整卷次品";
            }
            /*if (type > 0 && type != 4) {
                $(".sProductRemarkSelectDefective").prop('checked', 'false');
                var sProductRemarkDefectiveID = $("#Text214").val();
                if (sProductRemarkDefectiveID != "" && sProductRemarkDefectiveID != null) {
                    var sProductRemarkDefectiveIDs = sProductRemarkDefectiveID.split(",");
                    for (var i = 0; i < sProductRemarkDefectiveIDs.length; i++) {
                        $("#divShowProductRemarkSelectDefective input:checkbox[value='" + sProductRemarkDefectiveIDs[i] + "']").prop('checked', 'true');
                    }
                }
                $("#selectProductRemarkDefective").attr("onclick", "doDefective('" + showMessage + "'," + type + ")");
                $("#divShowProductRemarkDefective").window("open");
            } else {
                
            }*/
            doDefective(showMessage, type);
        }

        function doDefective(showmessage, type) { 
           /* var sSeletedProductRemarkDefective = $(".sProductRemarkSelectDefective:checked");
            var sProductRemarkDefectiveID = "";
            var sProductRemarkDefectives = "";
            if (sSeletedProductRemarkDefective.length > 0) {
                sProductRemarkDefectiveID = $(sSeletedProductRemarkDefective[0]).val();
                sProductRemarkDefectives = $(sSeletedProductRemarkDefective[0]).parent().text();
                for (var i = 1; i < sSeletedProductRemarkDefective.length; i++) {
                    sProductRemarkDefectiveID += "," + $(sSeletedProductRemarkDefective[i]).val();
                    sProductRemarkDefectives += "," + $(sSeletedProductRemarkDefective[i]).parent().text();
                }
                $("#Text214").val(sProductRemarkDefectiveID);
                $("#textProductRemark").text(sProductRemarkDefectives);
            }*/
            $.messager.confirm("您确定吗？", "<p style='font-size:16px; font-weight:bold;'>您确定要将当前卷作为" + showmessage + "吗？</p>", function (r) {
                if (r) { 
                    $("#divShowProductRemarkDefective").window("close");
                    saveAndPrint(type);
                }
            });
        }

        function saveMs() {

        }
        var clearZeroConfirm = function () {
            var fRecePartQty = $("#Text5").numberbox("getValue");
            fRecePartQty = isNaN(Number(fRecePartQty)) ? 0 : Number(fRecePartQty);
            fRecePartQty = fRecePartQty.toFixed(1);
            if (fRecePartQty > 1) {
                if (MSComm1.PortOpen == false) {
                    OpenPort();
                }
                SendPortMessage("0x54");
                setTimeout("clearZeroConfirm()", 500);
            }
        }

        function saveAndPrint(type) {
            if ($("#form1").form("validate")) {
                //var selectRow = $("#tableSdOrderDD").datagrid("getSelected");
                //if (selectRow) {
                if (iSelectRecNo > 0) {
                    setTimeout(function () {
                        $("#btnSavePrint").attr("disabled", false);
                    }, 5000)
                    dLastTime = new Date();
                    var iRecNo = iSelectRecNo;
                    //var fPartQty = $("#Text5").numberbox("getValue");
                    var fPartQty = fLastPartQty1;
                    var fDeductQty = $("#Text6").numberbox("getValue");
                    fDeductQty = fDeductQty == "" || fDeductQty == null || fDeductQty == undefined ? 0 : fDeductQty;
                    //var fRealQty = $("#Text7").numberbox("getValue");
                    var fRealQty = fLastPartQty1 - fDeductQty;
                    var sCheckPersonID = $("#txbCheckPerson").textbox("getValue");
                    var iBscDataProcessMRecNo = $("#txbSerial").combobox("getValue");
                    var sMachineID = $("#txbMachineID").combobox("getValue");
                    var fWeight = isNaN(Number($("#Text4").numberbox("getValue"))) ? 0 : Number($("#Text4").numberbox("getValue"));
                    var sUserID = userid;
                    var sVatNoD = $("#Text20").textbox("getValue");

                    var sRemark = $("#textProductRemark").text();

                    var iIsNeedReCheckBox = $(".isNeedReCheck:checked");
                    var iIsNeedReCheck = 0;
                    if (iIsNeedReCheckBox.length > 0) {
                        iIsNeedReCheck = 1;
                    }

                    if (iIsNeedReCheck == 1) {
                        var sqlObjCheck = {
                            TableName: "SDOrderDDVatNoDReelNo",
                            Fields: "1",
                            SelectAll: "True",
                            Filters: [
                                {
                                    Field: "iSDOrderDDRecNo",
                                    ComOprt: "=",
                                    Value: iRecNo,
                                    LinkOprt: "and"
                                },
                                {
                                    Field: "iNeedCheck",
                                    ComOprt: "=",
                                    Value: 1
                                }
                            ]
                        }
                        var resultCheck = SqlGetData(sqlObjCheck);
                        if (resultCheck.legnth > 0) {
                            alert("次缸已有标记验布");
                            return false;
                        }
                    }

                    var sPackPersonID = $("#Text212").val();
                    if (sPackPersonID == "" || sPackPersonID == null) {
                        sPackPersonID = "";
                    }

                    if (sPackPersonID == "") {
                        alert("请选择包装工");
                        return false;
                    }

                    var sWorkClass = $("input[name='sWorkClass']:checked").val();

                    fPartQty = isNaN(Number(fPartQty)) ? 0 : Number(fPartQty);
                    if (fPartQty < 5) {
                        if (type == 0) {
                            alert("米数不能小于5");
                            OpenPort();
                            return false;
                        }
                    }
                    var fTmpWeight = isNaN(Number(fWeight)) ? 0 : Number(fWeight);
                    if (fTmpWeight < 1) {
                        if (type == 0) {
                            alert("重量不能小于1");
                            OpenPort();
                            return false;
                        }
                    }

                    $("#btnSavePrint").attr("disabled", true);
                    var allRows1 = $("#tabCdRec").datagrid("getRows");
                    var iRecNoStr = "";
                    for (var i = 0; i < allRows1.length; i++) {
                        iRecNoStr += allRows1[i].iRecNo + ",";
                    }
                    if (iRecNoStr != "") {
                        iRecNoStr = iRecNoStr.substr(0, iRecNoStr.length - 1);
                    }

                    var jsonobj = {
                        StoreProName: "SpVatNoBulidReelNoNew",
                        StoreParms: [{
                            ParmName: "@iSDOrderDDRecNo",
                            Value: iRecNo
                        },
                        {
                            ParmName: "@fPartQty",
                            Value: fPartQty
                        },
                        {
                            ParmName: "@fDeductQty",
                            Value: fDeductQty
                        },
                        {
                            ParmName: "@fRealQty",
                            Value: fRealQty
                        },
                        {
                            ParmName: "@sCheckPersonID",
                            Value: sCheckPersonID
                        },
                        {
                            ParmName: "@sMachineID",
                            Value: sMachineID
                        },
                        {
                            ParmName: "@fWeight",
                            Value: fWeight
                        },
                        {
                            ParmName: "@sUserID",
                            Value: sUserID
                        },
                        {
                            ParmName: "@sRecNoStr",
                            Value: iRecNoStr
                        },
                        {
                            ParmName: "@sVatNoD",
                            Value: "" + sVatNoD + ""
                        },
                        {
                            ParmName: "@sWorkClass",
                            Value: sWorkClass
                        },
                        {
                            ParmName: "@iBscDataProcessMRecNo",
                            Value: iBscDataProcessMRecNo
                        },
                        {
                            ParmName: "@sPackPersonID",
                            Value: sPackPersonID
                        },
                        {
                            ParmName: "@sBarCodeOld",
                            Value: sReCheckBarCode
                        },
                        {
                            ParmName: "@iRepairType",
                            Value: type
                        },
                        {
                            ParmName: "@iIsNeedReCheck",
                            Value: iIsNeedReCheck
                        },
                        {
                            ParmName: "@sRemark",
                            Value: sRemark
                        }   
                        ]
                    }
                    var result = SqlStoreProce(jsonobj);
                    var resultArr = result.split(":");
                    var resultFirst = resultArr[0];
                    var resultMessage = resultArr[1];
                    if (resultFirst == "1") {
                        if (type == 3) {
                            $("#txbOrderNo").textbox("setValue", "");
                            sReCheckBarCode = "";
                        }

                        $("#btnSaveMs").attr("checked", false);
                        $.messager.show({
                            title: '保存成功',
                            msg: '保存成功，正在打印...',
                            showType: null,
                            style: {
                                right: '',
                                top: document.body.scrollTop + document.documentElement.scrollTop,
                                bottom: ''
                            },
                            timeout: 2000
                        });
                        if (MSComm1.PortOpen == false) {
                            OpenPort();
                        }
                        //码表清0
                        //                        SendPortMessage("0x00,0x00,0x00,0x00,0x00,0x00,0x54");
                        SendPortMessage("0x54");

                        setTimeout("clearZeroConfirm()", 500);
                        var sReelNo = resultArr[2];
                        var theSelectRow;
                        if (sReCheckBarCode == "") {
                            var allRowsOrder = $("#tableSdOrderDD").datagrid("getRows");
                            for (var i = 0; i < allRowsOrder.length; i++) {
                                if (iSelectRecNo == allRowsOrder[i].iRecNo) {
                                    theSelectRow = allRowsOrder[i];
                                    break;
                                }
                            }
                            var sReelNoFlag = theSelectRow.sReelNoFlag;

                            var theReelNo = "";
                            var sReelNoPre = theSelectRow.sReelNoPre == null || theSelectRow.sReelNoPre == undefined ? "" : theSelectRow.sReelNoPre;
                            if (sReelNoFlag != "0") {
                                var nextPartReelCount = parseInt(jsright(sReelNo, sReelNoFlag.length)) + 1;
                                sReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + nextPartReelCount).toString(), sReelNoFlag.length);
                            }
                            else {
                                var nextPartReelCount = parseInt(sReelNo) + 1;
                                sReelNo = sReelNoPre + nextPartReelCount.toString();
                            }
                        }
                        $("#Text9").textbox("setValue", sReelNo);
                        $("#Text6").textbox("setValue", null);

                        $("#textProductRemark").text("");
                        $("#Text213").val("");
                        $("#Text214").val("");

                        var sqlObjR = {
                            TableName: "vwSDOrderDDMD",
                            Fields: "iCurtPlanPartReelCount,fReadyPartQtyQty,fOverFlowMeter,fOverFlow,sWeiXinOpenID,sOrderNo,sName,sVatNo,sSerialColorIDName,convert(varchar(20),getdate(),21) curttime",
                            SelectAll: "True",
                            Filters: [
                                {
                                    Field: "iRecNo",
                                    ComOprt: "=",
                                    Value: iSelectRecNo
                                }
                            ]
                        }
                        var resultRR = SqlGetData(sqlObjR);
                        if (resultRR.length > 0) {
                            $("#Text11").textbox("setValue", resultRR[0].iCurtPlanPartReelCount);
                            $("#Text12").textbox("setValue", resultRR[0].fReadyPartQtyQty);

                            var iOverflow = GetUrlParam("iOverflow");
                            var iCurtOverflow = resultRR[0].fOverFlow;
                            iOverflow = isNaN(Number(iOverflow)) ? 0 : Number(iOverflow);
                            iCurtOverflow = isNaN(Number(iCurtOverflow)) ? 0 : Number(iCurtOverflow);
                            
                            if (iOverflow > 0 && iOverflow < iCurtOverflow) {
                                $.messager.alert("验布溢出提示", "<p style='font-size:24px; font-weight:bold;'>已超出来料米数" + iCurtOverflow.toString() + "%</p>");
                         
                                var sqlObjP = {
                                    TableName: "BscDataPerson",
                                    Fields: "sName",
                                    SelectAll: "True",
                                    Filters: [
                                        {
                                            Field: "sCode",
                                            ComOprt: "=",
                                            Value: "'" + userid + "'"
                                        }
                                    ]
                                }
                                var resultPP = SqlGetData(sqlObjP);
                                if (resultPP.length > 0) {
                                    var m = { first: "验布预警", keyword: ["订单号:" + resultRR[0].sOrderNo + " 缸号:" + resultRR[0].sVatNo, "注意:验布米数已超正常范围", "验布米数已超正常范围", "" + resultPP[0].sName, "" + resultRR[0].curttime], remark: "订单号:" + resultRR[0].sOrderNo + " 品名: " + resultRR[0].sName + " 缸号: " + resultRR[0].sVatNo + " 颜色: " + resultRR[0].sSerialColorIDName + " 超出米数: " + resultRR[0].fOverFlowMeter.toString() }


                                    sendWeiXinMessage("8qNuTJgTT52MxldmQoJF8AtAeDLBqPFIGQqN8MHT8fA", resultRR[0].sWeiXinOpenID, m);

                                    var sqlObjP2 = {
                                        TableName: "BscDataPerson",
                                        Fields: "sWeiXinOpenID",
                                        SelectAll: "True",
                                        Filters: [
                                            {
                                                Field: "sJobRole",
                                                ComOprt: "like",
                                                Value: "'%验布负责人%'"
                                            }
                                        ]
                                    }
                                    var resultPP2 = SqlGetData(sqlObjP2); 
                                        for (var i = 0; i < resultPP2.length;i++)
                                            sendWeiXinMessage("8qNuTJgTT52MxldmQoJF8AtAeDLBqPFIGQqN8MHT8fA", resultPP2[i].sWeiXinOpenID, m); 
                                     
                                } 
                            } 
                        } 
                        

                        //                        var iCurtReelCount = $("#Text13").numberbox("getValue");
                        //                        iCurtReelCount = isNaN(Number(iCurtReelCount)) ? 0 : Number(iCurtReelCount);
                        //                        iCurtReelCount += 1;
                        //                        $("#Text13").numberbox("setValue", iCurtReelCount);

                        fLastCutQty = 0.00;
                        var theQtyO = $("#hidQtyO").val();
                        var theQtyN = (isNaN(Number(theQtyO)) ? 0 : Number(theQtyO));
                        totalQty += (isNaN(Number(fRealQty)) ? 0 : Number(fRealQty));
                        $("#txbTodayTotal").numberbox("setValue", totalQty);
                        //                        var fReadyPartQty = isNaN(Number($("#Text12").numberbox("getValue"))) ? 0 : Number($("#Text12").numberbox("getValue"));
                        //                        fReadyPartQty = fReadyPartQty + Number(fRealQty);
                        //                        $("#Text12").numberbox("setValue", fReadyPartQty);
                        var jsonobj = {
                            StoreProName: "SpYieldAdd",
                            StoreParms: [{
                                ParmName: "@sMachineID",
                                Value: sMachineID
                            }, {
                                ParmName: "@sCheckPersonID",
                                Value: sCheckPersonID
                            }, {
                                ParmName: "@fQty",
                                Value: theQtyN
                            }
                            ]
                        }
                        var result11 = SqlStoreProce(jsonobj);
                        iLastSDOrderDDVatNoDReelNoRecNo = resultMessage;
                        if (isOutProduce == 1) {
                            var url = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + 268 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                            $("#ifrpb").attr("src", "");
                            $("#ifrpb").attr("src", url);
                            $("#ifrpb1").attr("src", "");
                            $("#ifrpb1").attr("src", url);
                            /*for (var i = 1; i < iPrintCount; i++) {
                                if ($("#ifrpbNew" + i.toString()).length == 0) {
                                    var frame = document.createElement("iframe");
                                    frame.setAttribute("id", "ifrpbNew" + i.toString());
                                    frame.setAttribute("name", "ifrpbNew" + i.toString());
                                    frame.setAttribute("width", 0);
                                    frame.setAttribute("height", 0);
                                    document.body.appendChild(frame);
                                }
                                var urlNew = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + 192 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                $("#ifrpbNew" + i.toString()).attr("src", "");
                                $("#ifrpbNew" + i.toString()).attr("src", urlNew);
                            }*/
                        } else {
                            if ( type == 2 || type == 3) {
                                if (fPartQty >= 5) {
                                    if (iSamplePrintMoudleRecNo > 0) {
                                        var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iSamplePrintMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                        $("#ifrpb").attr("src", "");
                                        $("#ifrpb").attr("src", url1);
                                    }
                                }
                            } else if (type == 1 || type == 4) {
                                if (fPartQty >= 5) {
                                    var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + 345 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                    $("#ifrpb").attr("src", "");
                                    $("#ifrpb").attr("src", url1);
                                }
                            } else {
                                var url = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                $("#ifrpb").attr("src", "");
                                $("#ifrpb").attr("src", url);
                                for (var i = 1; i < iPrintCount; i++) {
                                    if ($("#ifrpbNew" + i.toString()).length == 0) {
                                        var frame = document.createElement("iframe");
                                        frame.setAttribute("id", "ifrpbNew" + i.toString());
                                        frame.setAttribute("name", "ifrpbNew" + i.toString());
                                        frame.setAttribute("width", 0);
                                        frame.setAttribute("height", 0);
                                        document.body.appendChild(frame);
                                    }
                                    var urlNew = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                    $("#ifrpbNew" + i.toString()).attr("src", "");
                                    $("#ifrpbNew" + i.toString()).attr("src", urlNew);
                                }

                                if (iPrintMoudleRecNo2 > 0) {
                                    var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo2 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                    $("#ifrpb1").attr("src", "");
                                    $("#ifrpb1").attr("src", url1);
                                }

                                if (iPrintMoudleRecNo3 > 0) {
                                    var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo3 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                    $("#ifrpb2").attr("src", "");
                                    $("#ifrpb2").attr("src", url1);
                                    for (var i = 1; i < iPrintCount3; i++) {
                                        if ($("#ifrpbNewA" + i.toString()).length == 0) {
                                            var frame = document.createElement("iframe");
                                            frame.setAttribute("id", "ifrpbNewA" + i.toString());
                                            frame.setAttribute("name", "ifrpbNewA" + i.toString());
                                            frame.setAttribute("width", 0);
                                            frame.setAttribute("height", 0);
                                            document.body.appendChild(frame);
                                        }
                                        var urlNew = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo3 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                        $("#ifrpbNewA" + i.toString()).attr("src", "");
                                        $("#ifrpbNewA" + i.toString()).attr("src", urlNew);
                                    }
                                }

                                if (iPrintMoudleRecNo4 > 0) {
                                    var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo4 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                    $("#ifrpb3").attr("src", "");
                                    $("#ifrpb3").attr("src", url1);
                                    for (var i = 1; i < iPrintCount4; i++) {
                                        if ($("#ifrpbNewB" + i.toString()).length == 0) {
                                            var frame = document.createElement("iframe");
                                            frame.setAttribute("id", "ifrpbNewB" + i.toString());
                                            frame.setAttribute("name", "ifrpbNewB" + i.toString());
                                            frame.setAttribute("width", 0);
                                            frame.setAttribute("height", 0);
                                            document.body.appendChild(frame);
                                        }
                                        var urlNew = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo4 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                        $("#ifrpbNewB" + i.toString()).attr("src", "");
                                        $("#ifrpbNewB" + i.toString()).attr("src", urlNew);
                                    }
                                }

                                if (iPrintMoudleRecNo5 > 0) {
                                    var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo5 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                    $("#ifrpb4").attr("src", "");
                                    $("#ifrpb4").attr("src", url1);
                                    for (var i = 1; i < iPrintCount5; i++) {
                                        if ($("#ifrpbNewC" + i.toString()).length == 0) {
                                            var frame = document.createElement("iframe");
                                            frame.setAttribute("id", "ifrpbNewC" + i.toString());
                                            frame.setAttribute("name", "ifrpbNewC" + i.toString());
                                            frame.setAttribute("width", 0);
                                            frame.setAttribute("height", 0);
                                            document.body.appendChild(frame);
                                        }
                                        var urlNew = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo5 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                        $("#ifrpbNewC" + i.toString()).attr("src", "");
                                        $("#ifrpbNewC" + i.toString()).attr("src", urlNew);
                                    }
                                }

                                if (iPackPrintMoudleRecNo > 0) {
                                    var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPackPrintMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                    $("#ifrpb5").attr("src", "");
                                    $("#ifrpb5").attr("src", url1);
                                    for (var i = 1; i < iPackPrintCount; i++) {
                                        if ($("#ifrpbNeww" + i.toString()).length == 0) {
                                            var frame = document.createElement("iframe");
                                            frame.setAttribute("id", "ifrpbNeww" + i.toString());
                                            frame.setAttribute("name", "ifrpbNeww" + i.toString());
                                            frame.setAttribute("width", 0);
                                            frame.setAttribute("height", 0);
                                            document.body.appendChild(frame);
                                        }
                                        var urlNew = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPackPrintMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                        $("#ifrpbNeww" + i.toString()).attr("src", "");
                                        $("#ifrpbNeww" + i.toString()).attr("src", urlNew);

                                    }
                                }
                            }
                        }
                        $("#tabCdRec").datagrid("loadData", []);
                        var sqlObjCut = {
                            TableName: "SDSendD a inner join pbReportData aa on a.iSamplePrintModuleRecNo=aa.iRecNo inner join SDSendM b on a.iMainRecNo=b.iRecNo and b.iStatus>3 and b.iBillType=0 inner join SDOrderD d on a.iSDOrderDRecNo=d.iRecNo inner join SDOrderDD e on e.iMainRecNo=d.iRecNo left join SDOrderDDCutD as f on a.iRecNo=f.iSDSendDRecNo and e.iRecNo=f.iMainRecNo ",
                            Fields: "a.iRecNo,sSumQty=convert(varchar(10),isnull(a.fSumQty,0)),isnull(iSamplePrintModuleRecNo,0) iSamplePrintModuleRecNo,isnull(iSamplePrintCount,0) iSamplePrintCount,b.iCutType,a.iSDOrderDDRecNo,a.iCutSample,e.iSamplePrinted,f.iCut",
                            SelectAll: "True",
                            Filters: [
                                {
                                    Field: "b.iStatus",
                                    ComOprt: "=",
                                    Value: "4",
                                    LinkOprt: "and"
                                },
                                //{
                                //    Field: "b.sOutType",
                                //    ComOprt: "=",
                                //    Value: "'车间'",
                                //    LinkOprt: "and"
                                //},
                                {
                                    Field: "e.iRecNo",
                                    ComOprt: "=",
                                    Value: iRecNo
                                }]
                        }
                        var resultCut = SqlGetData(sqlObjCut);
                        if (resultCut.length > 0) {
                            var iNeedCount = 0;
                            for (var i = 0; i < resultCut.length; i++) {
                                var iCutType = resultCut[i].iCutType;
                                if (iCutType == "0") {
                                    if (resultCut[i].iSDOrderDDRecNo == iRecNo) {
                                        if (resultCut[i].iCutSample == "1")
                                            continue;
                                        iNeedCount++;
                                    }
                                } else if (iCutType == "1") {
                                    if (resultCut[i].iCutSample == "1")
                                        continue;
                                    iNeedCount++;
                                } else if (iCutType == "2") {
                                    if (resultCut[i].iCut == "1")
                                        continue;
                                    iNeedCount++;
                                }
                            }
                            if (iNeedCount > 0) {
                                $("#cutRemark").html("需剪样"); 
                                $("#btnSamplePrint").css("background-color", "red");
                                $("#btnSamplePrint").val("剪样" + iNeedCount);
                                $("#btnSamplePrint").prop("disabled", false);
                            }
                            else {
                                $("#cutRemark").html("");
                                $("#btnSamplePrint").val("剪样");
                                $("#btnSamplePrint").css("background-color", "transparent");
                                $("#btnSamplePrint").prop("disabled", true);
                            }
                        } else {
                            $("#cutRemark").html("");
                            $("#btnSamplePrint").val("剪样");
                            $("#btnSamplePrint").css("background-color", "transparent");
                            $("#btnSamplePrint").prop("disabled", true);
                        }
                    }
                    else {
                        alert(resultMessage);
                    }
                }
                else {
                    //alert("请先选择订单！");
                    MessageShow("请先选择订单", "请先选择订单!");
                    return false;
                }
                setTimeout(function () {
                    $("#btnSavePrint").attr("disabled", false);
                }, 5000)
            }
        }
        function finishPart() {
            //var selectRow = $("#tableSdOrderDD").datagrid("getSelected");
            if (iSelectRecNo > 0) {
                $.messager.confirm("您确定结束验布吗？", "您确定结束验布吗?", function (r) {
                    if (r) {
                        var jsonobj = {
                            StoreProName: "SpVatNoPartFinishNew",
                            StoreParms: [{
                                ParmName: "@iSDOrderDDRecNo",
                                Value: iSelectRecNo
                            }, {
                                ParmName: "@sUserID",
                                Value: userid
                            }
                            ]
                        }
                        var result = SqlStoreProce(jsonobj);
                        switch (result) {
                            case "0":
                                {
                                    alert("此缸号布已经结束或尚未开始");
                                } break;
                            case "1":
                                {
                                    MessageShow("操作成功", "验布结束成功");
                                    var lastMachine = $("#txbMachineID").combobox("getValue");
                                    $("#form1").form("reset");
                                    $("#Text212").val("");
                                    $("#textProductRemark").text("");
                                    $("#Text213").val("");
                                    $("#Text214").val("");
                                    $("#txbMachineID").combobox("setValue", lastMachine);
                                    $("#txbCheckPerson").combobox("setValue", userid);
                                } break;
                            case "2":
                                {
                                    //有重打的直接打印
                                    var orderAllRows = $("#tableSdOrderDD").datagrid("getRows");
                                    /*for (var i = 0; i < orderAllRows.length; i++) {
                                        if (orderAllRows[i].iRecNo == iSelectRecNo) {
                                            //先打印调整列表
                                            var iSDOrderMRecNo = orderAllRows[i].iSdContractMRecNo;
                                            var iSDOrderDRecNo = orderAllRows[i].iSdContractDRecNo;
                                            var url = "/Base/PbPage.aspx?otype=print&iformid=20025&irecno=101&key=0&pb_iTheSDOrderMRecNo=" + iSDOrderMRecNo + "&pb_iTheiSDOrderDRecNo=" + iSDOrderDRecNo + "&r=" + Math.random();
                                            $("#ifrpb").attr("src", "");
                                            $("#ifrpb").attr("src", url);
                                            //获取全部重打的数据。一个个打印
                                            var sqlObjRemind = {
                                                TableName: "SDOrderDDVatNoRemind",
                                                Fields: "iSDOrderDDVatNoDReelNoRecNo",
                                                SelectAll: "True",
                                                Filters: [
                                                    {
                                                        Field: "iSdOrderMRecNo",
                                                        ComOprt: "=",
                                                        Value: "'" + iSDOrderMRecNo + "'",
                                                        LinkOprt: "and"
                                                    },
                                                    {
                                                        Field: "iSdOrderDRecNo",
                                                        ComOprt: "=",
                                                        Value: "'" + iSDOrderDRecNo + "'"
                                                    }
                                                ]
                                            }
                                            var resultRemind = SqlGetData(sqlObjRemind);
                                            if (resultRemind.length > 0) {
                                                for (var i = 0; i < resultRemind.length; i++) {
                                                    var url = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo + "&key=" + resultRemind[i].iSDOrderDDVatNoDReelNoRecNo + "&copies=" + iPrintCount + "&r=" + Math.random();
                                                    $("#ifrpb1").attr("src", "");
                                                    $("#ifrpb1").attr("src", url);
                                                    //                                                    var max = 0;
                                                    //                                                    for (var i = 0; i < iPrintCount; i++) {
                                                    //                                                        var url = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo + "&key=" + resultRemind[i].iSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                                    //                                                        var thefr = document.getElementById("ifrpb" + i.toString());
                                                    //                                                        if (thefr) {
                                                    //                                                            $("#ifrpb" + i.toString()).attr("src", "");
                                                    //                                                            $("#ifrpb" + i.toString()).attr("src", url);
                                                    //                                                        }
                                                    //                                                        else {
                                                    //                                                            if (max == 0) {
                                                    //                                                                max = i;
                                                    //                                                            }
                                                    //                                                            $("#ifrpb" + (i - max).toString()).attr("src", "");
                                                    //                                                            $("#ifrpb" + (i - max).toString()).attr("src", url);
                                                    //                                                        }
                                                    //                                                    }
                                                }
                                            }
                                            break;
                                        }
                                    }
                                    MessageShow("操作成功", "验布结束成功，<span style='color:red;font-size:14px;font-weight:bold;'>调整卷号已打印，请及时更换</span>");*/
                                } break;
                            case "3":
                                {
                                    alert("操作失败，发生未知错误");
                                } break;
                        }
                    }
                })
            }
            else {
                alert("请先选择订单！");
                return false;
            }
        }
        function MessageShow(title, message) {
            $.messager.show({
                title: title,
                msg: message,
                showType: 'none',
                style: {
                    right: '',
                    top: document.body.scrollTop + document.documentElement.scrollTop,
                    bottom: ''
                },
                timeout: 2000
            });
        }

        function OpenPort() {
            if (MSComm1.PortOpen == false) {
                MSComm1.PortOpen = true;
                $("#btnOpenOrClose").val("断开码表");
                // $("#btnSaveMs").val("暂停");
            }
            else {
                //window.alert("已经开始接收数据!");
            }
            isPortOpen = true;
        }
        function OpenPort2() {
            if (MSComm2.PortOpen == false) {
                MSComm2.PortOpen = true;
                //$("#btnOpenOrClose").val("断开验布机");
                //$("#btnSaveMs").val("暂停");
            }
            else {
                //window.alert("已经开始接收数据!");
            }
            isPortOpen2 = true;
        }

        function ClosePort() {
            if (MSComm1.PortOpen == true) {
                MSComm1.PortOpen = false;
                $("#btnOpenOrClose").val("连接码表");
                //$("#btnSaveMs").val("开始");
            }
            else {
                //window.alert("已经开始接收数据!");
            }
            isPortOpen = false;
        }
        function ClosePort2() {
            if (MSComm2.PortOpen == true) {
                MSComm2.PortOpen = false;
                //$("#btnOpenOrClose").val("连接验布机");
                //$("#btnSaveMs").val("开始");
            }
            else {
                //window.alert("已经开始接收数据!");
            }
            isPortOpen2 = false;
        }
        function CloseOrOpenPort() {
            if (MSComm1.PortOpen == true) {
                MSComm1.PortOpen = false;
                isPortOpen = false;
                $("#btnOpenOrClose").val("连接码表");
                //$("#btnSaveMs").val("开始");
            }
            else {
                MSComm1.PortOpen = true;
                isPortOpen = true;
                $("#btnOpenOrClose").val("断开码表");
                //$("#btnSaveMs").val("暂停");
            }
        }
        function CloseOrOpenPort2() {
            if (MSComm2.PortOpen == true) {
                MSComm2.PortOpen = false;
                isPortOpen2 = false;
            }
            else {
                MSComm2.PortOpen = true;
                isPortOpen2 = true;
            }
        }

        function setPerimeter() {
            if (iNewBscDataMatRecNo == 0) {
                alert("请先选择产品");
                return false;
            }
            var sMachineIDTmp = $("#txbMachineID").combobox("getValue");
            if (sMachineIDTmp == "" || sMachineIDTmp == 0 || sMachineIDTmp == null || sMachineIDTmp == undefined) {
                alert("请先选择机台");
                return false;
            }
            var sqlObj = {
                TableName: "bscDataMatDMachineParam",
                Fields: "top 1 isnull(sCodeTable,'') sCodeTable,convert(varchar(20),isnull(fPerimeter,0)) fPerimeter,isnull(sRemark,'') sRemark",
                SelectAll: "True",
                Filters: [
                    {
                        Field: "sMachineID",
                        ComOprt: "=",
                        Value: "'" + sMachineIDTmp + "'",
                        LinkOprt: "and"
                    },
                    {
                        Field: "iProductWidth",
                        ComOprt: "=",
                        Value: iNewProductWidth,
                        LinkOprt: "and"
                    },
                    {
                        Field: "iProductWeight",
                        ComOprt: "=",
                        Value: iNewProductWeight,
                        LinkOprt: "and"
                    }, 
                    {
                        Field: "iMainRecNo",
                        ComOprt: "=",
                        Value: iNewBscDataMatRecNo
                    }]
            }
            var result = SqlGetData(sqlObj);
            if (result.length > 0) {
                $("#txbSetPerimeter").numberbox("setValue", result[0].fPerimeter);
            } else {
                $("#txbSetPerimeter").numberbox("setValue", 0);
            }
            $('#divSetPerimeter').dialog('open');
        }

        function savePerimeter() {
            var fPerimeter = $("#txbSetPerimeter").numberbox("getValue");
            if (fPerimeter == null || fPerimeter == 0) {
                alert("请设置周长");
                return false;
            }
            var sMachineIDTmp = $("#txbMachineID").combobox("getValue");

            var jsonobj = {
                StoreProName: "SpSetPerimeter",
                StoreParms: [{
                    ParmName: "@sMachineID",
                    Value: sMachineIDTmp
                }, {
                    ParmName: "@iBscDataMatRecNo",
                    Value: iNewBscDataMatRecNo
                }, {
                    ParmName: "@iProductWidth",
                    Value: iNewProductWidth
                }, {
                    ParmName: "@iProductWeight",
                    Value: iNewProductWeight
                }, {
                    ParmName: "@fPerimeter",
                    Value: fPerimeter
                }, {
                    ParmName: "@sUserID",
                    Value: userid
                }]
            }
         

            var result11 = SqlStoreProce(jsonobj);
            if (result11.length > 0) {
                $("#btnPerimeter").val("周长: " + fPerimeter.toString());
                $('#divSetPerimeter').dialog('close');
            }
        }

        function openSetPort() {
            var portCookie = getCookie("mscomm32_port" + machine);
            var machineID = getCookie("machineID" + machine);
            var portCookie2 = getCookie("mscomm32_port2" + machine);
            var iProcessMRecNo = getCookie("serial" + machine);
            //var machineID2 = getCookie("machineID2" + machine);
            if (portCookie != null) {
                $("#txbCommPort").numberspinner("setValue", portCookie);
            }
            if (machineID != null) {
                $("#txbMachineID").combobox("setValue", machineID);
            }
            if (portCookie2 != null) {
                $("#txbCommPort2").numberspinner("setValue", portCookie2);
            }
            if (iProcessMRecNo != null) {
                $("#txbSerial").combobox("setValue", iProcessMRecNo);
            }
            $("#divCommPort").dialog("open");
        }
        function savePort() {
            var port = $("#txbCommPort").numberspinner("getValue");
            var machineID = $("#txbMachineID").combobox("getValue");
            var port2 = $("#txbCommPort2").numberspinner("getValue");
            var iBscDataProcessMRecNo = $("#txbSerial").combobox("getValue");
            if (port == null || port == undefined || port == "") {
                alert("验布机端口号不能为空");
                return;
            }
            if (machineID == null || machineID == undefined || machineID == "") {
                alert("机台号不能为空");
                return;
            }
            if (port2 == null || port2 == undefined || port2 == "") {
                alert("称重机端口号不能为空");
                return;
            }
            if (MSComm1.PortOpen == true) {
                MSComm1.PortOpen = false;
            }
            if (MSComm2.PortOpen == true) {
                MSComm2.PortOpen = false;
            }
            setCookie("mscomm32_port" + machine, port, "d36500");
            setCookie("machineID" + machine, machineID, "d36500");
            setCookie("mscomm32_port2" + machine, port2, "d36500");
            setCookie("serial" + machine, iBscDataProcessMRecNo, "d36500");
            window.location.reload();
            $("#divCommPort").dialog("close");
        }
        function portCancel() {
            $("#divCommPort").dialog("close");
        }
        function SendPortMessage(comm) {
            var cmd_send = "";
            var result = comm;
            var results = result.split(',');
            for (var i = 0; i < results.length; i++) {
                cmd_send += String.fromCharCode(eval(results[i]));
            }
            if (MSComm1.PortOpen == false) {
                window.alert("串口已经关闭!!");
            }
            else {
                MSComm1.Output = cmd_send; //发送命令
            }
        }

        function previewNext() {
            if ($("#form1").form("validate")) {
                if (iSelectRecNo > 0) {
                    var url = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo + "&key=1&copies=1&r=" + Math.random();
                    $("#ifrpb").attr("src", "");
                    $("#ifrpb").attr("src", url);
                }
                else {
                    alert("请先选择订单");
                }
            }
        }
        function flawWindowClose() {
            var sReason = $("#txbFlawReason").textbox("getValue");
            if (sReason.substr(0, 2) == "11") {
                //fLastCutQty = fDeductQty;
                targetTxt = "Text5";
                OpenPort();
                isPingOpen = false;
            }
        }

        function BarcodeScan() {
            if (event.keyCode == 13) {
                var barcode = $("#txbOrderNo").textbox("getValue");
                if (barcode != "") {
                    var filters = [
                        {
                            Field: "b.iRepair",
                            ComOprt: "=",
                            Value: "0",
                            LinkOprt: "and"
                        },
                        {
                            Field: "b.iType",
                            ComOprt: "=",
                            Value: "0",
                            LinkOprt: "and"
                        },
                        {
                            Field: "b.sBarcode",
                            ComOprt: "=",
                            Value: "'" + barcode + "'"
                        }
                    ];

                    var sqlObj = {
                        TableName: "vwSDOrderDDMD as a inner join SDOrderDDVatNoDReelNo b on a.iRecNo=b.iSDOrderDDRecNo",
                        Fields: "a.*,sVatNoD = isnull(a.sVatNoDye,''),b.sBarCode as sReCheckBarCode,sCurtPartReelNo2=isnull(b.sReelNo,'')",
                        SelectAll: "True",
                        Filters: filters
                    }

                    //var result = SqlGetData(sqlObj);
                    var data = SqlGetData(sqlObj);
                    if (data.length > 0) {
                        var sqlStockObj = {
                            TableName: "MMStockQty",
                            Fields: "1",
                            SelectAll: "True",
                            Filters: [{
                                Field: "sBarcode",
                                ComOprt: "=",
                                Value: "'" + barcode + "'"
                            }]
                        }
                        var dataStock = SqlGetData(sqlStockObj);

                        if (dataStock.length > 0) {
                            MessageShow("<span style='font-size:14px;font-weight:bold;color:red;'>条码在库存</span>", "<span style='font-size:18px;font-weight:bold;color:red;'>条码还在库存，请先领出</span>");
                            $("#txbOrderNo").textbox("setValue", "");
                            $($("#txbOrderNo").textbox("textbox")).focus();
                            stopBubble($("#txbOrderNo")[0]);
                            return false;
                        }

                        if (GetUrlParam("iSendCut") == "1") {
                            var sqlObjCut = {
                                TableName: "SDSendD a inner join pbReportData aa on a.iSamplePrintModuleRecNo=aa.iRecNo inner join SDSendM b on a.iMainRecNo=b.iRecNo and b.iStatus>3 and b.iBillType=0 inner join SDOrderD d on a.iSDOrderDRecNo=d.iRecNo inner join SDOrderDD e on e.iMainRecNo=d.iRecNo left join SDOrderDDCutD as f on a.iRecNo=f.iSDSendDRecNo and e.iRecNo=f.iMainRecNo ",
                                Fields: "a.iRecNo,sSumQty=convert(varchar(10),isnull(a.fSumQty,0)),isnull(iSamplePrintModuleRecNo,0) iSamplePrintModuleRecNo,isnull(iSamplePrintCount,0) iSamplePrintCount,b.iCutType,a.iSDOrderDDRecNo,a.iCutSample,e.iSamplePrinted,f.iCut",
                                SelectAll: "True",
                                Filters: [
                                    {
                                        Field: "b.iStatus",
                                        ComOprt: "=",
                                        Value: "4",
                                        LinkOprt: "and"
                                    },
                                    //{
                                    //    Field: "b.sOutType",
                                    //    ComOprt: "=",
                                    //    Value: "'车间'",
                                    //    LinkOprt: "and"
                                    //},
                                    {
                                        Field: "e.iRecNo",
                                        ComOprt: "=",
                                        Value: data[0].iRecNo
                                    }]
                            }
                            var resultCut = SqlGetData(sqlObjCut);
                            if (resultCut.length > 0) {
                                var iNeedCount = 0;
                                for (var i = 0; i < resultCut.length; i++) {
                                    var iCutType = resultCut[i].iCutType;
                                    if (iCutType == "0") {
                                        if (resultCut[i].iSDOrderDDRecNo == selectRow.iRecNo) {
                                            if (resultCut[i].iCutSample == "1")
                                                continue;
                                            var disabled = resultCut[i].iCutSample == "1" ? "disabled:'disabled'" : "";
                                            $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                                            iNeedCount++;
                                        }
                                    } else if (iCutType == "1") {
                                        if (resultCut[i].iCutSample == "1")
                                            continue;
                                        $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                                        iNeedCount++;
                                    } else if (iCutType == "2") {
                                        if (resultCut[i].iCut == "1")
                                            continue;
                                        $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                                        iNeedCount++;
                                    }
                                }
                                if (iNeedCount > 0) {
                                    $("#cutRemark").html("需剪样");
                                    $("#btnSamplePrint").css("background-color", "red");
                                    $("#btnSamplePrint").val("剪样" + iNeedCount);

                                    $("#btnSamplePrint").prop("disabled", false);
                                }
                                else {
                                    $("#cutRemark").html("");
                                    $("#btnSamplePrint").val("剪样");
                                    $("#btnSamplePrint").css("background-color", "transparent");
                                    $("#btnSamplePrint").prop("disabled", true);
                                }
                            } else {
                                $("#cutRemark").html("");
                                $("#btnSamplePrint").val("剪样");
                                $("#btnSamplePrint").css("background-color", "transparent");
                                $("#btnSamplePrint").prop("disabled", true);
                            }
                        }
                        else {
                            $("#btnSamplePrint").prop("disabled", false);
                        }

                        iNewBscDataMatRecNo = data[0].iBscDataMatRecNo;
                        iNewProductWidth = data[0].fProductWidth;
                        iNewProductWeight = data[0].fProductWeight;
                        var sNewCodeFull = data[0].sCodeFull;
                        var sMachineIDTmp = $("#txbMachineID").combobox("getValue");
                        if (iNewBscDataMatRecNo != iLastBscDataMatRecNo) {
                            var sqlObj = {
                                TableName: "bscDataMatDMachineParam",
                                Fields: "isnull(sCodeTable,'') sCodeTable,convert(varchar(20),isnull(fPerimeter,0)) fPerimeter,isnull(sRemark,'') sRemark",
                                SelectAll: "True",
                                Filters: [
                                    {
                                        Field: "sMachineID",
                                        ComOprt: "=",
                                        Value: "'" + sMachineIDTmp + "'",
                                        LinkOprt: "and"
                                    },
                                    {
                                        Field: "iProductWidth",
                                        ComOprt: "=",
                                        Value: iNewProductWidth,
                                        LinkOprt: "and"
                                    },
                                    {
                                        Field: "iProductWeight",
                                        ComOprt: "=",
                                        Value: iNewProductWeight,
                                        LinkOprt: "and"
                                    }, 
                                    {
                                        Field: "iMainRecNo",
                                        ComOprt: "=",
                                        Value: iNewBscDataMatRecNo
                                    }]
                            }
                            var result = SqlGetData(sqlObj);
                            if (result.length > 0) {
                                $("#btnPerimeter").val("周长: " + result[0].fPerimeter);
                                $.messager.alert("码表更新提示", "<p style='font-size:24px; font-weight:bold;'>产品名称: " + sNewCodeFull + "</p><p style='font-size:24px;font-weight:bold;'>机台号: " + sMachineIDTmp + "</p><p style='font-size:24px;font-weight:bold;'>周长: " + result[0].fPerimeter + "</p><p style='font-size:24px;font-weight:bold;'>备注: " + result[0].sRemark + "</p>");
                            } else {
                                $("#btnPerimeter").val("周长");
                            }
                        }
                        $("#cutRemark").html("");
                        $("#btnSamplePrint").prop("disabled", true);
                        $("#btnWholeDefective").prop("disabled", false);
                        sReCheckBarCode = data[0].sReCheckBarCode;
                        isOutProduce = data[0].isOutProduce;
                        iSelectRecNo = data[0].iRecNo;
                        iLastBscDataMatRecNo = data[0].iBscDataMatRecNo;
                        iPrintMoudleRecNo = data[0].iPrintMoudleRecNo;
                        iPrintMoudleRecNo2 = data[0].iPrintMoudleRecNo2;
                        iPrintMoudleRecNo3 = data[0].iPrintMoudleRecNo3;
                        iPrintMoudleRecNo4 = data[0].iPrintMoudleRecNo4;
                        iPrintMoudleRecNo5 = data[0].iPrintMoudleRecNo5;
                        iSamplePrintCount = data[0].iSamplePrintCount;
                        iSamplePrintMoudleRecNo = data[0].iSamplePrintMoudleRecNo;
                        iPackPrintMoudleRecNo = data[0].iPackPrintMoudleRecNo;
                        iPackPrintCount = isNaN(Number(data[0].iPackPrintCount)) ? 1 : Number(data[0].iPackPrintCount);
                        var sUserName = data[0].sUserName;
                        var dSDContractDate = data[0].dSDContractDate;
                        $('#sUserName').html("业务员：" + sUserName);
                        $('#dSDContractDate').html(dSDContractDate);
                        iPrintCount = isNaN(Number(data[0].iPrintCount)) ? 1 : Number(data[0].iPrintCount);
                        iPrintCount3 = isNaN(Number(data[0].iPrintCount3)) ? 1 : Number(data[0].iPrintCount3);
                        iPrintCount4 = isNaN(Number(data[0].iPrintCount4)) ? 1 : Number(data[0].iPrintCount4);
                        iPrintCount5 = isNaN(Number(data[0].iPrintCount5)) ? 1 : Number(data[0].iPrintCount5);
                        iSamplePrintMoudleRecNo = isNaN(Number(data[0].iSamplePrintMoudleRecNo)) ? 1 : Number(data[0].iSamplePrintMoudleRecNo);
                        sUnitID = data[0].sUnitID;

                        $("#btnSavePrint").attr("disabled", false);

                        //根据订单设置码表单位
                        /* if (sUnitID == "M") {
                             //                    SendPortMessage("0x00,0x00,0x00,0x00,0x00,0x00,0x4D");
                             SendPortMessage("0x4D");
                         }
                         else if (sUnitID == "Y") {
                             //                    SendPortMessage("0x00,0x00,0x00,0x00,0x00,0x00,0x59");
                             SendPortMessage("0x59");
                         }*/
                        $("#form1").form("load", data[0]);
                        if (data[0].iAllowVatNoReelNoDiscontinuities == "1") {
                            $("#trDis").show();
                        }
                        else {
                            $("#trDis").hide();
                        }

                        $("img").attr("src", data[0].sImageUrl);
                        var codeFull = data[0].sCodeFull;
                        if (codeFull != lastMatCode) {
                            var sMachineID = getCookie("machineID");
                            var sCode = data[0].sCode;
                            var sqlObjMat = {
                                TableName: "bscDataMatDMachineParam",
                                Fields: "sParams",
                                SelectAll: "True",
                                Filters: [
                                    {
                                        Field: "iMainRecNo",
                                        ComOprt: "=",
                                        Value: "(select top 1 iRecNo from bscDataMat where sCode='" + sCode + "')",
                                        LinkOprt: "and"
                                    },
                                    {
                                        Field: "sMachineID",
                                        ComOprt: "=",
                                        Value: "'" + sMachineID + "'"
                                    }
                                ]
                            }
                            var resultMatParam = SqlGetData(sqlObjMat);
                            if (resultMatParam.length > 0) {
                                $.messager.alert("请设置机台参数", "<span style='font-size:20px;font-weight:bold;color:blue;'>请设置机台参数：</span><span style='font-size:20px;font-weight:bold;color:red;'>" + resultMatParam[0].sParams + "</span>");
                            }
                            lastMatCode = codeFull;
                        }

                        var sReelNoFlag = data[0].sReelNoFlag;
                        var theReelNo = "";
                        var sReelNoPre = data[0].sReelNoPre == null || data[0].sReelNoPre == undefined ? "" : data[0].sReelNoPre;
                        if (data[0].iCurtPartReelCount == 0 || data[0].iCurtPartReelCount == null || data[0].iCurtPartReelCount == undefined) {
                            if (sReelNoFlag != "0" && sReelNoFlag != null) {
                                theReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + 1).toString(), sReelNoFlag.length);
                            }
                            else {
                                theReelNo = sReelNoPre + "1";
                            }
                        }
                        else {
                            var nextPartReelCount = parseInt(data[0].iCurtPartReelCount) + 1;
                            if (sReelNoFlag != "0") {
                                theReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + nextPartReelCount).toString(), sReelNoFlag.length);
                            }
                            else {
                                theReelNo = sReelNoPre + nextPartReelCount.toString();
                            }
                        }
                        $("#Text9").textbox("setValue", data[0].sCurtPartReelNo2);
                        $("#txaCoilingAsk").val(data[0].sCoilingAsk);
                        $("#txaCheckStand").val(data[0].sCheckStand);
                        $("#txaShippingMark").val(data[0].sShippingMark);
                        // $("#txaDetailProduceAsk").val(selectRow.sProduceAsk);
                        $("#txaDetailSpecAsk").val(data[0].sSpecAsk);
                        $("#txaDetailCoilingAsk").val(data[0].sCoilingAsk);
                        $("#txaDetailCheckStand").val(data[0].sCheckStand);
                        $("#txaDetailSampleCloth").val(data[0].sSampleCloth);
                        $("#txaDetailStackAsk").val(data[0].sStackAsk);
                        $("#txaDetailShippingMark").val(data[0].sShippingMark);

                        $("#tablePackDetail").empty();
                        var sqlGetSDContractDPackD = {
                            TableName: "SDContractDPackD",
                            Fields: "*",
                            SelectAll: "True",
                            Filters: [
                                {
                                    Field: "iMainRecNo",
                                    ComOprt: "=",
                                    Value: data[0].iSDContractDMatAskRecNo
                                }
                            ]
                        }
                        var resultSDContractDPackD = SqlGetData(sqlGetSDContractDPackD);
                        if (resultSDContractDPackD.length > 0) {
                            for (var i = 0; i < resultSDContractDPackD.length; i++) {
                                var c = "";
                                c = "<tr><td style='height:60px'>" + (resultSDContractDPackD[i].sClassName ? resultSDContractDPackD[i].sClassName : "") + ": " + (resultSDContractDPackD[i].sMatName ? resultSDContractDPackD[i].sMatName : "") + "</td>";
                                c += "<td>数量: " + (resultSDContractDPackD[i].fQty ? resultSDContractDPackD[i].fQty : "").toString() + "</td>";
                                c += "<td>规格: " + resultSDContractDPackD[i].sSpec + "</td></tr>";
                                $("#tablePackDetail").append(c);
                            }
                        }


                        var sqlGetIMG = {
                            TableName: "FileUplad",
                            Fields: "iFormID,sTableName,iTableRecNo,sImageID,sYearMonth,sFileName",
                            SelectAll: "True",
                            Filters: [
                                {
                                    Field: "sTableName",
                                    ComOprt: "=",
                                    Value: "'SDContractM'",
                                    LinkOprt: "and"
                                },
                                {
                                    Field: "iTableRecNo",
                                    ComOprt: "=",
                                    Value: data[0].iSdContractMRecNo
                                }
                            ]
                        }
                        var result = SqlGetData(sqlGetIMG);
                        if (result.length > 0) {
                            $("#imgMainImage").attr("src", "../../Base/imageUpload/images/" + result[0].sYearMonth + "/" + result[0].iFormID + "_" + result[0].sTableName + "_" + result[0].iTableRecNo + "_" + result[0].sImageID + "_" + result[0].sFileName);
                        } else {
                            $("#imgMainImage").attr("src", "");
                        }
                        $("#txbOrderNo").textbox("setValue", barcode);
                    }
                    else {
                        MessageShow("<span style='font-size:14px;font-weight:bold;color:red;'>条码不存在</span>", "<span style='font-size:18px;font-weight:bold;color:red;'>条码对应的验布记录不存在</span>");
                        $("#txbOrderNo").textbox("setValue", "");
                        $($("#txbOrderNo").textbox("textbox")).focus();
                        stopBubble($("#txbOrderNo")[0]);
                    }
                }
            }
        }

        function stopBubble(e) {
            // 如果传入了事件对象，那么就是非ie浏览器
            if (e && e.stopPropagation) {
                //因此它支持W3C的stopPropagation()方法
                e.stopPropagation();
            } else {
                //否则我们使用ie的方法来取消事件冒泡
                window.event.cancelBubble = true;
            }
        }
        function pagerFilter(data) {
            if (typeof data.length == 'number' && typeof data.splice == 'function') {    // 判断数据是否是数组
                data = {
                    total: data.length,
                    rows: data
                }
            }
            var dg = $(this);
            var opts = dg.datagrid('options');
            var pager = dg.datagrid('getPager');
            pager.pagination({
                onSelectPage: function (pageNum, pageSize) {
                    opts.pageNumber = pageNum;
                    opts.pageSize = pageSize;
                    pager.pagination('refresh', {
                        pageNumber: pageNum,
                        pageSize: pageSize
                    });
                    dg.datagrid('loadData', data);
                }
            });
            if (!data.originalRows) {
                data.originalRows = (data.rows);
            }
            var start = (opts.pageNumber - 1) * parseInt(opts.pageSize);
            var end = start + parseInt(opts.pageSize);
            data.rows = (data.originalRows.slice(start, end));
            return data;
        }

        function clearZero() {
            var sMachineID = $("#txbMachineID").combobox("getValue");
            var sCheckPersonID = $("#txbCheckPerson").textbox("getValue");
            var theQtyO = $("#hidQtyO").val();
            var theQtyN = (isNaN(Number(theQtyO)) ? 0 : Number(theQtyO));
            isBtnCleared = true;
            /* if ($("#form1").form("validate")) {
                 if (iSelectRecNo > 0) {
                     var iRecNo = iSelectRecNo;
                     var fClearQty = $("#Text5").numberbox("getValue");
                     var sUserID = userid;
                     var jsonobj = {
                         StoreProName: "SpSdOrderDDVatNoClearNo",
                         StoreParms: [{
                             ParmName: "@iSDOrderDDRecNo",
                             Value: iRecNo
                         },
                         {
                             ParmName: "@fClearQty",
                             Value: fClearQty
                         },
                         {
                             ParmName: "@sCheckPersonID",
                             Value: sCheckPersonID
                         },
                         {
                             ParmName: "@sMachineID",
                             Value: sMachineID
                         },
                         {
                             ParmName: "@sUserID",
                             Value: sUserID
                         }
                         ]
                     }
                     var result = SqlStoreProce(jsonobj);
                 }
             }

             */
            //totalQty += theQtyN;
            //$("#txbTodayTotal").numberbox("setValue", totalQty);
            if (MSComm1.PortOpen == false) {
                OpenPort();
            }
            //码表清0
            SendPortMessage("0x54");
            //            var clearZeroConfirm = function () {
            //                var fRecePartQty = $("#Text5").numberbox("getValue");
            //                fRecePartQty = isNaN(Number(fRecePartQty)) ? 0 : Number(fRecePartQty);
            //                fRecePartQty = fRecePartQty.toFixed(1);
            //                if (fRecePartQty >1) {
            //                    SendPortMessage("0x54");
            //                    setTimeout("clearZeroConfirm()", 500);
            //                }
            //            }
            setTimeout("clearZeroConfirm()", 500);
            $("#tabCdRec").datagrid("loadData", []);
            fLastCutQty = 0.00;

            /*var jsonobj = {
                StoreProName: "SpYieldAdd",
                StoreParms: [{
                    ParmName: "@sMachineID",
                    Value: sMachineID
                }, {
                    ParmName: "@sCheckPersonID",
                    Value: sCheckPersonID
                }, {
                    ParmName: "@fQty",
                    Value: theQtyN
                }
                ]
            }
            var result11 = SqlStoreProce(jsonobj);
            if (result11 != "1") {
                alert(result11);
            }
            else {

            }*/
        }
         
        function SelectSamplePrint() {
            if (GetUrlParam("iSendCut") == "1") {
                var sqlObjCut = {
                    TableName: "SDSendD a inner join pbReportData aa on a.iSamplePrintModuleRecNo=aa.iRecNo inner join SDSendM b on a.iMainRecNo=b.iRecNo and b.iStatus>3 and b.iBillType=0 inner join SDOrderD d on a.iSDOrderDRecNo=d.iRecNo inner join SDOrderDD e on e.iMainRecNo=d.iRecNo left join SDOrderDDCutD as f on a.iRecNo=f.iSDSendDRecNo and e.iRecNo=f.iMainRecNo " +
                    " left join BscDataMat as a1 on a.iBscDataMatRecNo=a1.iRecNo left join BscDataColor as b1 on a.iBscDataColorRecNo=b1.iRecNo left join bscDataListD as c1 on b.iCutType=c1.sCode and c1.sClassID='iCutType' ",
                    Fields: "a1.sName,b1.sColorName,a.iRecNo,sSumQty=convert(varchar(10),isnull(a.fSumQty,0)),isnull(iSamplePrintModuleRecNo,0) iSamplePrintModuleRecNo,isnull(iSamplePrintCount,0) iSamplePrintCount,b.iCutType,c1.sName as sCustTypeName,a.iSDOrderDDRecNo,a.iCutSample,e.iSamplePrinted,f.iCut",
                    SelectAll: "True",
                    Filters: [
                        {
                            Field: "b.iStatus",
                            ComOprt: "=",
                            Value: "4",
                            LinkOprt: "and"
                        },
                        //{
                        //    Field: "b.sOutType",
                        //    ComOprt: "=",
                        //    Value: "'车间'",
                        //    LinkOprt: "and"
                        //},
                        {
                            Field: "e.iRecNo",
                            ComOprt: "=",
                            Value: iSelectRecNo
                        }]
                }
                var resultCut = SqlGetData(sqlObjCut);

                $("#divSamplePrintSelect").empty();
                if (resultCut.length == 0) {
                    alert("当前没有需要剪样唛头");
                    return;
                } else {
                    var iNeedCount = 0;
                    for (var i = 0; i < resultCut.length; i++) {
                        var iCutType = resultCut[i].iCutType;
                        if (iCutType == "0") {
                            if (resultCut[i].iSDOrderDDRecNo == iSelectRecNo) {
                                if (resultCut[i].iCutSample == "1")
                                    continue;
                                iNeedCount++;
                                var disabled = resultCut[i].iCutSample == "1" ? "disabled:'disabled'" : "";
                                $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                            }
                        } else if (iCutType == "1") {
                            if (resultCut[i].iCutSample == "1")
                                continue;
                            iNeedCount++;
                            $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                        } else if (iCutType == "2") {
                            if (resultCut[i].iCut == "1")
                                continue;
                            iNeedCount++;
                            $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:420px; height:80px' onclick='SamplePrint(" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sCustTypeName + ":" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                        }
                    }
                    //$("#divSamplePrintSelect").html("");
                    //if (iCutType == "1") {
                    //    for (var i = 0; i < resultCut.length; i++) {
                    //        var disabled = resultCut[i].iCutSample == "1" ? "disabled:'disabled'" : "";
                    //        $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:140px; height:80px' onclick='SamplePrint(" + resultCut[i].sCustTypeName + ":" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                    //    }
                    //} else {
                    //    if (iCutType == "0") {
                    //        resultCut = resultCut.filter(function (p) {
                    //            return p.iSDOrderDDRecNo == iSelectRecNo;
                    //        })
                    //    }
                    //    else {
                    //        resultCut = resultCut.filter(function (p) {
                    //            return p.iSDOrderDDRecNo == iSelectRecNo;
                    //        })
                    //        for (var i = 0; i < resultCut.length; i++) {
                    //            var disabled = resultCut[i].iSamplePrinted == "1" ? "disabled:'disabled'" : "";
                    //            $("#divSamplePrintSelect").append("<button " + disabled + " class='btnBigger1' style='text-align:center;margin: 6px 10px 6px 10px;font-size:16px; width:140px; height:80px' onclick='SamplePrint(" + resultCut[i].sCustTypeName + ":" + resultCut[i].iSamplePrintModuleRecNo + "," + resultCut[i].iSamplePrintCount + "," + resultCut[i].iRecNo + ")'>" + resultCut[i].sName + " " + resultCut[i].sColorName + " " + resultCut[i].sSumQty + "</button>");
                    //        }
                    //    }
                    //}
                    $("#divSamplePrintModule").window("open");
                }
            } else {
                $("#btnSamplePrint").attr("disabled", true);
                var iRecNo = iSelectRecNo;
                //var fPartQty = $("#Text5").numberbox("getValue");
                var fPartQty = fLastPartQty1;
                fPartQty = isNaN(Number(fPartQty)) ? 0 : Number(fPartQty);
                if (fPartQty == 0) {
                    alert("米数不能为0");
                    return;
                }
                var fDeductQty = $("#Text6").numberbox("getValue");
                fDeductQty = fDeductQty == "" || fDeductQty == null || fDeductQty == undefined ? 0 : fDeductQty;
                //var fRealQty = $("#Text7").numberbox("getValue");
                var fRealQty = fLastPartQty1;
                var sCheckPersonID = $("#txbCheckPerson").textbox("getValue");
                var sMachineID = $("#txbMachineID").combobox("getValue");
                var iBscDataProcessMRecNo = $("#txbSerial").combobox("getValue");
                var fWeight = isNaN(Number($("#Text4").numberbox("getValue"))) ? 0 : Number($("#Text4").numberbox("getValue"));
                var sUserID = userid;
                var allRows1 = $("#tabCdRec").datagrid("getRows");
                var iRecNoStr = "";
                for (var i = 0; i < allRows1.length; i++) {
                    iRecNoStr += allRows1[i].iRecNo + ",";
                }
                if (iRecNoStr != "") {
                    iRecNoStr = iRecNoStr.substr(0, iRecNoStr.length - 1);
                }

                var sVatNoD = $("#Text20").textbox("getValue");

                var sPackPersonID = $("#Text212").val();
                if (sPackPersonID == "" || sPackPersonID == null) {
                    sPackPersonID = "";
                }
                if (sPackPersonID == "") {
                    setTimeout(function () {
                        $("#btnSamplePrint").attr("disabled", false);
                    }, 3000)
                    alert("请选择包装工"); 
                    return false;
                }
                var jsonobj = {
                    StoreProName: "SpSdOrderDDVatNoCutSampler",
                    StoreParms: [{
                        ParmName: "@iSDOrderDDRecNo",
                        Value: iRecNo
                    },
                    {
                        ParmName: "@fPartQty",
                        Value: fPartQty
                    },
                    {
                        ParmName: "@fDeductQty",
                        Value: fDeductQty
                    },
                    {
                        ParmName: "@fRealQty",
                        Value: fRealQty
                    },
                    {
                        ParmName: "@sCheckPersonID",
                        Value: sCheckPersonID
                    },
                    {
                        ParmName: "@sMachineID",
                        Value: sMachineID
                    },
                    {
                        ParmName: "@fWeight",
                        Value: fWeight
                    },
                    {
                        ParmName: "@sUserID",
                        Value: sUserID
                    },
                    {
                        ParmName: "@sRecNoStr",
                        Value: iRecNoStr
                    },
                    {
                        ParmName: "@iBscDataProcessMRecNo",
                        Value: iBscDataProcessMRecNo
                    },
                    {
                        ParmName: "@sPackPersonID",
                        Value: sPackPersonID
                    },
                    {
                        ParmName: "@sVatNoD",
                        Value: sVatNoD
                    },
                    {
                        ParmName: "@sBarCodeOld",
                        Value: sReCheckBarCode
                    },
                    {
                        ParmName: "@iSampleRecNo",
                        Value: 0
                    }
                    ]
                }
                var result = SqlStoreProce(jsonobj);
                var resultArr = result.split(":");
                var resultFirst = resultArr[0];
                var resultMessage = resultArr[1];
                if (resultFirst == "1") {
                    $.messager.show({
                        title: '保存成功',
                        msg: '保存成功，正在打印...',
                        showType: null,
                        style: {
                            right: '',
                            top: document.body.scrollTop + document.documentElement.scrollTop,
                            bottom: ''
                        },
                        timeout: 2000
                    });
                    if (MSComm1.PortOpen == false) {
                        OpenPort();
                    }
                    //码表清0
                    //                        SendPortMessage("0x00,0x00,0x00,0x00,0x00,0x00,0x54");
                    isSampleSave = true;
                    SendPortMessage("0x54");


                    setTimeout("clearZeroConfirm()", 500);
                    $("#tabCdRec").datagrid("loadData", []);

                    $("#Text6").textbox("setValue", null);

                    //                        var iCurtReelCount = $("#Text13").numberbox("getValue");
                    //                        iCurtReelCount = isNaN(Number(iCurtReelCount)) ? 0 : Number(iCurtReelCount);
                    //                        iCurtReelCount += 1;
                    //                        $("#Text13").numberbox("setValue", iCurtReelCount);

                    fLastCutQty = 0.00;
                    var theQtyO = $("#hidQtyO").val();
                    var theQtyN = (isNaN(Number(theQtyO)) ? 0 : Number(theQtyO));

                    iLastSDOrderDDVatNoDReelNoRecNo = resultMessage;
                    if (SampleMoudleRecNo > 0) {
                        var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + SampleMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                        $("#ifrpb").attr("src", "");
                        $("#ifrpb").attr("src", url1);
                        for (var i = 1; i < SampleMoudleCount; i++) {
                            if ($("#ifrpbNew" + i.toString()).length == 0) {
                                var frame = document.createElement("iframe");
                                frame.setAttribute("id", "ifrpbNew" + i.toString());
                                frame.setAttribute("name", "ifrpbNew" + i.toString());
                                frame.setAttribute("width", 0);
                                frame.setAttribute("height", 0);
                                document.body.appendChild(frame);
                            }
                            var urlNew = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + SampleMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                            $("#ifrpbNew" + i.toString()).attr("src", "");
                            $("#ifrpbNew" + i.toString()).attr("src", urlNew);
                        }
                    }
                    $("#divSamplePrintModule").window("close");

                    
                }
                else {
                    alert(resultMessage);
                }
            }
        }

        function SamplePrint(SampleMoudleRecNo, SampleMoudleCount, iSampleRecNo) {

            if ($("#form1").form("validate")) {
                if (iSelectRecNo > 0) {
                    //var sqlObjIsSamplePrintedCheck = {
                    //    TableName: "SDOrderDD",
                    //    Fields: "1",
                    //    SelectAll: "True",
                    //    Filters: [{
                    //        Field: "iSamplePrinted",
                    //        ComOprt: "=",
                    //        Value: "1",
                    //        LinkOprt: "and"
                    //    }, {
                    //        Field: "iRecNo",
                    //        ComOprt: "=",
                    //        Value: iSelectRecNo
                    //    }]
                    //}
                    ////var result = SqlGetData(sqlObj);
                    //var isSamplePrintedCheck = SqlGetData(sqlObjIsSamplePrintedCheck);
                    /*if (isSamplePrintedCheck.length > 0) {
                        alert("已经剪样过，不能重复剪样");
                        return false;
                    }*/

                    $("#btnSamplePrint").attr("disabled", true);
                    var iRecNo = iSelectRecNo;
                    //var fPartQty = $("#Text5").numberbox("getValue");
                    var fPartQty = fLastPartQty1;
                    fPartQty = isNaN(Number(fPartQty)) ? 0 : Number(fPartQty);
                    if (fPartQty == 0) {
                        alert("米数不能为0");
                        return;
                    }
                    
                    var sqlObjCut21 = {
                        TableName: "SDSendD",
                        Fields: "isnull(fSumQty,0) fSumQty",
                        SelectAll: "True",
                        Filters: [ 
                            {
                                Field: "iRecNo",
                                ComOprt: "=",
                                Value: iSampleRecNo
                            }]
                    }
                    var resultCut21 = SqlGetData(sqlObjCut21);
                    if (resultCut21.length > 0) {
                        if (Number(resultCut21[0].fSumQty) > fPartQty) {
                            alert("当前米数未达到所选剪样类型米数要求");
                            return;
                        }
                    }

                    var fDeductQty = $("#Text6").numberbox("getValue");
                    fDeductQty = fDeductQty == "" || fDeductQty == null || fDeductQty == undefined ? 0 : fDeductQty;
                    //var fRealQty = $("#Text7").numberbox("getValue");
                    var fRealQty = fLastPartQty1;
                    var sCheckPersonID = $("#txbCheckPerson").textbox("getValue");
                    var sMachineID = $("#txbMachineID").combobox("getValue");
                    var iBscDataProcessMRecNo = $("#txbSerial").combobox("getValue");
                    var fWeight = isNaN(Number($("#Text4").numberbox("getValue"))) ? 0 : Number($("#Text4").numberbox("getValue"));
                    var sUserID = userid;
                    var allRows1 = $("#tabCdRec").datagrid("getRows");
                    var iRecNoStr = "";
                    for (var i = 0; i < allRows1.length; i++) {
                        iRecNoStr += allRows1[i].iRecNo + ",";
                    }
                    if (iRecNoStr != "") {
                        iRecNoStr = iRecNoStr.substr(0, iRecNoStr.length - 1);
                    }

                    var sVatNoD = $("#Text20").textbox("getValue");

                    var sPackPersonID = $("#Text212").val();
                    if (sPackPersonID == "" || sPackPersonID == null) {
                        sPackPersonID = "";
                    }

                    if (sPackPersonID == "") { 
                        var sqlObjCut2 = {
                            TableName: "SDSendD a inner join pbReportData aa on a.iSamplePrintModuleRecNo=aa.iRecNo inner join SDSendM b on a.iMainRecNo=b.iRecNo and b.iStatus>3 and b.iBillType=0 inner join SDOrderD d on a.iSDOrderDRecNo=d.iRecNo inner join SDOrderDD e on e.iMainRecNo=d.iRecNo left join SDOrderDDCutD as f on a.iRecNo=f.iSDSendDRecNo and e.iRecNo=f.iMainRecNo",
                            Fields: "a.iRecNo,sSumQty=convert(varchar(10),isnull(a.fSumQty,0)),isnull(iSamplePrintModuleRecNo,0) iSamplePrintModuleRecNo,isnull(iSamplePrintCount,0) iSamplePrintCount,f.iCut",
                            SelectAll: "True",
                            Filters: [
                                {
                                    Field: "b.iStatus",
                                    ComOprt: "=",
                                    Value: "4",
                                    LinkOprt: "and"
                                },
                                //{
                                //    Field: "b.sOutType",
                                //    ComOprt: "=",
                                //    Value: "'车间'",
                                //    LinkOprt: "and"
                                //},
                                {
                                    Field: "e.iRecNo",
                                    ComOprt: "=",
                                    Value: iSelectRecNo
                                }]
                        }
                        var resultCut2 = SqlGetData(sqlObjCut2);
                        if (resultCut2.length > 0) {
                            $("#cutRemark").html("");
                            setTimeout(function () {
                                $("#btnSamplePrint").attr("disabled", false);
                            }, 3000)
                        }
                        alert("请选择包装工");
                        $("#divSamplePrintModule").window("close");
                        return false;
                    }

                    var jsonobj = {
                        StoreProName: "SpSdOrderDDVatNoCutSampler",
                        StoreParms: [{
                            ParmName: "@iSDOrderDDRecNo",
                            Value: iRecNo
                        },
                        {
                            ParmName: "@fPartQty",
                            Value: fPartQty
                        },
                        {
                            ParmName: "@fDeductQty",
                            Value: fDeductQty
                        },
                        {
                            ParmName: "@fRealQty",
                            Value: fRealQty
                        },
                        {
                            ParmName: "@sCheckPersonID",
                            Value: sCheckPersonID
                        },
                        {
                            ParmName: "@sMachineID",
                            Value: sMachineID
                        },
                        {
                            ParmName: "@fWeight",
                            Value: fWeight
                        },
                        {
                            ParmName: "@sUserID",
                            Value: sUserID
                        },
                        {
                            ParmName: "@sRecNoStr",
                            Value: iRecNoStr
                        },
                        {
                            ParmName: "@iBscDataProcessMRecNo",
                            Value: iBscDataProcessMRecNo
                        },
                        {
                            ParmName: "@sPackPersonID",
                            Value: sPackPersonID
                        },
                        {
                            ParmName: "@sVatNoD",
                            Value: sVatNoD
                        },
                        {
                            ParmName: "@sBarCodeOld",
                            Value: sReCheckBarCode
                        },
                        {
                            ParmName: "@iSampleRecNo",
                            Value: iSampleRecNo
                        }
                        ]
                    }
                    var result = SqlStoreProce(jsonobj);
                    var resultArr = result.split(":");
                    var resultFirst = resultArr[0];
                    var resultMessage = resultArr[1];
                    if (resultFirst == "1") {
                        $.messager.show({
                            title: '保存成功',
                            msg: '保存成功，正在打印...',
                            showType: null,
                            style: {
                                right: '',
                                top: document.body.scrollTop + document.documentElement.scrollTop,
                                bottom: ''
                            },
                            timeout: 2000
                        });
                        if (MSComm1.PortOpen == false) {
                            OpenPort();
                        }
                        //码表清0
                        //                        SendPortMessage("0x00,0x00,0x00,0x00,0x00,0x00,0x54");
                        isSampleSave = true;
                        SendPortMessage("0x54");

                        

                        //                        var clearZeroConfirm = function () {
                        //                            var fRecePartQty = $("#Text5").numberbox("getValue");
                        //                            fRecePartQty = isNaN(Number(fRecePartQty)) ? 0 : Number(fRecePartQty);
                        //                            fRecePartQty = fRecePartQty.toFixed(1);
                        //                            if (fRecePartQty >1) {
                        //                                SendPortMessage("0x54");
                        //                                setTimeout("clearZeroConfirm()", 500);
                        //                            }
                        //                        }
                        setTimeout("clearZeroConfirm()", 500);
                        $("#tabCdRec").datagrid("loadData", []);
                        //var sReelNo = resultArr[2];
                        //                        var theSelectRow;
                        //                        var allRowsOrder = $("#tableSdOrderDD").datagrid("getRows");
                        //                        for (var i = 0; i < allRowsOrder.length; i++) {
                        //                            if (iSelectRecNo == allRowsOrder[i].iRecNo) {
                        //                                theSelectRow = allRowsOrder[i];
                        //                                break;
                        //                            }
                        //                        }
                        //var sReelNoFlag = theSelectRow.sReelNoFlag;

                        //var theReelNo = "";
                        //                        var sReelNoPre = theSelectRow.sReelNoPre == null || theSelectRow.sReelNoPre == undefined ? "" : theSelectRow.sReelNoPre
                        //                        if (sReelNoFlag != "0") {
                        //                            var nextPartReelCount = parseInt(jsright(sReelNo, sReelNoFlag.length)) + 1;
                        //                            sReelNo = sReelNoPre + jsright((parseInt("1" + sReelNoFlag) + nextPartReelCount).toString(), sReelNoFlag.length);
                        //                        }
                        //                        else {
                        //                            var nextPartReelCount = parseInt(sReelNo) + 1;
                        //                            sReelNo = sReelNoPre + nextPartReelCount.toString();
                        //                        }
                        //$("#Text9").textbox("setValue", sReelNo);
                        $("#Text6").textbox("setValue", null);

                        //                        var iCurtReelCount = $("#Text13").numberbox("getValue");
                        //                        iCurtReelCount = isNaN(Number(iCurtReelCount)) ? 0 : Number(iCurtReelCount);
                        //                        iCurtReelCount += 1;
                        //                        $("#Text13").numberbox("setValue", iCurtReelCount);

                        fLastCutQty = 0.00;
                        var theQtyO = $("#hidQtyO").val();
                        var theQtyN = (isNaN(Number(theQtyO)) ? 0 : Number(theQtyO));
                        //totalQty += theQtyN;
                        //$("#txbTodayTotal").numberbox("setValue", totalQty);
                        //                        var fReadyPartQty = isNaN(Number($("#Text12").numberbox("getValue"))) ? 0 : Number($("#Text12").numberbox("getValue"));
                        //                        fReadyPartQty += fRealQty;
                        //                        $("#Text12").numberbox("setValue", fReadyPartQty);
                        //isSampleSave = false;
                        //var jsonobj = {
                        //    StoreProName: "SpYieldAdd",
                        //    StoreParms: [{
                        //        ParmName: "@sMachineID",
                        //        Value: sMachineID
                        //    }, {
                        //        ParmName: "@sCheckPersonID",
                        //        Value: sCheckPersonID
                        //    }, {
                        //        ParmName: "@fQty",
                        //        Value: theQtyN
                        //    }
                        //    ]
                        //}
                        //var result11 = SqlStoreProce(jsonobj);
                        iLastSDOrderDDVatNoDReelNoRecNo = resultMessage;
                        if (SampleMoudleRecNo > 0) {
                            var url1 = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + SampleMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                            $("#ifrpb").attr("src", "");
                            $("#ifrpb").attr("src", url1);
                            for (var i = 1; i < SampleMoudleCount; i++) {
                                if ($("#ifrpbNew" + i.toString()).length == 0) {
                                    var frame = document.createElement("iframe");
                                    frame.setAttribute("id", "ifrpbNew" + i.toString());
                                    frame.setAttribute("name", "ifrpbNew" + i.toString());
                                    frame.setAttribute("width", 0);
                                    frame.setAttribute("height", 0);
                                    document.body.appendChild(frame);
                                }
                                var urlNew = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + SampleMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                                $("#ifrpbNew" + i.toString()).attr("src", "");
                                $("#ifrpbNew" + i.toString()).attr("src", urlNew);
                            }
                        }
                        $("#divSamplePrintModule").window("close");


                        //                        var max = 0;
                        //                        for (var i = 0; i < iPrintCount; i++) {
                        //                            var url = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                        //
                        //
                        //                            var thefr = document.getElementById("ifrpb" + i.toString());
                        //                            if (thefr) {
                        //                                $("#ifrpb" + i.toString()).attr("src", "");
                        //                                $("#ifrpb" + i.toString()).attr("src", url);
                        //                            }
                        //                            else {
                        //                                if (max == 0) {
                        //                                    max = i;
                        //                                }
                        //                                $("#ifrpb" + (i - max).toString()).attr("src", "");
                        //                                $("#ifrpb" + (i - max).toString()).attr("src", url);
                        //                            }
                        //                        }
                        //                        if (iPrintMoudleRecNo2 > 0) {
                        //                            var url = "/Base/PbPage.aspx?otype=print&iformid=20024&irecno=" + iPrintMoudleRecNo2 + "&key=" + iLastSDOrderDDVatNoDReelNoRecNo + "&r=" + Math.random();
                        //                            $("#ifrpb").attr("src", "");
                        //                            $("#ifrpb").attr("src", url);
                        //                        }

                    }
                    else {
                        alert(resultMessage);
                    }
                }
                else {
                    alert("请先选择订单！");
                    return false;
                }
                var sqlObjCut2 = {
                    TableName: "SDSendD a inner join pbReportData aa on a.iSamplePrintModuleRecNo=aa.iRecNo inner join SDSendM b on a.iMainRecNo=b.iRecNo and b.iStatus>3 and b.iBillType=0 inner join SDOrderD d on a.iSDOrderDRecNo=d.iRecNo inner join SDOrderDD e on e.iMainRecNo=d.iRecNo left join SDOrderDDCutD as f on a.iRecNo=f.iSDSendDRecNo and e.iRecNo=f.iMainRecNo ",
                    Fields: "a.iRecNo,sSumQty=convert(varchar(10),isnull(a.fSumQty,0)),isnull(iSamplePrintModuleRecNo,0) iSamplePrintModuleRecNo,isnull(iSamplePrintCount,0) iSamplePrintCount",
                    SelectAll: "True",
                    Filters: [
                        {
                            Field: "b.iStatus",
                            ComOprt: "=",
                            Value: "4",
                            LinkOprt: "and"
                        },
                        //{
                        //    Field: "b.sOutType",
                        //    ComOprt: "=",
                        //    Value: "'车间'",
                        //    LinkOprt: "and"
                        //},
                        {
                            Field: "e.iRecNo",
                            ComOprt: "=",
                            Value: iSelectRecNo
                        }]
                }
                var resultCut2 = SqlGetData(sqlObjCut2);
                if (resultCut2.length > 0) {
                    $("#cutRemark").html("");
                    setTimeout(function () {
                        $("#btnSamplePrint").attr("disabled", false);
                    }, 5000)
                }
            }
        }
    </script>
    <script id="clientEventHandlersJS" language="javascript">
        //重写mscomm控件的唯一事件处理代码
        var orText = "";
        var orText1 = "";
        var totalQty = 0.00;
        var targetTxt = "Text5";
        var fLastCutQty = 0.00;
        var fLastPartQty = 0.00;
        var dLastTime = undefined;
        function MSComm1_OnComm() {
            var len = 0;
            //window.alert("happy");
            if (MSComm1.CommEvent == 1)//如果是发送事件
            {
                //window.alert("发送成功！"); //这句正常，说明发送成功了
            }
            else if (MSComm1.CommEvent == 2)//如果是接收事件
            {
                if (orText.length < 15) {
                    orText += MSComm1.Input;
                }
                else {
                    var arr = [];
                    if (orText.indexOf("M") > -1) {
                        arr = orText.split("M");
                    }
                    else if (orText.indexOf("Y") > -1) {
                        arr = orText.split("Y");
                    }
                    try {
                        var sTheQty = arr[1];
                        var fTheQty = isNaN(Number(sTheQty)) ? 0 : Number(sTheQty);
                        if (fTheQty == 0 && fLastPartQty != 0) {
                            if (isSampleSave == true) {
                                isSampleSave = false;
                            }
                            else {
                                if (Math.abs(fLastPartQty - fTheQty) > ReelNoRange) {
                                    if (dLastTime == undefined) {
                                        //dLastTime = new Date();
                                        if (isBtnCleared) {
                                            isBtnCleared = false;
                                        } else {
                                            saveAndPrint(0);
                                        }
                                    }
                                    else {
                                        dNowTime = new Date();
                                        var c = dNowTime - dLastTime;
                                        if (c > 10000) {
                                            //dLastTime = new Date();
                                            if (isBtnCleared) {
                                                isBtnCleared = false;
                                            } else {
                                                saveAndPrint(0);
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        fLastPartQty = fTheQty;
                        if (targetTxt == "Text5") {
                            var fRealQty = (isNaN(Number(sTheQty)) ? 0 : Number(sTheQty)) - (isNaN(Number(fLastCutQty)) ? 0 : Number(fLastCutQty));
                            $("#" + targetTxt).numberbox("setValue", fRealQty);
                        }
                        else {
                            var fQtyLast = $("#Text5").numberbox("getValue");
                            var fCutQty = (isNaN(Number(sTheQty)) ? 0 : Number(sTheQty)) - (isNaN(Number(fQtyLast)) ? 0 : Number(fQtyLast));
                            $("#" + targetTxt).numberbox("setValue", fCutQty);
                        }
                        $("#hidQtyO").val(sTheQty);
                    }
                    catch (e) {

                    }
                    orText = "";
                }
            }
            return false;
        }

        function MSComm2_OnComm() {
            var len = 0;
            //window.alert("happy");
            if (MSComm2.CommEvent == 1)//如果是发送事件
            {
                //window.alert("发送成功！"); //这句正常，说明发送成功了
            }
            else if (MSComm2.CommEvent == 2)//如果是接收事件
            {
                if (orText1.length < 36) {
                    orText1 += MSComm2.Input;
                }
                else {
                    var arr = orText1.split("+");
                    var valiValue = arr[1];
                    if (valiValue) {
                        var theHigh = valiValue.substr(0, 4);
                        var theLow = valiValue.substr(4, 3);
                        var value = parseFloat(theHigh + "." + theLow);
                        $("#Text4").numberbox("setValue", value);
                    }
                    orText1 = "";
                }
            }
            return false;
        }
    </script>
    <script language="javascript" for="MSComm1" event="OnComm">

  <!--
  // MSComm1控件每遇到OnComm事件就调用MSComm1_OnComm()函数
            MSComm1_OnComm()
   //-->
    </script>
    <script language="javascript" for="MSComm2" event="OnComm">

  <!--
  // MSComm1控件每遇到OnComm事件就调用MSComm1_OnComm()函数
            MSComm2_OnComm()
   //-->
    </script>
    <style type="text/css">
        body {
            font-family: 微软雅黑;
            font-size: 18px;
        }

        .centerTableH {
            border-spacing: 2px;
        }

            .centerTableH tr td {
                font-size: 18px;
                font-weight: bold;
                font-family: 微软雅黑;
            }

        .centerTable {
            border-spacing: 2px;
        }

            .centerTable tr td {
                font-size: 20px;
                font-weight: bold;
                font-family: 微软雅黑;
            }

        .textbox .textbox-text {
            font-size: 16px;
            color: Blue;
            font-weight: bold;
        }

        .txbreadonly {
            background-color: #ffffaa;
            border: none;
            border-bottom: solid 1px #95b8e7; /*height: 40px; border-radius: 5px;*/
        }

        .txbred {
            color: Red;
            border: none;
            border-bottom: solid 1px #95b8e7; /*height: 40px; border-radius: 5px;*/
        }
        /*input[type="button"]
        {
            height: 49px;
            font-size: 18px;
            font-family: 微软雅黑;
            font-weight: bold;
            width: 100px;
        }*/
        .btnBigger {
            height: 40px;
            font-size: 18px;
            font-family: 微软雅黑;
            font-weight: bold;
        }

        .btnBigger1 {
            height: 80px;
            font-size: 18px;
            font-family: 微软雅黑;
            font-weight: bold;
        }

        .btnBiggerFix {
            height: 35px;
            font-size: 12px;
            font-family: 微软雅黑;
            font-weight: bold;
            width: 70px;
        }

        .keyBoardNum {
            width: 98%;
            height: 99%;
            font-size: 18px;
            font-weight: bold;
        }

        .btnMeterAdjust {
            height: 30px;
            width: 35px;
            font-size: 20px;
            font-weight: bold;
            margin: 0px;
            padding: 0px;
        }

        .btnVatNoDAdjust {
            height: 30px;
            width: 35px;
            font-size: 20px;
            font-weight: bold;
            margin: 0px;
            padding: 0px;
        }

        .btnShowPackPersons {
            height: 30px;
            width: 35px;
            font-size: 20px;
            font-weight: bold;
            margin: 0px;
            padding: 0px;
        }

        .btnPositionAdjust {
            height: 30px;
            width: 35px;
            font-size: 20px;
            font-weight: bold;
            margin: 0px;
            padding: 0px;
        }

        .btnDeAdjust {
            height: 30px;
            width: 35px;
            font-size: 20px;
            font-weight: bold;
            margin: 0px;
            padding: 0px;
        }
    </style>
</head>
<body class="easyui-layout" data-options="border:false">
    <div data-options="region:'north',border:false" style="height: 69px; padding-left: 20px;">
        <table style="height:100%">
            <tr>
                <td style="font-size: 14px;" id="sWorkClassSelect">
                    <span>班次：</span>
                </td>
                <td style="padding-left: 10px;font-size: 18px;">
                    订单号
                </td>
                <td>
                    <input id="txbOrderNo" class="easyui-textbox" style="width: 100px; height: 35px;"
                           type="text" />
                </td>
                <td>
                    <input id="Button1" type="button" value="选择" style="height: 35px; width: 70px;
                        font-size: 18px; font-weight: bold;" onclick="openOrderWindow()" />
                </td>
                <td style="width: 65px;color:red;font-size:18px;font-weight:bold" id="cutRemark"></td>
                <td style="font-size: 20px;">
                    总米数
                </td>
                <td>
                    <input id="txbTodayTotal" class="easyui-numberbox" data-options="readonly:true,precision:1"
                           style="width: 80px; height: 35px;" type="text" />
                </td>
                <td>
                    <input id="btnOpenOrClose" type="button" style="width: 60px; height: 30px; font-size: 12px;"
                           value="断开码表" onclick="CloseOrOpenPort()" />
                    <input id="btnSetPort" type="button" style="width: 70px; height: 30px; font-size: 12px;"
                           value="设置端口" onclick="openSetPort();" />
                    <input id="btnPerimeter" type="button" style="width: 80px; height: 30px; font-size: 13px;font-weight: bold;"
                           value="周长" onclick="setPerimeter();" />
                    <input id="btnWindowClose" type="button" style="width: 70px; height: 30px; font-size: 12px;"
                           value="退出" onclick="top.closeTab();" />
                </td>
            </tr>
        </table>
    </div>
    <div data-options="region:'west',title:'标签信息',split:true,collapsible:false" style="width: 550px;">
        <form id="form1">
            <table class="centerTable">
                <tr>
                    <td>
                        产品
                    </td>
                    <td colspan="3">
                        <input id="Text2" type="text" name="sCodeFull" class="easyui-textbox" data-options="readonly:true"
                               style="width: 250px; height: 30px;" />
                        <input id="hidQtyO" type="hidden" />
                    </td>
                    <td>
                        门幅
                    </td>
                    <td>
                        <input id="Text17" type="text" name="fProductWidth" class="easyui-numberbox" data-options="readonly:true"
                               style="width: 90px; height: 30px;" />
                    </td>
                </tr>
                <tr>
                    <td>
                        客户
                    </td>
                    <td colspan="3">
                        <input id="Text3" type="text" name="sCustID" class="easyui-textbox" data-options="readonly:true"
                               style="width: 250px; height: 30px;" />
                    </td>
                    <td>
                        重量
                    </td>
                    <td>
                        <input id="Text4" type="text" name="fPartWeight" class="easyui-numberbox numkeyboard"
                               data-options="precision:1" style="width: 90px; height: 30px;" />
                    </td>
                </tr>
                <tr>
                    <td>
                        米数
                    </td>
                    <td>
                        <input id="Text5" type="text" name="fPartQty" class="easyui-numberbox numkeyboard"
                               data-options="precision:1,required:true,onChange:partQtyChange" style="width: 80px;
                        height: 30px;" />
                        <input id="Button2" type="button" class="btnMeterAdjust" value="+" />
                        <input id="Button3" type="button" class="btnMeterAdjust" value="-" />
                    </td>
                    <td>
                        扣
                    </td>
                    <td>
                        <input id="Text6" type="text" name="fDeductQty" class="easyui-numberbox numkeyboard"
                               data-options="precision:1,onChange:DeductQtyChange" style="width: 60px; height: 30px;" />
                    </td>
                    <td>
                        实际
                    </td>
                    <td>
                        <input id="Text7" type="text" name="fRealQty" class="easyui-numberbox" data-options="precision:1,readonly:true,required:true"
                               style="width: 90px; height: 30px; color: Red;" />
                    </td>
                </tr>
                <tr>
                    <td>
                        颜色
                    </td>
                    <td colspan="2">
                        <input id="Text8" type="text" name="sSerialColorIDName" class="easyui-textbox" data-options="readonly:true"
                               style="width: 150px; height: 30px;" />
                    </td>
                    <td>
                        卷号
                    </td>
                    <td colspan="2">
                        <input id="Text9" type="text" name="sCurtPartReelNo" class="easyui-textbox" data-options="readonly:true"
                               style="width: 140px; height: 30px;" />
                    </td>
                </tr>
                <tr>
                    <td>
                        本厂缸号
                    </td>
                    <td colspan="2">
                        <input id="Text10" type="text" name="sVatNo" class="easyui-textbox" data-options="readonly:true"
                               style="width: 120px; height: 30px;" />
                    </td>
                    <td>
                        染厂缸号
                    </td>
                    <td colspan="2">
                        <input id="Text20" type="text" name="sVatNoD" class="easyui-textbox" data-options="readonly:true"
                               style="width: 140px; height: 30px;" />
                    </td>
                </tr>
                <tr>
                    <td>
                        检验
                    </td>
                    <td colspan="2">
                        <input id="txbCheckPerson" type="text" name="sCheckPersonID" class="easyui-combobox"
                               data-options="valueField:'sCode',textField:'sName',required:true,readonly:true"
                               style="width: 120px; height: 30px;" />
                    </td>
                    <td>
                        包装工
                    </td>
                    <td colspan="2">
                        <input id="Text21" type="text" name="sPackPersonName" class="easyui-textbox" data-options="readonly:true"
                               style="width: 120px; height: 30px;" />
                        <input id="btnShowPackPersons" type="button" class="btnShowPackPersons" value="..." />
                        <input id="Text212" name="sPackPersonID" type="hidden" />
                    </td>
                </tr>
                <tr>

                    <td>
                        花型
                    </td>
                    <td colspan="2">
                        <input id="Text15" type="text" name="sFlowerType" class="easyui-textbox" data-options="readonly:true"
                               style="width: 140px; height: 30px;" />
                    </td>
                    <td>
                        订单号
                    </td>
                    <td colspan="2">
                        <input id="Text14" type="text" name="sOrderNo" class="easyui-textbox" data-options="readonly:true"
                               style="width: 140px; height: 30px;" />
                    </td>
                </tr>
                <tr>
                    <td style="font-size:16px">
                        已切/预分<br />
                        卷数
                    </td>
                    <td colspan="2">
                        <input id="Text11" type="text" name="iCurtPlanPartReelCount" class="easyui-textbox"
                               data-options="readonly:true,precision:0" style="width: 120px; height: 30px;" />
                    </td>
                    <td style="font-size:16px">
                        已切/来料<br />
                        米数
                    </td>
                    <td colspan="2">
                        <input id="Text12" type="text" name="fReadyPartQtyQty" class="easyui-textbox" data-options="readonly:true,precision:1"
                               style="width: 140px; height: 30px;" />
                    </td>
                </tr>

                <tr>
                    <td style="display: none;">
                        打印数量
                    </td>
                    <td style="display: none;">
                        <input id="Text16" type="text" name="printCount" class="easyui-numberbox" style="width: 120px;
                        height: 40px;" />
                        <iframe id="ifrpb" name="ifrpb" width="0" height="0"></iframe>
                        <input id="txbNowDate" type="text" name="dNowDate" class="easyui-datebox" data-options="readonly:true"
                               style="width: 120px; height: 30px;" />
                    </td>
                    <td colspan="6" style="text-align: left;">
                        <table style="width: 100%;">
                            <tr>
                                <td>
                                    <label><input id="btnSaveMs" type="checkbox" value="验货" class="isNeedReCheck" />验货</label>
                                </td>
                                <td rowspan="2">
                                    <input id="Button4" type="button" value="码表清零" class="btnBigger1" onclick="clearZero()" />
                                </td>
                                <td rowspan="2">
                                    <input id="btnFinish" type="button" value="缸号完成" class="btnBigger1" onclick="finishPart()" />
                                </td>
                                <td rowspan="2">
                                    <input id="btnSavePrint" type="button" value="保存打印" class="btnBigger1" onclick="saveAndPrint(0)" />
                                </td>
                                <td rowspan="2">
                                    <input id="btnShowDetailAsk" type="button" value="全部要求" class="btnBigger1" onclick="$('#divAskDetail').window('open');$('#ttAskDetail').tabs('select', 0); " />
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <input id="btnSamplePrint" type="button" value="剪样" class="btnBigger" onclick="SelectSamplePrint()" />
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="6" style="text-align: left;"></td>
                </tr>
            </table>
        </form>
    </div>
    <div data-options="region:'center',border:false">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div data-options="region:'west'" style="width: 215px;">
                <div class="easyui-layout" data-options="fit:true,border:false">
                    <div data-options="region:'north',border:false,minHeight:80,maxHeight:80">
                        <div class="easyui-tabs" data-options="fit:true,border:false">
                            <div title="疵点记录" data-options="border:false">
                                <table>
                                    <tr>
                                        <td>
                                            <input id="btnRClear" type="button" class="btnBigger" onclick="deleteOrAbandonOrClear(3)"
                                                   value="清空" />
                                        </td>
                                        <td>
                                            <input id="btnRDelete" type="button" class="btnBigger" onclick="deleteOrAbandonOrClear(1)"
                                                   value="删除" />
                                        </td>
                                        <td>
                                            <input id="btnRAband" type="button" class="btnBigger" onclick="deleteOrAbandonOrClear(2)"
                                                   value="作废" />
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div data-options="region:'center',border:false,split:true">
                        <table id="tabCdRec"></table>
                    </div>
                    <div data-options="region:'south',border:false,split:true,minHeight:190,maxHeight:190">
                        <textarea id="textProductRemark" readonly="readonly" style="resize:none;height:55px;width:95%;border-style:none" ></textarea>
                        <input id="Text213" name="sProductRemarkID" type="hidden" />
                        <input id="Text214" name="sProductRemarkDefectiveID" type="hidden" />
                        <table class="centerTable" style="width:100%">
                            <tr>
                                <td rowspan="2" style="text-align:center">
                                    <input type='button' id='btnAddRemark' value='备注' class='btnBiggerFix' style="height:115px;width:60px" onclick='showProductRemarkWindow()' />
                                </td>
                                <td>
                                    <input type='button' id='btnDefective' value='次品' class='btnBiggerFix' style="height:55px;width:75px" onclick='endOnDefective(1)' />
                                </td>
                                <td>
                                    <input type='button' id='btnDoRepair' value='回修' class='btnBiggerFix' style="height:55px;width:60px" onclick='endOnDefective(4)' />
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type='button' id='btnRecheck' value='留样' class='btnBiggerFix' style="height:55px;width:75px" onclick='endOnDefective(2)' />
                                </td>
                                <td>
                                    <input type='button' id='btnWholeDefective' value='整卷次品' class='btnBiggerFix' style="height:55px;width:60px" onclick='endOnDefective(3)' />
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div data-options="region:'center',title:'添加疵点',collapsible:false,split:true">
                <table class="centerTable">
                    <tr>
                        <td id="tdBtn1"></td>
                        <td id="tdBtn2"></td>
                    </tr>
                    <tr>
                        <td id="tdBtn3"></td>
                        <td id="tdBtn4"></td>
                    </tr>
                    <tr>
                        <td id="tdBtn5"></td>
                        <td id="tdBtn6"></td>
                    </tr>
                    <tr>
                        <td id="tdBtn7"></td>
                        <td id="tdBtn8"></td>
                    </tr>
                    <tr>
                        <td id="tdBtn9"></td>
                        <td id="tdBtn10"></td>
                    </tr>
                    <tr>
                        <td id="tdBtn11"></td>
                        <td id="tdBtn12"></td>
                    </tr>
                    <tr>
                        <td id="tdBtn13"></td>
                        <td id="tdBtn14"></td>
                    </tr>
                    <tr>
                        <td id="tdBtn15"></td>
                        <td id="tdBtn16"></td>
                    </tr>
                    <tr>
                        <td id="tdBtn17"></td>
                        <td id="tdBtn18"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="display:none">
                            <img id="img" style="width:150px; height:90px;" />
                        </td>
                    </tr>
                </table>
                <table class="centerTable">
                    <tr>
                        <td id="sUserName" style="font-size:13px"></td>
                    </tr>
                    <tr style="display:none">
                        <td id="dSDContractDate" style="font-size:13px"></td>
                    </tr>
                    <tr id="trDis" style="display:none;">
                        <td colspan="2">
                            <span style="font-size:16px; font-weight:bold; color:Red;">允许同缸卷号不连续</span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div data-options="region:'south',split:true,collapsible:false" style="height: 190px;">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div data-options="region:'west',title:'打卷要求',split:false,collapsible:false,border:false" style="width: 33%">
                <textarea id="txaCoilingAsk" name="sCoilingAsk" style="width: 98%; height: 95%; background-color: #FFF;
            font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
            </div>
            <div data-options="region:'center',title:'验货标准',split:false,collapsible:false,border:false" style="width: 33%">
                <textarea id="txaCheckStand" name="sCheckStand" style="width: 98%; height: 95%; background-color: #FFF;
            font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
            </div>
            <div data-options="region:'east',title:'唛头要求',split:false,collapsible:false,border:false" style="width: 33%">
                <textarea id="txaShippingMark" name="sShippingMark" style="width: 98%; height: 95%; background-color: #FFF;
            font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
            </div>
        </div>
    </div>
    <div id="divSdOrderDD" class="easyui-window" title="选择订单" style="width: 100%; height: 100%;"
         data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div data-options="region:'north',border:false" style="height: 50px">
                <table class="centerTable">
                    <tr>
                        <td>
                            订单号
                        </td>
                        <td>
                            <input id="txbSearchOrderNo" type="text" class="easyui-textbox" style="width: 100px;
                                height: 35px;" />
                        </td>
                        <td>
                            本厂缸号
                        </td>
                        <td>
                            <input id="txbSearchVatNo" type="text" class="easyui-textbox" style="width: 80px;
                                height: 35px;" />
                        </td>
                        <td>
                            染厂缸号
                        </td>
                        <td>
                            <input id="txbSearchVatNoDye" type="text" class="easyui-textbox" style="width: 80px;
                                height: 35px;" />
                        </td>
                        <td>
                            序列号
                        </td>
                        <td>
                            <input id="txbSearchColorID" type="text" class="easyui-textbox" style="width: 60px;
                                height: 35px;" />
                        </td>
                        <td>
                            <input id="Button17" type="button" value="查询" onclick="LoadSDOrderDD()" style="width: 60px;
                                height: 35px;" />
                        </td>
                        <td>
                            <input id="Button18" type="button" value="确定选择" onclick="selectSDOrderDD()" style="width: 80px;
                                height: 35px;" />
                        </td>
                        <td>
                            <input id="Button18" type="button" value="退出" onclick="$('#divSdOrderDD').window('close')" style="width: 60px;
                                height: 35px;" />
                        </td>
                    </tr>
                </table>
            </div>
            <div data-options="region:'center',border:false">
                <table id="tableSdOrderDD"></table>
            </div>
        </div>
    </div>
    <div id="divWorkClass" class="easyui-window" title="选择班次" style="width: 530px; height: 130px;"
         data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div id="divWorkClassSelect" data-options="region:'center',border:false">
            </div>
        </div>
    </div>
    <div id="divSamplePrintModule" class="easyui-window" title="剪样选择" style="width: 530px; height: 320px;"
         data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true">
        <div id="divSamplePrintSelect">
        </div>
    </div>
    <div id="divShowPackPersons" class="easyui-window" title="选择包装工" style="width: 630px; height: 580px;"
         data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div id="divShowPackPersonsSelect" style="font-size:24px; height:480px;" data-options="region:'north',border:false">
            </div>
            <div data-options="region:'center',border:false" style="text-align:center; ">
                <button class="btnBiggerFix" style="width:100px;height:50px;font-size:24px;" onclick="selectPackPersons()">确 定</button>
            </div>

        </div>
    </div>
    <div id="divShowProductRemark" class="easyui-window" title="选择备注" style="width: 630px; height: 580px;"
         data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div id="divShowProductRemarkSelect" style="font-size:24px; height:480px;" data-options="region:'north',border:false">
            </div>
            <div data-options="region:'center',border:false" style="text-align:center; ">
                <button class="btnBiggerFix" style="width:100px;height:50px;font-size:24px;" onclick="selectProductRemark()">确 定</button>
            </div>

        </div>
    </div>
    <div id="divShowProductRemarkDefective" class="easyui-window" title="选择次品备注" style="width: 630px; height: 580px;"
         data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true">
        <div class="easyui-layout" data-options="fit:true,border:false">
            <div id="divShowProductRemarkSelectDefective" style="font-size:24px; height:480px;" data-options="region:'north',border:false">
            </div>
            <div data-options="region:'center',border:false" style="text-align:center; ">
                <button class="btnBiggerFix" id="selectProductRemarkDefective" style="width:100px;height:50px;font-size:24px;">确 定</button>
            </div>

        </div>
    </div>
    <div id="divAskDetail" class="easyui-window" title="全部要求" style="width: 80%; height: 90%"
         data-options="modal:true,collapsible:false,minimizable:false,closable:true,maximizable:false,closed:true">
        <div>
            <div id="ttAskDetail" class="easyui-tabs" data-options="tabWidth:80,tabHeight:80,onSelect:function(title,index){if(title=='关闭') { $('#divAskDetail').window('close');}}" style="width: 100%;">
                <div id="divDetailSpecAsk" title="品质要求<br/>及注意事项" style="padding:20px;height:98%">
                    <textarea id="txaDetailSpecAsk" name="sDetailSpecAsk" style="width: 98%; height: 390px; background-color: #fff;
         font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
                </div>
                <div title="打卷要求" style="overflow:auto;padding:20px;">
                    <textarea id="txaDetailCoilingAsk" name="sDetailCoilingAsk" style="width: 98%; height: 390px; background-color: #fff;
         font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
                </div>
                <div title="验货标准" style="overflow:auto;padding:20px;">
                    <textarea id="txaDetailCheckStand" name="sDetailCheckStand" style="width: 98%; height: 390px; background-color: #fff;
         font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
                </div>
                <div title="样布" style="overflow:auto;padding:20px;">
                    <textarea id="txaDetailSampleCloth" name="sDetailSampleCloth" style="width: 98%; height: 390px; background-color: #fff;
         font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
                </div>
                <div title="堆放要求" style="overflow:auto;padding:20px;">
                    <textarea id="txaDetailStackAsk" name="sDetailStackAsk" style="width: 98%; height: 390px; background-color: #fff;
         font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
                </div>
                <div title="唛头" style="overflow:auto;padding:20px;">
                    <textarea id="txaDetailShippingMark" name="sDetailShippingMark" style="width: 98%; height: 390px; background-color: #fff;
         font-size: 24px; font-weight: bold; color: Red;" readonly="readonly"></textarea>
                </div>
                <div title="包装要求" style="overflow:auto;padding:20px;">
                    <table id="tablePackDetail" name="sPackDetail" solid border="1" cellspacing="0" cellpadding="0" style="width: 98%; background-color: #fff;
         font-size: 18px; font-weight: bold; color: Red;" readonly="readonly"></table>
                </div>
                <div title="腰封" style="overflow:auto;padding:20px;">
                    <img id="imgMainImage" name="sMainImage" style="width: 98%; height: 390px; background-color: #fff;" />
                </div>
                <div title="关闭" style="overflow:auto;padding:20px;">
                </div>
            </div>
        </div>
    </div>
    <div id="divFlaw" class="easyui-window" title="疵点登记" style="width: 300px; height: 270px;
        text-align: center;" data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true,onBeforeClose:flawWindowClose">
        <form id="form2" method="get">
            <table class="centerTable" style="text-align: center; margin: auto;">
                <tr>
                    <td>
                        原因
                    </td>
                    <td>
                        <input id="txbFlawReason" class="easyui-textbox" data-options="readonly:true" type="text"
                               style="width: 150px; height: 30px;" />
                        <input id="txbSDOrderDDFlawDRecNo" name="iSDOrderDDFlawDRecNo" type="hidden" />
                    </td>
                </tr>
                <tr>
                    <td>
                        位置
                    </td>
                    <td>
                        <input id="txbFlawPosition" class="easyui-numberbox" data-options="readonly:true,precision:1"
                               type="text" style="width: 80px; height: 30px;" />
                        <input id="Button5" type="button" class="btnPositionAdjust" value="+" />
                        <input id="Button6" type="button" class="btnPositionAdjust" value="-" />
                    </td>
                </tr>
                <tr>
                    <td>
                        扣分
                    </td>
                    <td>
                        <input id="txbFlawScroe" class="easyui-numberbox numkeyboard" data-options="readonly:true,precision:0"
                               type="text" style="width: 150px; height: 30px;" />
                    </td>
                </tr>
                <tr>
                    <td id="tdDe">
                        扣米数
                    </td>
                    <td>
                        <input id="txbFlawDeMeter" class="easyui-numberbox numkeyboard" data-options="required:true,precision:1,onChange:flawDeMeterChange"
                               type="text" style="width: 80px; height: 30px;" value="0.2" />
                        <input id="Button7" type="button" class="btnDeAdjust" value="+" />
                        <input id="Button8" type="button" class="btnDeAdjust" value="-" />
                    </td>
                </tr>
                <tr id="trLink" style="display:none">
                    <td>
                        拼米数
                    </td>
                    <td>
                        <input id="txbLinkMeter" class="easyui-numberbox numkeyboard" data-options="precision:1,onChange:LinkMeterChange"
                               type="text" style="width: 150px; height: 30px;" />
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input id="btnFlawClose" type="button" value="取消" class="btnBigger" onclick="$('#divFlaw').window('close');" />&nbsp;&nbsp;
                        <input id="btnFlawConfirm" type="button" value="确定" class="btnBigger" onclick="flawConfirm()" />
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div id="divCommPort" class="easyui-dialog" style="text-align: center; padding-top: 10px;"
         data-options="top:50,closed:true,closable:true,title:'设置端口号',collapsible:false,minimizable:false,maximizable:false,modal:true,width:250,height:220,buttons:[{iconCls:'icon-save',text:'保存',handler:savePort},{iconCls:'icon-cancel',text:'取消',handler:portCancel}]">
        <table style="margin: auto;">
            <tr>
                <td>
                    码表端口号
                </td>
                <td>
                    <input id="txbCommPort" class="easyui-numberspinner" data-options="precision:0,required:true"
                           style="width: 100px;" type="text" />
                </td>
            </tr>
            <tr>
                <td>
                    称重机端口号
                </td>
                <td>
                    <input id="txbCommPort2" class="easyui-numberspinner" data-options="precision:0,required:true"
                           style="width: 100px;" type="text" />
                </td>
            </tr>
            <tr>
                <td>
                    工序
                </td>
                <td>
                    <input id="txbSerial" class="easyui-combobox" data-options="required:true" style="width: 100px;"
                           type="text" />
                </td>
            </tr>
            <tr>
                <td>
                    机台号
                </td>
                <td>
                    <input id="txbMachineID" class="easyui-combobox" data-options="required:true" style="width: 100px;"
                           type="text" />
                </td>
            </tr>
        </table>
    </div>

    <div id="divSetPerimeter" class="easyui-dialog" style="text-align: center; padding-top: 10px;"
         data-options="top:50,closed:true,closable:true,title:'设置周长',collapsible:false,minimizable:false,maximizable:false,modal:true,width:250,height:130,buttons:[{iconCls:'icon-save',text:'保存',handler:savePerimeter},{iconCls:'icon-cancel',text:'取消',handler:function(){$('#divSetPerimeter').dialog('close');}}]">
        <table style="margin: auto;">
            <tr>
                <td>
                    周长
                </td>
                <td>
                    <input id="txbSetPerimeter" class="easyui-numberspinner" data-options="precision:0,required:true"
                           style="width: 100px;" type="text" />
                </td>
            </tr>
        </table>
    </div>
    <div id="divPb" style="display: none;">
        <iframe id="ifrpb1" name="ifrpb1" width="0" height="0"></iframe>
        <iframe id="ifrpb2" name="ifrpb2" width="0" height="0"></iframe>
        <iframe id="ifrpb3" name="ifrpb3" width="0" height="0"></iframe>
        <iframe id="ifrpb4" name="ifrpb4" width="0" height="0"></iframe>
        <iframe id="ifrpb5" name="ifrpb5" width="0" height="0"></iframe>
        <input id="txbMachine" type="text" name="sMachineID" class="easyui-combobox" data-options="valueField:'sMachineCode',textField:'sMachineCode',required:true"
               style="width: 120px; height: 30px;" />
    </div>
</body>
</html>
